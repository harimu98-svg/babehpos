<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Babeh Barbershop POS</title>
    <!-- Favicon -->
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
    .sidebar { transition: all 0.3s ease; }
    .main-content { transition: all 0.3s ease; }
    .active-tab { background-color: #3b82f6; color: white; }
    .product-card:hover { transform: translateY(-2px); }
    .qris-image { max-width: 200px; margin: 0 auto; }
    .cash-button { transition: all 0.2s ease; }
    .cash-button:hover { transform: scale(1.05); }
    .customer-item:hover { background-color: #eff6ff; }
    .otp-input { letter-spacing: 0.5em; }
        
     /* ============================================= */
    /* NAVIGATION GRADIENT - SAMA PERSIS DESKTOP */
    /* ============================================= */
    .main-navigation {
        /* ‚≠ê GRADASI UNGU SAMA PERSIS DESKTOP */
        background: linear-gradient(to right, #1e3a8a, #7c3aed) !important;
        background-color: #1e3a8a !important; /* Fallback */
        color: white !important;
        border: none !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }


    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .mobile-stack { flex-direction: column; }
        .mobile-full { width: 100%; }
        .mobile-p-2 { padding: 0.5rem; }
        .mobile-text-sm { font-size: 0.875rem; }
        .mobile-text-xs { font-size: 0.75rem; }
        .mobile-grid-1 { grid-template-columns: 1fr; }
        .mobile-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .mobile-hidden { display: none; }
        .mobile-order-1 { order: 1; }
        .mobile-order-2 { order: 2; }
        .mobile-sticky-top { position: sticky; top: 0; z-index: 40; background: white; }
        .mobile-bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e5e7eb; z-index: 50; }
    }
    
    @media (max-width: 480px) {
        .mobile-product-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .mobile-small-text { font-size: 0.7rem; }
        .mobile-p-1 { padding: 0.25rem; }
    }

 @media (max-height: 500px) and (orientation: landscape) {
    
    /* üéØ 1. SIDEBAR BOX MENTOK BAWAH */
    .sidebar {
        height: 100vh !important;
        min-height: 100vh !important;
        display: flex !important;
        flex-direction: column !important;
        background: white !important;
    }
    
    .sidebar > div {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
    }
    
    .sidebar .mb-8 {
        margin-bottom: 1rem !important;
        flex-shrink: 0 !important;
    }
    
    .sidebar nav {
        flex: 1 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: flex-start !important;
        min-height: 0 !important;
    }
    
    .sidebar nav.space-y-2 {
        gap: 0.3rem !important;
        flex: 1 !important;
        overflow-y: auto !important;
    }
    
      
    /* üéØ 4. SIDEBAR LEBAR OPTIMAL */
    .sidebar {
        width: 160px !important;
        min-width: 160px !important;
        max-width: 160px !important;
    }
    
    .main-content {
        width: calc(100% - 160px) !important;
    }
  

    
    /* Tablet optimizations */
    @media (min-width: 769px) and (max-width: 1024px) {
        .tablet-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .tablet-text-lg { font-size: 1rem; }
    }

    /* ============================================= */
    /* TOUCH OPTIMIZATION FOR MOBILE/TABLET */
    /* ============================================= */

    /* Minimum touch target size (44px recommended by WCAG) */
    .touch-target {
        min-height: 44px;
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Product cards touch optimization */
    .product-card {
    /* Existing properties tetap */
    min-height: 120px;
    padding: 12px;
    cursor: pointer;
    
    /* ‚≠ê NEW TOUCH PROPERTIES */
    min-height: 44px;        /* Minimum touch target */
    display: flex;           /* Flex layout untuk centering */
    flex-direction: column;  /* Stack content vertically */
    justify-content: center; /* Center content vertically */
}

.product-card:active {
    transform: scale(0.98);  /* Press effect */
    transition: transform 0.1s ease;
    background-color: #f8fafc; /* Visual feedback saat ditekan */
}

    /* Button touch improvements */
    .cash-button, 
    button:not(.mobile-text-xs) {
        min-height: 44px;
        padding: 12px 16px;
        font-size: 16px;
        -webkit-tap-highlight-color: transparent;
    }

    button:active {
        transform: scale(0.96);
        transition: transform 0.1s ease;
    }

    /* Khusus cash buttons lebih expressive */
    .cash-button:active {
        transform: scale(0.92);
        background-color: #3B82F6 !important;
        color: white;
    }

    /* Form elements touch friendly */
    input, select, textarea {
        font-size: 16px !important; /* Prevent zoom on iOS */
        min-height: 44px;
        padding: 12px;
    }

    /* Navigation touch targets */
    .mobile-bottom-nav button {
        min-height: 60px;
        padding: 8px 4px;
    }

    .mobile-bottom-nav span {
        font-size: 12px;
        margin-top: 4px;
    }

    /* Table row touch improvements */
    .customer-item,
    tr:not(thead tr) {
        min-height: 44px;
        cursor: pointer;
    }

    .customer-item:active,
    tr:active:not(thead tr) {
        background-color: #f0f9ff !important;
    }

    /* Quantity buttons touch optimization */
    button[onclick*="updateQuantity"] {
        min-width: 32px;
        min-height: 32px;
        font-size: 16px;
        font-weight: bold;
    }

    /* Payment method buttons */
    button[onclick*="selectPaymentMethod"] {
        min-height: 80px;
        font-size: 14px;
    }

    /* Modal buttons touch optimization */
    .modal-button {
        min-height: 48px;
        font-size: 16px;
        font-weight: 600;
    }

    /* Swipe gestures for navigation */
    .tab-content {
        overflow-x: hidden;
    }

    /* Prevent text selection on interactive elements */
    .product-card, .customer-item, button {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* Loading state feedback */
    button:disabled {
        opacity: 0.6;
        transform: none !important;
    }

    /* Hover states for devices with hover capability */
    @media (hover: hover) {
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
        }
    } /* ‚úÖ PENUTUP @media (hover: hover) */

    
/* ============================================= */
/* EXIT CONFIRMATION MODAL STYLES */
/* ============================================= */
.exit-confirm-modal {
    animation: fadeIn 0.2s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.exit-toast {
    animation: slideUp 0.2s ease-in-out;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive exit modal */
@media (max-width: 768px) {
    .exit-modal-content {
        margin: 1rem;
        width: auto;
    }
}
   
</style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
<nav class="main-navigation text-white p-4 shadow-lg mobile-sticky-top">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-2 md:space-x-4">
            <img src="assets/logo.png" alt="Babeh Barbershop" class="h-12 w-12 md:h-12 md:w-12 object-contain" onerror="this.style.display='none'">
            <div class="flex flex-col">
    <h1 class="text-xl md:text-3xl font-bold mobile-text-sm leading-tight">Babeh Barbershop</h1>
    <span class="text-sm md:text-base font-medium text-gray-200 leading-tight">POS (Point of Sales)</span>
</div>
            </div>
           <div class="flex items-center space-x-2 md:space-x-4">
    <!-- Foto User -->
    <div id="userPhotoContainer" class="flex items-center space-x-2">
        <div class="w-6 h-6 md:w-10 md:h-10 bg-gray-300 rounded-full flex items-center justify-center overflow-hidden border-2 border-white">
            <img id="userPhoto" src="" alt="User Photo" class="w-full h-full object-cover hidden">
            <span id="userInitial" class="text-gray-600 font-semibold text-sm md:text-base"></span>
        </div>
    </div>
    
    <div class="text-right mobile-hidden">
        <div id="currentUser" class="text-xm md:text-sm font-semibold"></div>
        <div id="userRole" class="text-xm opacity-80"></div>
    </div>
                <button onclick="refreshApp()" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 md:px-4 md:py-2 rounded-lg transition duration-200 flex items-center space-x-1 md:space-x-2 mobile-text-xs">
                    <span>‚Üª</span>
                    <span class="mobile-hidden">Refresh</span>
                </button>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-2 py-1 md:px-4 md:py-2 rounded-lg transition duration-200 mobile-text-xs">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Bottom Navigation -->
    <div class="mobile-bottom-nav md:hidden">
        <div class="flex justify-around p-2">
            <button onclick="showTab('pos')" class="flex flex-col items-center p-2 text-xs mobile-text-xs">
                <span>üìä</span>
                <span>POS</span>
            </button>
            <button onclick="showTab('transactions')" class="flex flex-col items-center p-2 text-xs mobile-text-xs">
                <span>üìã</span>
                <span>Transaksi</span>
            </button>
            <button onclick="showTab('reports')" class="flex flex-col items-center p-2 text-xs mobile-text-xs">
                <span>üìà</span>
                <span>Laporan</span>
            </button>
            <button onclick="showTab('printer')" class="flex flex-col items-center p-2 text-xs mobile-text-xs">
                <span>üñ®Ô∏è</span>
                <span>Printer</span>
            </button>
            <button onclick="showTab('settings')" class="flex flex-col items-center p-2 text-xs mobile-text-xs">
                <span>‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </div>
    </div>

    <div class="flex flex-col md:flex-row h-screen pt-0 md:pt-0 pb-16 md:pb-0">
        <!-- Sidebar - Hidden on mobile, shown as bottom nav -->
        <div class="sidebar bg-white w-full md:w-64 shadow-lg mobile-hidden">
            <div class="p-2 md:p-4">
                <div class="mb-4 md:mb-8 text-center">
                    <div class="w-12 h-12 md:w-20 md:h-20 bg-blue-800 rounded-full mx-auto mb-2 flex items-center justify-center overflow-hidden">
                        <img src="assets/logo.png" alt="Logo" class="h-10 w-10 md:h-16 md:w-16 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                        <span class="text-blue-800 text-lg md:text-2xl font-bold" style="display: none;">BB</span>
                    </div>
                    <h2 class="font-semibold text-gray-800 text-sm md:text-base" id="outletName">Loading...</h2>
                    <p class="text-xs text-gray-600" id="currentDateTime"></p>
                </div>
                
                <nav class="space-y-2">
                    <button onclick="showTab('pos')" id="tab-pos" class="w-full text-left p-2 md:p-3 rounded-lg hover:bg-blue-50 active-tab mobile-text-sm">
                        üìä POS
                    </button>
                    <button onclick="showTab('transactions')" id="tab-transactions" class="w-full text-left p-2 md:p-3 rounded-lg hover:bg-blue-50 mobile-text-sm">
                        üìã Transaksi
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" class="w-full text-left p-2 md:p-3 rounded-lg hover:bg-blue-50 mobile-text-sm">
                        üìà Laporan
                    </button>
                    <button onclick="showTab('printer')" id="tab-printer" class="w-full text-left p-2 md:p-3 rounded-lg hover:bg-blue-50 mobile-text-sm">
                        üñ®Ô∏è Printer
                    </button>
                    <button onclick="showTab('settings')" id="tab-settings" class="w-full text-left p-2 md:p-3 rounded-lg hover:bg-blue-50 mobile-text-sm">
                        ‚öôÔ∏è Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-1 p-2 md:p-2 overflow-auto">
            <!-- POS Tab -->
            <div id="pos-content" class="tab-content">
                <div class="grid mobile-grid-1 md:grid-cols-3 gap-4 md:gap-6">
                    <!-- Product Selection -->
                    <div class="md:col-span-2">
                        <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                            <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">Pilih Produk</h2>
                            
                            <!-- Search and Filter -->
                            <div class="grid mobile-grid-1 md:grid-cols-2 gap-2 md:gap-4 mb-4">
                                <div>
                                    <input type="text" id="productSearch" placeholder="Cari produk..." class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                </div>
                                <div>
                                    <select id="categoryFilter" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                        <option value="">Semua Kategori</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Products Grid -->
                            <div id="productsGrid" class="grid mobile-product-grid md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-4">
                                <div class="col-span-full text-center py-8 text-gray-500">
                                    Memuat produk...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="md:col-span-1">
                        <div class="bg-white rounded-lg shadow-lg p-2 md:p-4 sticky top-6 md:top-0">
                            <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">Order Summary</h2>
                            
                            <!-- Served By and Customer Buttons -->
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                <button onclick="showServedByModal()" class="flex items-center justify-center space-x-1 md:space-x-2 bg-blue-100 hover:bg-blue-200 text-blue-800 py-2 px-2 md:px-3 rounded-lg text-xs md:text-sm transition duration-200">
                                    <span>üë®‚Äçüíº</span>
                                    <span id="servedByButtonText" class="truncate">Served By</span>
                                </button>
                                <button onclick="showCustomerModal()" class="flex items-center justify-center space-x-1 md:space-x-2 bg-green-100 hover:bg-green-200 text-green-800 py-2 px-2 md:px-3 rounded-lg text-xs md:text-sm transition duration-200">
                                    <span>üëë</span>
                                    <span id="customerButtonText" class="truncate">Customer</span>
                                </button>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4 max-h-40 md:max-h-64 overflow-y-auto landscape-max-h-32">
                                <table class="w-full text-xs md:text-sm">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left py-1 md:py-2">Produk</th>
                                            <th class="text-right py-1 md:py-2">Qty</th>
                                            <th class="text-right py-1 md:py-2 mobile-hidden">Harga</th>
                                            <th class="text-right py-1 md:py-2">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orderItems">
                                        <tr>
                                            <td colspan="4" class="text-center py-2 md:py-4 text-gray-500">
                                                Belum ada item
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Discount and Redeem Section -->
                            <div class="border-t pt-2 md:pt-4 space-y-2 md:space-y-3">
                                <!-- Redeem Points -->
                                <div class="flex space-x-2">
                                    <button onclick="showRedeemModal()" class="flex-1 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 py-2 px-2 md:px-3 rounded-lg text-xs md:text-sm transition duration-200">
                                        üí∞ Redeem
                                    </button>
                                    <button onclick="showDiscountModal()" class="flex-1 bg-purple-100 hover:bg-purple-200 text-purple-800 py-2 px-2 md:px-3 rounded-lg text-xs md:text-sm transition duration-200">
                                        üè∑Ô∏è Discount
                                    </button>
                                </div>

                                <!-- Applied Discounts -->
                                <div id="appliedDiscounts" class="hidden">
                                    <div class="flex justify-between text-xs md:text-sm">
                                        <span>Discount:</span>
                                        <span id="discountAmount" class="text-red-600">-Rp 0</span>
                                    </div>
                                </div>

                                <!-- Applied Redeem -->
                                <div id="appliedRedeem" class="hidden">
                                    <div class="flex justify-between text-xs md:text-sm">
                                        <span>Redeem Points:</span>
                                        <span id="redeemAmount" class="text-red-600">-Rp 0</span>
                                    </div>
                                </div>

                                <!-- Total -->
                                <div class="border-t pt-2">
                                    <div class="flex justify-between items-center mb-1 md:mb-2">
                                        <span class="font-semibold text-sm md:text-base">Subtotal:</span>
                                        <span id="subtotal" class="text-sm md:text-base">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between items-center mb-2 md:mb-4">
                                        <span class="font-semibold text-base md:text-lg">Total:</span>
                                        <span id="total" class="text-base md:text-lg font-bold text-blue-600">Rp 0</span>
                                    </div>

                                    <!-- Payment Buttons -->
                                    <div class="space-y-2">
                                        <button onclick="showPaymentMethodModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 md:py-3 rounded-lg font-semibold transition duration-200 text-sm md:text-base">
                                            üí≥ Pilih Pembayaran
                                        </button>
                                        <button onclick="clearOrder()" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 md:py-3 rounded-lg font-semibold transition duration-200 text-sm md:text-base">
                                            üîÑ Reset Order
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions-content" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">Data Transaksi</h2>
                    
                    <div class="grid mobile-grid-1 md:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
    <div>
        <label for="filterDate" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tanggal</label>
        <input type="date" id="filterDate" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
    </div>
    <div>
        <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
            <option value="">Semua Status</option>
            <option value="completed">Selesai</option>
            <option value="pending">Pending</option>
            <option value="cancelled">Dibatalkan</option>
        </select>
    </div>
    <div>
        <label for="searchOrder" class="block text-sm font-medium text-gray-700 mb-1">Cari Order</label>
        <input type="text" id="searchOrder" placeholder="Cari order..." class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
    </div>
    <div class="flex items-end">
        <button onclick="loadTransactions()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
            üîç Filter
        </button>
    </div>
</div>
                    <!-- Transactions Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs md:text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2 md:p-3 text-left">Order No</th>
                                    <th class="p-2 md:p-3 text-left">Tanggal</th>
                                    <th class="p-2 md:p-3 text-left">Customer</th>
                                    <th class="p-2 md:p-3 text-right">Total</th>
                                    <th class="p-2 md:p-3 text-left">Payment</th>
                                    <th class="p-2 md:p-3 text-left">Status</th>
                                    <th class="p-2 md:p-3 text-left">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="7" class="p-4 text-center text-gray-500">
                                        Klik "Filter" untuk memuat transaksi
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-content" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">Laporan</h2>
                    
                    <!-- Report Filters -->
                    <div class="grid mobile-grid-1 md:grid-cols-3 gap-2 md:gap-4 mb-4 md:mb-6">
    <div>
        <label for="reportStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
        <input type="date" id="reportStartDate" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
    </div>
    <div>
        <label for="reportEndDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
        <input type="date" id="reportEndDate" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
    </div>
    <div class="flex items-end">
        <button onclick="generateReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
            üìä Generate Report
        </button>
    </div>
</div>
                    <!-- Report Type Selection -->
                    <div class="mb-4 md:mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Laporan</label>
                        <select id="reportType" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                            <option value="payment">Laporan Pembayaran</option>
                            <option value="commission">Laporan Komisi</option>
                            <option value="membercard">Laporan Membercard</option>
                            <option value="attendance">Laporan Absen</option>
                        </select>
                    </div>

                    <!-- Report Summary -->
                    <div id="reportSummary" class="text-center py-4 md:py-8 text-gray-500">
                        Pilih tanggal dan generate laporan
                    </div>

                    <!-- Report Details -->
                    <div id="reportDetails" class="hidden">
                    </div>
                </div>
            </div>

            <!-- Printer Tab -->
<div id="printer-content" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
        <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">üñ®Ô∏è Printer Settings</h2>
        
        <div class="space-y-4 md:space-y-6">
            <!-- Printer Type Selection -->
            <div class="border-b pb-2 md:pb-4">
                <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Tipe Koneksi Printer</h3>
                <div class="grid grid-cols-3 gap-2 md:gap-4 mb-2 md:mb-4">
                    <button id="btnBridge" onclick="PrinterModule.selectPrinterType('bridge')" class="p-2 md:p-4 border-2 border-blue-500 rounded-lg bg-blue-50 text-blue-700 font-semibold text-xs md:text-base">
                        üì± Android Bridge
                    </button>
                    <button id="btnWebSerial" onclick="PrinterModule.selectPrinterType('webserial')" class="p-2 md:p-4 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 font-semibold text-xs md:text-base">
                        üîå Web Serial
                    </button>
                    <button id="btnBtService" onclick="PrinterModule.selectPrinterType('btservice')" class="p-2 md:p-4 border-2 border-gray-300 rounded-lg bg-gray-100 text-gray-600 font-semibold text-xs md:text-base">
                        üì≤ BT Print Service
                    </button>
                </div>
            </div>

            <!-- Android Bridge Settings -->
            <div id="bridgeSettings" class="border-b pb-2 md:pb-4">
                <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Android Bridge Connection</h3>
                <div class="grid mobile-grid-1 md:grid-cols-2 gap-2 md:gap-4">
                    <input type="text" id="printerServerUrl" placeholder="Server URL" value="http://192.168.1.2:8080" class="p-2 border border-gray-300 rounded-lg mobile-text-sm">
                    <button onclick="PrinterModule.checkStatus()" class="bg-blue-600 hover:bg-blue-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
                        Check Status
                    </button>
                </div>
                <div id="printerStatus" class="mt-2 md:mt-4 p-2 md:p-3 rounded-lg bg-gray-100 text-xs md:text-sm">
                    <p class="text-gray-600">Status: Not checked</p>
                </div>
            </div>

            <!-- Web Serial Settings -->
            <div id="webSerialSettings" class="border-b pb-2 md:pb-4 hidden">
                <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Web Serial Connection</h3>
                <div class="space-y-2 md:space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Baud Rate</label>
                        <select id="baudRate" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                    <button onclick="PrinterModule.connectWebSerial()" class="bg-green-600 hover:bg-green-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
                        Connect Printer
                    </button>
                    <div id="webSerialStatus" class="p-2 md:p-3 rounded-lg bg-gray-100 text-xs md:text-sm">
                        <p class="text-gray-600">Status: Not connected</p>
                    </div>
                </div>
            </div>

            <!-- BT Print Service Settings -->
            <div id="btServiceSettings" class="border-b pb-2 md:pb-4 hidden">
                <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Bluetooth Print Service</h3>
                <div class="space-y-2 md:space-y-4">
                    <div class="p-3 md:p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm md:text-base text-blue-700">
                            üì± Menggunakan aplikasi Bluetooth Print Service<br>
                            <span class="text-xs md:text-sm">Pastikan aplikasi terinstall di perangkat Android</span>
                        </p>
                    </div>
                 
                    <div id="btServiceStatus" class="p-2 md:p-3 rounded-lg bg-gray-100 text-xs md:text-sm">
                        <p class="text-gray-600">Status: Not configured</p>
                    </div>
                </div>
            </div>

            <!-- Test Printer -->
            <div class="border-b pb-2 md:pb-4">
                <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Test Printer</h3>
                <button onclick="PrinterModule.testPrint()" class="bg-green-600 hover:bg-green-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
                    Test Print
                </button>
            </div>

            
                        <!-- Receipt Template -->
                        <div>
                            <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">Receipt Template</h3>
                            <div class="space-y-2 md:space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Shop Name</label>
                                    <input type="text" id="shopName" value="Babeh Barbershop" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Outlet</label>
                                    <input type="text" id="shopOutlet" value="Rempoa" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Shop Address</label>
                                    <input type="text" id="shopAddress" value="Jl. Contoh No. 123" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Footer Message</label>
                                    <input type="text" id="footerMessage" value="Terima kasih atas kunjungan Anda" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                                </div>
                                <div class="flex flex-col md:flex-row md:items-center md:space-x-4 space-y-2 md:space-y-0">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="includeServedBy" class="mr-2" checked>
                                        <label for="includeServedBy" class="text-sm text-gray-700 mobile-text-xs">Tampilkan Dilayani Oleh</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="includeCustomer" class="mr-2" checked>
                                        <label for="includeCustomer" class="text-sm text-gray-700 mobile-text-xs">Tampilkan Customer</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="includePoints" class="mr-2" checked>
                                        <label for="includePoints" class="text-sm text-gray-700 mobile-text-xs">Tampilkan Points</label>
                                    </div>
                                </div>
                                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                                    <button onclick="saveTemplate()" class="bg-blue-600 hover:bg-blue-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
                                        Save Template
                                    </button>
                                    <button onclick="previewReceipt()" class="bg-purple-600 hover:bg-purple-700 text-white px-2 md:px-4 py-2 rounded-lg text-sm md:text-base">
                                        Preview Receipt
                                    </button>
                                </div>
                            </div>
                        </div>
        </div>
    </div>
</div>
         
            <!-- Settings Tab -->
            <div id="settings-content" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-lg p-4 md:p-6">
                    <h2 class="text-lg md:text-xl font-bold mb-4 text-gray-800">Pengaturan</h2>
                    
                    <div class="space-y-4 md:space-y-6">
                        <!-- Outlet Info -->
                        <div class="border-b pb-2 md:pb-4">
                            <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">üè™ Informasi Outlet</h3>
                            <div id="outletInfo" class="text-gray-500">
                                Memuat informasi outlet...
                            </div>
                        </div>

                        <!-- User Info -->
                        <div>
                            <h3 class="text-base md:text-lg font-semibold mb-2 md:mb-3">üë§ Informasi User</h3>
                            <div id="userInfo" class="text-gray-500">
                                Memuat informasi user...
                            </div>
                        </div>

                     <!-- ‚≠ê TAMBAH EXIT BUTTON DI SINI -->
            <div class="border-t pt-4 md:pt-6">
                <h3 class="text-base md:text-lg font-semibold mb-3 md:mb-4 text-red-600">‚ö†Ô∏è Keluar Aplikasi</h3>
                <button onclick="ExitConfirmationHandler.showManualExitConfirm()" 
                        class="w-full bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-lg font-semibold transition duration-200 touch-target flex items-center justify-center space-x-2">
                    <span>üö™</span>
                    <span>Keluar dari Aplikasi</span>
                </button>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    Tombol back Android juga akan menampilkan konfirmasi ini
                </p>
            </div>
        </div>
    </div>
</div>

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
            <div class="animate-spin rounded-full h-8 w-8 md:h-12 md:w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-2 md:mt-3 text-gray-600 text-sm md:text-base">Loading...</p>
        </div>
    </div>

    <!-- Served By Modal -->
    <div id="servedByModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Pilih Barberman</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Served By</label>
                <select id="servedBySelect" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
                    <option value="">Pilih pelayan...</option>
                </select>
            </div>
            <div class="flex space-x-2 md:space-x-4">
                <button onclick="closeServedByModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Batal
                </button>
                <button onclick="saveServedBy()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm md:text-base">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Pilih Customer</h3>
            
            <!-- Search Bar -->
            <div class="mb-4">
                <input type="text" id="customerSearch" placeholder="Cari berdasarkan nama, nomor WA, atau ID member..." 
                       class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm">
            </div>
            
            <div class="mb-4 max-h-40 md:max-h-60 overflow-y-auto landscape-max-h-32">
                <div id="customerList" class="space-y-2">
                    <!-- Customer list akan diisi oleh JavaScript -->
                </div>
            </div>
            
            <div class="flex space-x-2 md:space-x-4">
                <button onclick="selectCustomerUmum()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg text-sm md:text-base">
                    üë§ Umum
                </button>
                <button onclick="closeCustomerModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Batal
                </button>
            </div>
        </div>
    </div>

    <!-- Redeem Points Modal -->
    <div id="redeemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Redeem Points</h3>
            <div class="space-y-2 md:space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Points Tersedia</label>
                    <p id="availablePoints" class="text-base md:text-lg font-bold text-green-600">0 points</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Jumlah Points untuk Redeem</label>
                    <input type="number" id="redeemPoints" placeholder="Masukkan jumlah points" 
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg text-base md:text-lg" 
                           min="0">
                </div>
                <div class="bg-blue-50 p-2 md:p-3 rounded-lg">
                    <p class="text-xs md:text-sm text-blue-700">
                        üí° <strong>Konversi:</strong> 1 points = Rp 2,000
                    </p>
                </div>
                <div id="redeemCalculation" class="hidden">
                    <div class="border-t pt-2 md:pt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm md:text-base">Nilai Redeem:</span>
                            <span id="redeemValue" class="text-lg md:text-xl font-bold text-green-600">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 md:mt-6 flex space-x-2 md:space-x-4">
                <button onclick="closeRedeemModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-200 text-sm md:text-base">
                    Batal
                </button>
                <button onclick="applyRedeem()" id="applyRedeemButton" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed text-sm md:text-base"
                        disabled>
                    Terapkan
                </button>
            </div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Discount</h3>
            <div class="space-y-2 md:space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Jenis Discount</label>
                    <select id="discountType" class="w-full p-2 border border-gray-300 rounded-lg mobile-text-sm" onchange="toggleDiscountInput()">
                        <option value="percent">Persentase (%)</option>
                        <option value="amount">Amount (Rp)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Nilai Discount</label>
                    <input type="number" id="discountValue" placeholder="Masukkan nilai discount" 
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg text-base md:text-lg" 
                           min="0">
                </div>
                <div id="discountCalculation" class="hidden">
                    <div class="border-t pt-2 md:pt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm md:text-base">Nilai Discount:</span>
                            <span id="discountAmountValue" class="text-lg md:text-xl font-bold text-red-600">-Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 md:mt-6 flex space-x-2 md:space-x-4">
                <button onclick="closeDiscountModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-200 text-sm md:text-base">
                    Batal
                </button>
                <button onclick="applyDiscount()" id="applyDiscountButton" 
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed text-sm md:text-base"
                        disabled>
                    Terapkan
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="paymentMethodModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Pilih Metode Pembayaran</h3>
            <div class="grid grid-cols-2 gap-2 md:gap-4 mb-4 md:mb-6">
                <button onclick="selectPaymentMethod('cash')" class="p-3 md:p-4 border-2 border-green-500 rounded-lg bg-green-50 text-green-700 font-semibold text-sm md:text-base touch-target">
                    üíµ Tunai
                </button>
                <button onclick="selectPaymentMethod('qris_dinamis')" class="p-3 md:p-4 border-2 border-blue-500 rounded-lg bg-blue-50 text-blue-700 font-semibold text-sm md:text-base">
                    üì± QRIS
                </button>
                <button onclick="selectPaymentMethod('transfer_bank')" class="p-3 md:p-4 border-2 border-purple-500 rounded-lg bg-purple-50 text-purple-700 font-semibold text-sm md:text-base">
                    üè¶ Transfer
                </button>
                <button onclick="selectPaymentMethod('qris_static')" class="p-3 md:p-4 border-2 border-yellow-500 rounded-lg bg-yellow-50 text-yellow-700 font-semibold text-sm md:text-base">
                    üì≤ QRIS Static
                </button>
            </div>
            <div class="flex space-x-2 md:space-x-4">
                <button onclick="closePaymentMethodModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Batal
                </button>
            </div>
        </div>
    </div>

    <!-- Cash Payment Modal -->
    <div id="cashPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Pembayaran Tunai</h3>
            <div class="space-y-2 md:space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Total Pembayaran</label>
                    <p id="cashTotalAmount" class="text-xl md:text-2xl font-bold text-blue-600">Rp 0</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Uang Diterima</label>
                    <input type="number" id="cashReceived" placeholder="Masukkan jumlah uang" 
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg text-base md:text-lg" 
                           min="0"
                           oninput="calculateCashChange()">
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="addCashAmount(50000)" class="cash-button bg-blue-100 hover:bg-blue-200 p-2 rounded-lg text-xs">50K</button>
                    <button onclick="addCashAmount(100000)" class="cash-button bg-blue-100 hover:bg-blue-200 p-2 rounded-lg text-xs">100K</button>
                    <button onclick="addCashAmount(150000)" class="cash-button bg-blue-100 hover:bg-blue-200 p-2 rounded-lg text-xs">150K</button>
                    <button onclick="addCashAmount(200000)" class="cash-button bg-blue-100 hover:bg-blue-200 p-2 rounded-lg text-xs">200K</button>
                </div>
                <div id="cashChangeSection" class="hidden">
                    <div class="border-t pt-2 md:pt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-sm md:text-base">Uang Kembali:</span>
                            <span id="cashChangeAmount" class="text-lg md:text-xl font-bold">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 md:mt-6 flex space-x-2 md:space-x-4">
                <button onclick="closeCashPaymentModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition duration-200 text-sm md:text-base">
                    Batal
                </button>
                <button onclick="confirmCashPayment()" id="confirmCashButton" 
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed text-sm md:text-base"
                        disabled>
                    Konfirmasi
                </button>
            </div>
        </div>
    </div>

    <!-- Transfer Bank Modal -->
    <div id="transferBankModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Transfer Bank</h3>
            <div class="space-y-2 md:space-y-4">
                <div class="text-center">
                    <p class="text-lg font-semibold mb-4">Total: <span id="transferBankTotal">Rp 0</span></p>
                </div>
                <div class="bg-blue-50 p-3 md:p-4 rounded-lg">
                    <h4 class="font-semibold mb-2">Bank BSI (Bank Syariah Indonesia)</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>No. Rekening:</span>
                            <span class="font-mono font-bold">7182 8282 9012</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Atas Nama:</span>
                            <span class="font-bold">BABEH BARBERSHOP</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Cabang:</span>
                            <span>Jakarta Pusat</span>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 p-2 md:p-3 rounded-lg">
                    <p class="text-xs md:text-sm text-yellow-700">
                        üí° <strong>Penting:</strong> Setelah transfer, konfirmasi pembayaran dengan menunjukkan bukti transfer ke kasir.
                    </p>
                </div>
            </div>
            <div class="mt-4 md:mt-6 flex space-x-2 md:space-x-4">
                <button onclick="closeTransferBankModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Batal
                </button>
                <button onclick="confirmTransferBankPayment()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg text-sm md:text-base">
                    Konfirmasi Pembayaran
                </button>
            </div>
        </div>
    </div>

    <!-- QRIS Static Modal -->
    <div id="qrisStaticModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Pilih QRIS Statis</h3>
            <div class="space-y-2 md:space-y-4">
                <div class="text-center">
                    <p class="text-lg font-semibold mb-4">Total: <span id="qrisStaticTotal">Rp 0</span></p>
                </div>
                <div class="grid grid-cols-1 gap-2 md:gap-4">
                    <button onclick="processQRISStatic('dana')" class="p-3 md:p-4 border-2 border-blue-500 rounded-lg hover:bg-blue-50 transition duration-200 text-sm md:text-base">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold">QRIS Statis DANA</span>
                            <span>üì±</span>
                        </div>
                    </button>
                    <button onclick="processQRISStatic('bsi')" class="p-3 md:p-4 border-2 border-green-500 rounded-lg hover:bg-green-50 transition duration-200 text-sm md:text-base">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold">QRIS Statis BSI</span>
                            <span>üè¶</span>
                        </div>
                    </button>
                </div>
            </div>
            <div class="mt-4 md:mt-6">
                <button onclick="closeQRISStaticModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <!-- QRIS Display Modal -->
    <div id="qrisDisplayModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-lg md:text-xl font-bold mb-2" id="qrisModalTitle">QRIS Payment</h3>
            <p class="text-gray-600 mb-4 text-sm md:text-base">Total: <span id="qrisAmountDisplay">Rp 0</span></p>
            
            <div id="qrisImageContainer" class="mb-4">
                <!-- QRIS image will be inserted here -->
            </div>
            
            <div id="qrisDinamisContent" class="hidden">
                <div class="bg-gray-100 p-3 md:p-4 rounded-lg mb-4">
                    <div class="animate-pulse bg-gray-300 h-32 md:h-48 w-32 md:w-48 mx-auto rounded-lg flex items-center justify-center">
                        <span class="text-gray-600 text-sm">Generating QRIS...</span>
                    </div>
                </div>
                <p class="text-xs md:text-sm text-gray-500 mb-4">QR Code akan muncul dalam beberapa detik</p>
            </div>
            
            <div class="space-y-2">
                <button onclick="simulateQRISPayment()"
                     id="simulateQRISBtn"
                    data-show-for="static" 
                    class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg text-sm md:text-base">
                    Konfirmasi Payment Success
                </button>
                <button onclick="closeQRISDisplayModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Cancel Payment
                </button>
            </div>
        </div>
    </div>

    <!-- OTP Verification Modal -->
    <div id="otpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg md:text-xl font-bold mb-4">Verifikasi OTP</h3>
            
            <div class="space-y-2 md:space-y-4">
                <div class="text-center">
                    <p class="text-xs md:text-sm text-gray-600 mb-2">Masukkan kode OTP yang dikirim ke WhatsApp</p>
                    <p class="font-semibold text-sm md:text-base" id="otpOrderNo">Order: -</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 md:mb-2">Kode OTP (4 digit)</label>
                    <input type="text" id="otpInput" maxlength="4" 
                           class="w-full p-2 md:p-3 border border-gray-300 rounded-lg text-center text-lg md:text-xl font-mono tracking-widest otp-input"
                           placeholder="0000">
                </div>
                
                <div class="text-center">
                    <p class="text-xs text-gray-500" id="otpTimer">OTP berlaku: 5:00</p>
                    <button onclick="resendOTP()" class="text-blue-600 text-xs md:text-sm hover:text-blue-800 mt-1">
                        Kirim ulang OTP
                    </button>
                </div>
            </div>
            
            <div class="mt-4 md:mt-6 flex space-x-2 md:space-x-4">
                <button onclick="closeOTPModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg text-sm md:text-base">
                    Batal
                </button>
                <button onclick="verifyOTP()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg text-sm md:text-base">
                    Verifikasi & Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-4 md:p-8 rounded-lg shadow-xl max-w-md w-full mx-4 text-center">
            <div class="w-12 h-12 md:w-16 md:h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl md:text-2xl font-bold text-green-600 mb-2">Pembayaran Berhasil!</h3>
            <p class="text-gray-600 mb-4 text-sm md:text-base" id="successMessage">Transaksi telah berhasil diproses</p>
            <div class="bg-gray-50 p-3 md:p-4 rounded-lg mb-4">
                <p class="font-mono text-xs md:text-sm" id="successOrderNo">Order: -</p>
                <p class="text-lg md:text-xl font-bold text-green-600" id="successAmount">Rp 0</p>
            </div>
            <button onclick="closeSuccessModal()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 md:py-3 rounded-lg font-semibold text-sm md:text-base">
                Tutup
            </button>
        </div>
    </div>

    <script>
// =============================================
// SINGLE CONFIG LOADER & APP INITIALIZATION
// =============================================
let appConfig = {};
let supabaseClient = null;

async function initializeApp() {
    console.log('üöÄ Starting Babeh POS initialization...');
    
    try {
        // Step 1: Load semua config sekaligus
        await loadAppConfig();
        
        // Step 2: Initialize Supabase
        await initializeSupabase();
        
        // Step 3: Start aplikasi
        startApplication();
        
        console.log('üéâ Babeh POS initialized successfully!');
        
    } catch (error) {
        console.error('‚ùå App initialization failed:', error);
        showNotification('Initialization error: ' + error.message, 'error');
    }
}

// Load semua config dari Netlify Function
async function loadAppConfig() {
    console.log('üìã Loading application configuration...');
    
    try {
        const response = await fetch('/.netlify/functions/get-config');
        
        if (!response.ok) {
            throw new Error(`Failed to load config: HTTP ${response.status}`);
        }
        
        const config = await response.json();
        
        // Validasi config yang required
        if (!config.supabaseUrl || !config.supabaseAnonKey) {
            throw new Error('Missing required Supabase configuration');
        }
        
        appConfig = config;
        window.appConfig = appConfig; // Untuk global access
        
        console.log('‚úÖ App config loaded:', {
            hasSupabase: !!config.supabaseUrl,
            hasWhatsApp: !!config.wahaUrl,
            hasApiKey: !!config.wahaXApiKey
        });
        
        return config;
        
    } catch (error) {
        console.error('‚ùå Config loading failed:', error);
        throw error;
    }
}

// Initialize Supabase client
async function initializeSupabase() {
    console.log('üîß Initializing Supabase...');
    
    // Tunggu Supabase library load
    if (typeof supabase === 'undefined') {
        console.log('‚è≥ Waiting for Supabase library...');
        await new Promise(resolve => setTimeout(resolve, 100));
        return initializeSupabase();
    }
    
    if (!appConfig.supabaseUrl || !appConfig.supabaseAnonKey) {
        throw new Error('Supabase configuration not available');
    }
    
    const { createClient } = supabase;
    supabaseClient = createClient(
        appConfig.supabaseUrl,
        appConfig.supabaseAnonKey,
        {
            auth: {
                persistSession: true,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        }
    );
    
    window.supabase = supabaseClient;
    
    // Test connection
    const { error } = await supabaseClient
        .from('produk')
        .select('id')
        .limit(1);
    
    if (error && error.code !== 'PGRST204') {
        console.warn('‚ö†Ô∏è Supabase connection warning:', error.message);
    } else {
        console.log('‚úÖ Supabase initialized successfully');
    }
}

// Start aplikasi utama
function startApplication() {
    console.log('üöÄ Starting main application...');
    
    try {
        // Initialize POS aplikasi
        window.app = new BabehBarbershopPOS();
        window.app.init();
        
        // Setup event listeners
        setupEventListeners();
        
        console.log('‚úÖ Main application started');
        
    } catch (error) {
        console.error('‚ùå Main app startup failed:', error);
        throw error;
    }
}

// Setup event listeners
function setupEventListeners() {
    console.log('üîß Setting up event listeners...');
    
    const redeemPoints = document.getElementById('redeemPoints');
    const discountValue = document.getElementById('discountValue');
    const discountType = document.getElementById('discountType');
    
    if (redeemPoints) {
        redeemPoints.addEventListener('input', calculateRedeemValue);
    }
    if (discountValue) {
        discountValue.addEventListener('input', calculateDiscountAmount);
    }
    if (discountType) {
        discountType.addEventListener('change', toggleDiscountInput);
    }
}

// Start everything ketika DOM ready
document.addEventListener('DOMContentLoaded', initializeApp);

        // =============================================
        // GLOBAL VARIABLES
        // =============================================
        let currentPrinterType = 'bridge'; // 'bridge' or 'webserial'
        let webSerialPort = null;
        let webSerialWriter = null;

// =============================================
// ENVIRONMENT VALIDATION - YANG BARU
// =============================================
function validateEnvironment() {
    if (!window.supabase || typeof window.supabase.from !== 'function') {
        console.error('‚ùå Supabase client not initialized properly');
        showNotification('Error: Database connection not ready', 'error');
        return false;
    }
    
    console.log('‚úÖ Environment validation passed');
    return true;
}

// =============================================
// ORDER NUMBER GENERATOR - HYBRID SYSTEM
// =============================================
const OrderNumberGenerator = {
    dailyCounter: 0,
    outletPrefix: '',
    isInitialized: false,
    isProcessing: false, // Double-submit prevention

    async initialize(outletName) {
        try {
            if (!outletName || typeof outletName !== 'string') {
                throw new Error('Invalid outlet name: ' + outletName);
            }
            
            this.outletPrefix = (outletName.substring(0, 3) || 'OUT').toUpperCase();
            console.log(`üè™ Outlet prefix: ${this.outletPrefix} from "${outletName}"`);
            
            // Get the last order number from database for today
           const today = this._getTodayString();
const { data, error } = await supabase
    .from('transaksi_detail')
    .select('order_no, order_date, order_time')
    .eq('outlet', outletName)
    .eq('order_date', today)
    .order('order_date', { ascending: false })
    .order('order_time', { ascending: false })
    .limit(1);

if (error) {
    console.log('üîÑ Error getting last order, starting from 0');
    this.dailyCounter = 0;
} else if (data && data.length > 0 && data[0].order_no) {
    const lastSequence = this._extractSequenceFromOrder(data[0].order_no);
    this.dailyCounter = lastSequence !== null ? lastSequence : 0;
    console.log(`üî¢ Last order: ${data[0].order_no} -> counter: ${this.dailyCounter}`);
} else {
    this.dailyCounter = 0;
    console.log('üîÑ No orders today, starting from 0');
}
            this.isInitialized = true;
            console.log(`‚úÖ OrderNumberGenerator initialized: ${this.outletPrefix}, counter: ${this.dailyCounter}`);
            
        } catch (error) {
            console.error('Error initializing order number generator:', error);
            // Fallback initialization
            this.outletPrefix = 'OUT';
            this.dailyCounter = this._generateTimestampFallbackNumber();
            this.isInitialized = true;
        }
    },

    async generate() {
        // Double-submit prevention
        if (this.isProcessing) {
            console.warn('üö´ Order number generation already in progress');
            throw new Error('Order number generation in progress, please wait');
        }

        if (!this.isInitialized) {
            throw new Error('OrderNumberGenerator not initialized. Call initialize() first.');
        }

        this.isProcessing = true;
        
        try {
            let orderNo;
            let attempts = 0;
            const maxAttempts = 2;
            
            while (attempts < maxAttempts) {
                attempts++;
                
                // Try sequential first
                this.dailyCounter++;
                
                // Handle daily overflow (very rare)
                if (this.dailyCounter > 999999) {
                    console.warn('‚ö†Ô∏è Daily counter overflow, switching to timestamp mode');
                    orderNo = this._generateTimestampFallback();
                    break;
                }
                
                orderNo = this._generateSequential(this.dailyCounter);
                
                // Validate uniqueness
                const isUnique = await this._validateOrderNumber(orderNo);
                
                if (isUnique) {
                    console.log(`‚úÖ Generated unique order number: ${orderNo}`);
                    break;
                }
                
                console.warn(`üîÑ Order number ${orderNo} exists, retrying... (attempt ${attempts})`);
                
                if (attempts >= maxAttempts) {
                    // Max attempts reached, use fallback
                    orderNo = this._generateTimestampFallback();
                    console.log(`üîÑ Max retries reached, using fallback: ${orderNo}`);
                }
            }
            
            return orderNo;
            
        } catch (error) {
            console.error('‚ùå Error generating order number:', error);
            // Final fallback
            const fallbackOrder = this._generateTimestampFallback();
            console.log(`üîÑ Using final fallback: ${fallbackOrder}`);
            return fallbackOrder;
        } finally {
            this.isProcessing = false;
        }
    },

    // ‚≠ê NORMAL FORMAT: REM011025000001
    _generateSequential(counter) {
        const now = new Date();
        const dd = now.getDate().toString().padStart(2, '0');
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const yy = now.getFullYear().toString().slice(-2);
        const sequence = counter.toString().padStart(6, '0');
        
        return `${this.outletPrefix}${dd}${mm}${yy}${sequence}`;
    },

    // ‚≠ê FALLBACK FORMAT: REM011025103500
    _generateTimestampFallback() {
        const now = new Date();
        const dd = now.getDate().toString().padStart(2, '0');
        const mm = (now.getMonth() + 1).toString().padStart(2, '0');
        const yy = now.getFullYear().toString().slice(-2);
        const hh = now.getHours().toString().padStart(2, '0');
        const min = now.getMinutes().toString().padStart(2, '0');
        const ss = now.getSeconds().toString().padStart(2, '0');
        
        return `${this.outletPrefix}${dd}${mm}${yy}${hh}${min}${ss}`;
    },

    // ‚≠ê Extract sequence from existing order number
    _extractSequenceFromOrder(orderNo) {
        try {
            // Try to extract from format: REM011025000001
            if (orderNo.length >= 12) {
                const sequencePart = orderNo.slice(-6); // Last 6 digits
                const sequence = parseInt(sequencePart);
                if (!isNaN(sequence) && sequence >= 0) {
                    return sequence;
                }
            }
            return null;
        } catch (error) {
            console.error('Error extracting sequence from order:', error);
            return null;
        }
    },

    // ‚≠ê Generate timestamp number for initialization fallback
    _generateTimestampFallbackNumber() {
        const now = new Date();
        const timestamp = now.getTime();
        return parseInt(timestamp.toString().slice(-6)) || 0;
    },

    // ‚≠ê Validate order number uniqueness
    async _validateOrderNumber(orderNo) {
        try {
            const { data, error } = await supabase
                .from('transaksi_detail')
                .select('order_no')
                .eq('order_no', orderNo)
                .limit(1);

            if (error && error.code === 'PGRST116') {
                return true; // No data found = unique
            }
            
            if (error) {
                console.error('Error validating order number:', error);
                return false; // On error, assume not unique to be safe
            }
            
            return !data; // If data exists, not unique
            
        } catch (error) {
            console.error('Error in order number validation:', error);
            return false; // On exception, assume not unique
        }
    },

    _getTodayString() {
        const now = new Date();
        return now.toISOString().split('T')[0]; // YYYY-MM-DD
    },

    // ‚≠ê Reset function for testing/daily maintenance
    reset() {
        this.dailyCounter = 0;
        this.isInitialized = false;
        this.isProcessing = false;
        console.log('üîÑ OrderNumberGenerator reset');
    }
};

// =============================================
// CACHE SYSTEM - BARU
// =============================================
const CacheSystem = {
    cache: new Map(),
    expiry: {
        products: 2 * 60 * 1000,        // 2 MENIT
        customers: 5 * 60 * 1000,       // 5 MENIT  
        categories: 30 * 60 * 1000,     // 30 MENIT
        servers: 60 * 60 * 1000,        // 60 MENIT
        outlet: 24 * 60 * 60 * 1000,    // 24 JAM
        transactions: 1 * 60 * 1000,    // 1 MENIT
    },

    set(key, data, type = 'default') {
        const expiryTime = this.expiry[type] || 5 * 60 * 1000;
        this.cache.set(key, {
            data,
            timestamp: Date.now(),
            expiry: expiryTime,
            type: type
        });
        console.log(`üíæ Cached: ${key} (${type})`);
    },

    get(key) {
        const item = this.cache.get(key);
        if (!item) {
            console.log(`‚ùå Cache miss: ${key}`);
            return null;
        }
        
        if (Date.now() - item.timestamp > item.expiry) {
            this.cache.delete(key);
            console.log(`üîÑ Cache expired: ${key}`);
            return null;
        }
        
        console.log(`‚úÖ Cache hit: ${key}`);
        return item.data;
    },

    clear(pattern = null) {
        if (pattern) {
            for (let key of this.cache.keys()) {
                if (key.includes(pattern)) {
                    this.cache.delete(key);
                }
            }
            console.log(`üßπ Cleared cache pattern: ${pattern}`);
        } else {
            this.cache.clear();
            console.log('üßπ Cleared all cache');
        }
    },

    clearByType(type) {
        this.clear(type);
    }
};

// =============================================
// TOUCH OPTIMIZATION HELPERS
// =============================================
const TouchOptimizer = {
    init() {
        this._preventDoubleTapZoom();
        this._addTouchFeedback();
        console.log('‚úÖ Touch optimization initialized');
    },

    _preventDoubleTapZoom() {
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    },

    _addTouchFeedback() {
        // Add active states to all buttons
        document.addEventListener('touchstart', function() {
            // Add touch feedback visually
        }, { passive: true });
        
        document.addEventListener('touchend', function() {
            // Remove touch feedback
        }, { passive: true });
    },

    // Better tap handling for product cards
    setupProductTap() {
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('touchstart', function(e) {
                this.style.opacity = '0.8';
            }, { passive: true });
            
            card.addEventListener('touchend', function(e) {
                this.style.opacity = '1';
            }, { passive: true });
        });
    }
};

// =============================================
// DATE UTILS - UTILITY FUNCTIONS UNTUK TANGGAL (FULL VERSION)
// =============================================
const DateUtils = {
    // Convert input date (YYYY-MM-DD) to database format (DD/MM/YYYY)
    inputToDBDate(dateStr) {
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return null;
            
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        } catch (error) {
            console.error('Error in inputToDBDate:', error);
            return null;
        }
    },

    // Parse database date (bisa DD/MM/YYYY atau MM/DD/YYYY) ke Date object
    parseDBDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        
        const cleanStr = dateStr.trim();
        
        // Coba format DD/MM/YYYY
        const parts1 = cleanStr.split('/');
        if (parts1.length === 3) {
            const day = parseInt(parts1[0]);
            const month = parseInt(parts1[1]) - 1;
            const year = parseInt(parts1[2]);
            
            if (day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
        }
        
        // Coba format MM/DD/YYYY sebagai fallback
        const parts2 = cleanStr.split('/');
        if (parts2.length === 3) {
            const month = parseInt(parts2[0]) - 1;
            const day = parseInt(parts2[1]);
            const year = parseInt(parts2[2]);
            
            if (day >= 1 && day <= 31 && month >= 0 && month <= 11) {
                const date = new Date(year, month, day);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            }
        }
        
        console.warn('‚ö†Ô∏è Cannot parse DB date:', dateStr);
        return null;
    },

    // Parse any date format (DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD)
    parseAnyDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        
        const cleanStr = dateStr.trim();
        
        // Coba format YYYY-MM-DD (dari transaksi_order)
        if (cleanStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const date = new Date(cleanStr);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        
        // Coba format dengan T (ISO format)
        if (cleanStr.includes('T')) {
            const date = new Date(cleanStr);
            if (!isNaN(date.getTime())) {
                return date;
            }
        }
        
        // Fallback ke parseDBDate untuk format DD/MM/YYYY dan MM/DD/YYYY
        return this.parseDBDate(cleanStr);
    },

    // Check if date is between start and end (inclusive) - untuk format database
    isDateBetween(dateStr, startDate, endDate) {
        try {
            const date = this.parseDBDate(dateStr);
            if (!date) return false;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Set waktu ke 00:00:00 untuk start dan 23:59:59 untuk end
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            return date >= start && date <= end;
        } catch (error) {
            console.error('Error in isDateBetween:', error);
            return false;
        }
    },

    // Universal date between check - untuk semua format
    isDateInRange(dateStr, startDate, endDate) {
        try {
            const date = this.parseAnyDate(dateStr);
            if (!date) return false;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            return date >= start && date <= end;
        } catch (error) {
            console.error('Error in isDateInRange:', error);
            return false;
        }
    },

    // Format to dd/mmm/yy dari berbagai format input
    formatDisplayDate(dateStr) {
        const date = this.parseAnyDate(dateStr);
        if (!date) {
            console.warn('‚ö†Ô∏è Cannot format date:', dateStr);
            return dateStr;
        }
        
        const day = String(date.getDate()).padStart(2, '0');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear().toString().slice(-2);
        return `${day}/${month}/${year}`;
    },

    // Get Indonesian day name dari berbagai format input
    getHariIndonesia(dateStr) {
        const date = this.parseAnyDate(dateStr);
        if (!date) {
            console.warn('‚ö†Ô∏è Cannot get day for date:', dateStr);
            return 'Invalid Date';
        }
        
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        return days[date.getDay()];
    },

    // Convert date to YYYY-MM-DD format (untuk query)
    toISODate(dateStr) {
        const date = this.parseAnyDate(dateStr);
        if (!date) return null;
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    // Get month name in Indonesian
    getBulanIndonesia(dateStr) {
        const date = this.parseAnyDate(dateStr);
        if (!date) return 'Invalid Date';
        
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        return monthNames[date.getMonth()];
    },

    // Get date range display text
    getDateRangeDisplay(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        const startDay = String(start.getDate()).padStart(2, '0');
        const startMonth = this.getBulanIndonesia(startDate).slice(0, 3);
        const startYear = start.getFullYear();
        
        const endDay = String(end.getDate()).padStart(2, '0');
        const endMonth = this.getBulanIndonesia(endDate).slice(0, 3);
        const endYear = end.getFullYear();
        
        if (startYear === endYear && start.getMonth() === end.getMonth()) {
            return `${startDay}-${endDay} ${endMonth} ${endYear}`;
        } else if (startYear === endYear) {
            return `${startDay} ${startMonth} - ${endDay} ${endMonth} ${endYear}`;
        } else {
            return `${startDay} ${startMonth} ${startYear} - ${endDay} ${endMonth} ${endYear}`;
        }
    },

    // Validate date string
    isValidDate(dateStr) {
        return this.parseAnyDate(dateStr) !== null;
    },

    // Get today's date in YYYY-MM-DD format
    getTodayISO() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    // Get first and last day of month
    getMonthRange(year, month) {
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        
        return {
            firstDay: this.toISODate(firstDay),
            lastDay: this.toISODate(lastDay)
        };
    }
};

console.log('‚úÖ DateUtils loaded with full functionality');
        // =============================================
        // DATABASE UTILITIES - DIPERBAIKI UNTUK POINT SYSTEM
        // =============================================
        const Database = {
           async getCurrentOutlet(outletName) {
    const cacheKey = `outlet_${outletName}`;
    const cached = CacheSystem.get(cacheKey);
    if (cached) {
        return cached;
    }

    try {
        const { data, error } = await supabase
            .from('outlet')
            .select('*')
            .eq('outlet', outletName)
            .limit(1);
        
        if (error) throw error;
        
        CacheSystem.set(cacheKey, data, 'outlet');
        return data;
    } catch (error) {
        console.error('Error getting outlet:', error);
        return null;
    }
},

          async getProducts(outletName, category = null) {
    // ‚úÖ LANGSUNG QUERY - Tidak ada cache check
    try {
        let query = supabase
            .from('produk')
            .select('*')
            .eq('outlet', outletName)
            .eq('status', 'active');

        if (category) {
            query = query.eq('group_produk', category);
        }

        const { data, error } = await query;
        
        if (error) throw error;
        
        const result = data || [];
        // ‚úÖ LANGSUNG RETURN - Tidak simpan cache
        return result;
    } catch (error) {
        console.error('Error getting products:', error);
        return [];
    }
},
          async getProductCategories(outletName) {
    const cacheKey = `categories_${outletName}`;
    const cached = CacheSystem.get(cacheKey);
    if (cached) {
        return cached;
    }

    try {
        const { data, error } = await supabase
            .from('group_produk')
            .select('*')
            .eq('outlet', outletName)
            .eq('status', 'active');
        
        if (error) throw error;
        
        const result = data || [];
        CacheSystem.set(cacheKey, result, 'categories');
        return result;
    } catch (error) {
        console.error('Error getting categories:', error);
        return [];
    }
},

      async getCustomers(outletName, searchTerm = '') {
    try {
        let query = supabase
            .from('membercard')
            .select('*')
            .eq('outlet', outletName)
            .eq('status', 'active');
        
        if (searchTerm.trim()) {
            // MODE SEARCH: Cari yang match
            query = query.or(
                `nama.ilike.%${searchTerm}%,` +
                `nomorWA.ilike.%${searchTerm}%,` +
                `id_member.ilike.%${searchTerm}%`
            ).limit(100); // Batasi 100 hasil
        } else {
            // MODE DEFAULT: 10 terbaru saja
            query = query
                .order('created_at', { ascending: false })
                .limit(10);
        }
        
        const { data, error } = await query;
        if (error) throw error;
        
        return data || [];
        
    } catch (error) {
        console.error('Error getting customers:', error);
        return [];
    }
},
          async getServers(outletName) {
    const cacheKey = `servers_${outletName}`;
    const cached = CacheSystem.get(cacheKey);
    if (cached) {
        return cached;
    }

    try {
        const { data, error } = await supabase
            .from('karyawan')
            .select('id, nama_karyawan, user_login, pos_server, outlet, status')
            .eq('outlet', outletName)
            .eq('pos_server', 'true')
            .eq('status', 'active');

        if (error) throw error;
        
        const result = data || [];
        CacheSystem.set(cacheKey, result, 'servers');
        return result;
    } catch (error) {
        console.error('Error getting servers:', error);
        return [];
    }
},
            // =============================================
            // FUNGSI UPDATE MEMBERCARD - SISTEM POINT BARU
            // =============================================
            async updateCustomerPoints(customerId, pointsEarned, redeemPoints, outletName) {
                try {
                    console.log('üîÑ Updating customer points:', { customerId, pointsEarned, redeemPoints });
                    
                    // First get current customer data
                    const { data: customer, error: fetchError } = await supabase
                        .from('membercard')
                        .select('point_sebelum, point_saat_ini, redeem')
                        .eq('id_member', customerId)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    const pointSebelum = customer.point_saat_ini || 0; // Gunakan point_saat_ini sebagai point_sebelum
                    const currentRedeem = customer.redeem || 0;
                    
                    // PERBAIKAN: Sistem Point Baru
                    // Jika ada redeem, maka pointsEarned = 0
                    const actualPointsEarned = redeemPoints > 0 ? 0 : pointsEarned;
                    
                    // Hitung point_saat_ini sesuai rumus: point_sebelum + point - redeem
                    const pointSaatIni = pointSebelum + actualPointsEarned - redeemPoints;
                    const newRedeem = currentRedeem + redeemPoints;
                    
                    const updateData = { 
                        point_sebelum: pointSebelum,           // Simpan nilai sebelumnya
                        point: actualPointsEarned,             // Point yang didapat di transaksi ini
                        redeem: newRedeem,                     // Total redeem
                        point_saat_ini: pointSaatIni,          // Point saat ini setelah transaksi
                        transaksi_terakhir: DateTimeUtils.getFormattedTransactionInfo(outletName)
                    };
                    
                    console.log('üìä New Points calculation:', {
                        pointSebelum,
                        pointsEarned,
                        actualPointsEarned,
                        redeemPoints,
                        pointSaatIni,
                        newRedeem
                    });
                    
                    const { data, error } = await supabase
                        .from('membercard')
                        .update(updateData)
                        .eq('id_member', customerId);
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Customer points updated successfully:', updateData);
                    
                    return {
                        pointSebelum: pointSebelum,
                        point: actualPointsEarned,
                        redeem: redeemPoints,
                        pointSaatIni: pointSaatIni
                    };
                } catch (error) {
                    console.error('Error updating customer points:', error);
                    throw error;
                }
            },

            // =============================================
            // FUNGSI RESTORE POINT SAAT CANCEL - SISTEM BARU
            // =============================================
            async restoreCustomerPoints(customerId, pointsEarned, redeemPoints) {
                try {
                    console.log('üîÑ Restoring customer points:', { customerId, pointsEarned, redeemPoints });
                    
                    // First get current customer data
                    const { data: customer, error: fetchError } = await supabase
                        .from('membercard')
                        .select('point_sebelum, point, redeem, point_saat_ini')
                        .eq('id_member', customerId)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    const currentPointSebelum = customer.point_sebelum || 0;
                    const currentPoint = customer.point || 0;
                    const currentRedeem = customer.redeem || 0;
                    const currentPointSaatIni = customer.point_saat_ini || 0;
                    
                    // Kembalikan ke nilai sebelum transaksi
                    const restoredPointSebelum = currentPointSebelum;
                    const restoredPoint = currentPoint - pointsEarned;
                    const restoredRedeem = currentRedeem - redeemPoints;
                    const restoredPointSaatIni = currentPointSaatIni - pointsEarned + redeemPoints;
                    
                    const updateData = {
                        point_sebelum: restoredPointSebelum,
                        point: Math.max(restoredPoint, 0),
                        redeem: Math.max(restoredRedeem, 0),
                        point_saat_ini: Math.max(restoredPointSaatIni, 0)
                    };
                    
                    const { data, error } = await supabase
                        .from('membercard')
                        .update(updateData)
                        .eq('id_member', customerId);
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Customer points restored successfully:', updateData);
                    return data;
                } catch (error) {
                    console.error('Error restoring customer points:', error);
                    throw error;
                }
            },

            // =============================================
            // FUNGSI SAVE TRANSAKSI DETAIL - DIPERBAIKI
            // =============================================
            async saveTransaction(transactionData) {
                try {
                    console.log('üíæ Saving transaction items:', transactionData);
                    
                    // Hapus kolom discount_percent, discount_amount, redeem_qty dari transaksi_detail
                    const cleanedTransactionData = transactionData.map(item => {
                        const { inventory, product_id, discount_percent, discount_amount, redeem_qty, ...cleanedItem } = item;
                        return cleanedItem;
                    });
                    
                    const { data, error } = await supabase
                        .from('transaksi_detail')
                        .insert(cleanedTransactionData)
                        .select();
                    
                    if (error) {
                        console.error('Supabase error:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }
                    
                    console.log('‚úÖ Transaction items saved successfully:', data);
                    return data;
                } catch (error) {
                    console.error('Error saving transaction:', error);
                    throw error;
                }
            },

            // =============================================
            // FUNGSI SAVE TRANSAKSI ORDER - BARU
            // =============================================
            async saveTransactionOrder(orderData) {
                try {
                    console.log('üíæ Saving transaction order:', orderData);
                    
                    const { data, error } = await supabase
                        .from('transaksi_order')
                        .insert(orderData)
                        .select();
                    
                    if (error) {
                        console.error('Supabase error:', error);
                        throw new Error(`Database error: ${error.message}`);
                    }
                    
                    console.log('‚úÖ Transaction order saved successfully:', data);
                    return data;
                } catch (error) {
                    console.error('Error saving transaction order:', error);
                    throw error;
                }
            },

            async updateProductStock(productId, quantityReduced) {
                try {
                    // First get current stock
                    const { data: product, error: fetchError } = await supabase
                        .from('produk')
                        .select('stok, inventory')
                        .eq('id', productId)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    if (product.inventory && product.stok !== null) {
                        const newStock = product.stok - quantityReduced;
                        
                        const { data, error } = await supabase
                            .from('produk')
                            .update({ stok: newStock })
                            .eq('id', productId);
                        
                        if (error) throw error;
                        return data;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error updating product stock:', error);
                    throw error;
                }
            },

            async restoreProductStock(productId, quantityRestored) {
                try {
                    // First get current stock
                    const { data: product, error: fetchError } = await supabase
                        .from('produk')
                        .select('stok, inventory')
                        .eq('id', productId)
                        .single();
                    
                    if (fetchError) throw fetchError;
                    
                    if (product.inventory && product.stok !== null) {
                        const newStock = product.stok + quantityRestored;
                        
                        const { data, error } = await supabase
                            .from('produk')
                            .update({ stok: newStock })
                            .eq('id', productId);
                        
                        if (error) throw error;
                        return data;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error restoring product stock:', error);
                    throw error;
                }
            },

            async cancelTransaction(orderNo) {
                try {
                    console.log('üîÑ Cancelling transaction:', orderNo);
                    
                    // Update status to cancelled in both tables
                    const { data: detailData, error: detailError } = await supabase
                        .from('transaksi_detail')
                        .update({ status: 'cancelled' })
                        .eq('order_no', orderNo);
                    
                    if (detailError) throw detailError;
                    
                    const { data: orderData, error: orderError } = await supabase
                        .from('transaksi_order')
                        .update({ status: 'cancelled' })
                        .eq('order_no', orderNo);
                    
                    if (orderError) throw orderError;
                    
                    console.log('‚úÖ Transaction cancelled successfully');
                    return { detailData, orderData };
                } catch (error) {
                    console.error('Error cancelling transaction:', error);
                    throw error;
                }
            },

            
          async getTransactions(outletName, filters = {}) {
    const cacheKey = `transactions_${outletName}_${JSON.stringify(filters)}`;
    const cached = CacheSystem.get(cacheKey);
    if (cached) {
        return cached;
    }

    try {
        console.log('üîÑ Loading transactions from transaksi_detail...');
        
        let query = supabase
            .from('transaksi_detail')
            .select('*')
            .eq('outlet', outletName)
            .order('order_date', { ascending: false })
            .order('order_time', { ascending: false });

        if (filters.date) query = query.eq('order_date', filters.date);
        if (filters.status) query = query.eq('status', filters.status);
        if (filters.search) query = query.or(`order_no.ilike.%${filters.search}%,customer_name.ilike.%${filters.search}%`);

        const { data, error } = await query;
        
        if (error) throw error;
        
        console.log(`‚úÖ Found ${data?.length || 0} transactions in transaksi_detail`);
        
        const enhancedData = await this.enhanceWithOrderTotal(data || [], outletName);
        const groupedTransactions = this.groupTransactionsByOrder(enhancedData);
        
        CacheSystem.set(cacheKey, groupedTransactions, 'transactions');
        return groupedTransactions;
        
    } catch (error) {
        console.error('Error getting transactions:', error);
        return [];
    }
},

// ‚úÖ FUNGSI: Ambil TOTAL dari transaksi_order
async enhanceWithOrderTotal(transactions, outletName) {
    try {
        if (transactions.length === 0) return transactions;

        // Ambil order_no unik
        const orderNos = [...new Set(transactions.map(t => t.order_no))];
        console.log('üìã Unique order numbers:', orderNos);
        
        // Ambil TOTAL dari transaksi_order
        const { data: orderData, error } = await supabase
            .from('transaksi_order')
            .select('order_no, total_amount, discount_amount, redeem_amount')
            .in('order_no', orderNos)
            .eq('outlet', outletName);
        
        if (error) throw error;
        
        console.log('üí∞ Order data from transaksi_order:', orderData);
        
        // Buat mapping order_no -> total_amount
        const orderMap = {};
        orderData.forEach(order => {
            orderMap[order.order_no] = {
                total: order.total_amount,
                discount: order.discount_amount,
                redeem: order.redeem_amount
            };
        });
        
        console.log('üó∫Ô∏è Order mapping:', orderMap);
        
        // Tambahkan total yang benar ke setiap transaction
        return transactions.map(transaction => {
            const orderInfo = orderMap[transaction.order_no];
            return {
                ...transaction,
                // ‚≠ê TOTAL YANG BENAR dari transaksi_order (jika ada)
                correct_total: orderInfo?.total || null,
                discount_amount: orderInfo?.discount || 0,
                redeem_amount: orderInfo?.redeem || 0
            };
        });
        
    } catch (error) {
        console.error('Error enhancing with order total:', error);
        return transactions;
    }
},
           groupTransactionsByOrder(transactions) {
    const grouped = {};
    
    transactions.forEach(transaction => {
        if (!grouped[transaction.order_no]) {
            grouped[transaction.order_no] = {
                order_no: transaction.order_no,
                order_date: transaction.order_date,
                order_time: transaction.order_time,
                customer_name: transaction.customer_name,
                payment_type: transaction.payment_type,
                status: transaction.status,
                serve_by: transaction.serve_by,
                kasir: transaction.kasir,
                items: [],
                total_amount: 0, // Subtotal dari items
                correct_total: transaction.correct_total || null, // ‚≠ê TOTAL YANG BENAR
                discount_amount: transaction.discount_amount || 0,
                redeem_amount: transaction.redeem_amount || 0
            };
        }
        
        grouped[transaction.order_no].items.push(transaction);
        grouped[transaction.order_no].total_amount += transaction.amount || 0;
        
        // ‚≠ê JIKA ADA correct_total, GUNAKAN ITU
        if (transaction.correct_total !== null) {
            grouped[transaction.order_no].correct_total = transaction.correct_total;
        }
        
        // ‚≠ê UPDATE discount/redeem jika ada
        if (transaction.discount_amount) {
            grouped[transaction.order_no].discount_amount = transaction.discount_amount;
        }
        if (transaction.redeem_amount) {
            grouped[transaction.order_no].redeem_amount = transaction.redeem_amount;
        }
    });
    
    // ‚≠ê HITUNG FINAL TOTAL untuk yang tidak ada di transaksi_order
    Object.values(grouped).forEach(group => {
        if (group.correct_total === null) {
            // Fallback: hitung manual
            group.correct_total = Math.max(
                group.total_amount - group.discount_amount - group.redeem_amount, 
                0
            );
        }
        
        console.log(`üìä Order ${group.order_no}:`, {
            subtotal: group.total_amount,
            discount: group.discount_amount,
            redeem: group.redeem_amount,
            final_total: group.correct_total
        });
    });
    
    return Object.values(grouped);
},
    
            async getTransactionItems(orderNo) {
                try {
                    const { data, error } = await supabase
                        .from('transaksi_detail')
                        .select('*')
                        .eq('order_no', orderNo);
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error getting transaction items:', error);
                    return [];
                }
            },

            async getTransactionOrder(orderNo) {
                try {
                    const { data, error } = await supabase
                        .from('transaksi_order')
                        .select('*')
                        .eq('order_no', orderNo)
                        .limit(1);
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error getting transaction order:', error);
                    return null;
                }
            },

            // =============================================
            // FUNGSI LAPORAN BARU
            // =============================================
         async getPaymentReport(outletName, startDate, endDate) {
    try {
        console.log('üîç Payment report params:', { outletName, startDate, endDate });

        // Get ALL transaction data first
        const { data: allTransactions, error } = await supabase
            .from('transaksi_order')
            .select('*')
            .eq('outlet', outletName);

        if (error) throw error;

        console.log('üí∞ All transactions:', allTransactions?.length || 0);

        // Filter menggunakan universal date check
        const transactions = allTransactions?.filter(transaction => 
            transaction.order_date && 
            DateUtils.isDateInRange(transaction.order_date, startDate, endDate)
        ) || [];

        console.log('üí∞ Filtered transactions:', transactions.length);

        // Group by payment type and date
        const report = {};
        transactions.forEach(transaction => {
            const paymentType = transaction.payment_type;
            const orderDate = transaction.order_date;
            
            // Untuk transaksi, format langsung dari YYYY-MM-DD
            const dateObj = new Date(orderDate);
            const day = String(dateObj.getDate()).padStart(2, '0');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const month = monthNames[dateObj.getMonth()];
            const year = dateObj.getFullYear().toString().slice(-2);
            const tanggalFormatted = `${day}/${month}/${year}`;
            const hari = DateUtils.getHariIndonesia(orderDate); // Tetap pakai DateUtils untuk hari
            
            const key = `${paymentType}_${orderDate}`;
            
            if (!report[key]) {
                report[key] = {
                    outlet: outletName,
                    tanggal: tanggalFormatted,
                    hari: hari,
                    payment_type: paymentType,
                    total_amount_cancel: 0,
                    total_amount: 0
                };
            }

            if (transaction.status === 'cancelled') {
                report[key].total_amount_cancel += transaction.total_amount || 0;
            } else {
                report[key].total_amount += transaction.total_amount || 0;
            }
        });

        console.log('üí∞ Payment report groups:', Object.values(report).length);
        return Object.values(report);
    } catch (error) {
        console.error('Error getting payment report:', error);
        return [];
    }
},
async getCommissionReport(outletName, startDate, endDate) {
    try {
        console.log('üîç Commission report params:', { outletName, startDate, endDate });

        // Get ALL transaction data first
        const { data: allTransactions, error } = await supabase
            .from('transaksi_order')
            .select('*')
            .eq('outlet', outletName)
            .eq('status', 'completed');

        if (error) {
            console.error('‚ùå Error fetching transactions:', error);
            throw error;
        }

        console.log('üíµ All completed transactions:', allTransactions?.length || 0);

        // Filter menggunakan universal date check
        const transactions = allTransactions?.filter(transaction => {
            if (!transaction.order_date) {
                console.log('‚ö†Ô∏è Transaction without order_date:', transaction);
                return false;
            }
            
            const isInRange = DateUtils.isDateInRange(transaction.order_date, startDate, endDate);
            if (!isInRange) return false;
            
            // Pastikan ada data served_by dan komisi
            if (!transaction.serve_by) {
                console.log('‚ö†Ô∏è Transaction without serve_by:', transaction);
                return false;
            }
            
            return true;
        }) || [];

        console.log('üíµ Filtered transactions:', transactions.length);

        if (transactions.length === 0) {
            console.log('üí° No commission data found for the specified period');
            return [];
        }

        // Debug: lihat sample data
        console.log('üìä Sample commission data:');
        transactions.slice(0, 3).forEach((t, i) => {
            console.log(`  ${i + 1}. ${t.order_date} | ${t.serve_by} | Rp ${t.total_amount} | Komisi: Rp ${t.comission || 0}`);
        });

        // Group by served_by and date
        const report = {};
        transactions.forEach(transaction => {
            const servedBy = transaction.serve_by;
            const orderDate = transaction.order_date;
            
            // Format tanggal untuk display
            const tanggalFormatted = DateUtils.formatDisplayDate(orderDate);
            const hari = DateUtils.getHariIndonesia(orderDate);
            
            const key = `${servedBy}_${orderDate}`;
            
            if (!report[key]) {
                report[key] = {
                    outlet: outletName,
                    tanggal: tanggalFormatted,
                    hari: hari,
                    served_by: servedBy,
                    total_amount: 0,
                    total_komisi: 0,
                    jumlah_transaksi: 0
                };
            }

            report[key].total_amount += Number(transaction.total_amount) || 0;
            report[key].total_komisi += Number(transaction.comission) || 0;
            report[key].jumlah_transaksi += 1;
        });

        // Convert object to array dan sort by tanggal
        const reportArray = Object.values(report).sort((a, b) => {
            const dateA = DateUtils.parseAnyDate(a.tanggal);
            const dateB = DateUtils.parseAnyDate(b.tanggal);
            return dateA - dateB;
        });

        console.log('üíµ Commission report groups:', reportArray.length);
        
        // Summary
        const totalKomisi = reportArray.reduce((sum, item) => sum + item.total_komisi, 0);
        const totalAmount = reportArray.reduce((sum, item) => sum + item.total_amount, 0);
        console.log('üí∞ Summary - Total Amount: Rp', totalAmount, '| Total Komisi: Rp', totalKomisi);

        return reportArray;
    } catch (error) {
        console.error('‚ùå Error getting commission report:', error);
        return [];
    }
},
        async getMembercardReport(outletName, startDate, endDate) {
    try {
        console.log('üîç Membercard report params:', { outletName, startDate, endDate });

        // Get ALL membercard data first
        const { data: allMembercards, error } = await supabase
            .from('membercard')
            .select('*')
            .eq('outlet', outletName);

        if (error) throw error;

        console.log('üìä All membercard data:', allMembercards?.length || 0);

        // Filter menggunakan DateUtils
        const membercards = allMembercards?.filter(membercard => 
            membercard.tanggal_create && 
            DateUtils.isDateBetween(membercard.tanggal_create, startDate, endDate)
        ) || [];

        console.log('üìä Filtered membercard data:', membercards.length);

        // Debug: lihat sample dates
        if (membercards.length > 0) {
            console.log('üìÖ Sample membercard dates:');
            membercards.slice(0, 5).forEach(mc => {
                console.log(`  - ${mc.tanggal_create} -> ${DateUtils.formatDisplayDate(mc.tanggal_create)}`);
            });
        }

        // Group by kasir_create and tanggal_create
        const report = {};
        membercards.forEach(membercard => {
            const kasir = membercard.kasir_create;
            const tanggalCreate = membercard.tanggal_create;
            
            const key = `${kasir}_${tanggalCreate}`;
            
            if (!report[key]) {
                report[key] = {
                    outlet: outletName,
                    tanggal: DateUtils.formatDisplayDate(tanggalCreate),
                    hari: DateUtils.getHariIndonesia(tanggalCreate),
                    kasir: kasir,
                    jumlah_membercard: 0
                };
            }

            report[key].jumlah_membercard += 1;
        });

        return Object.values(report);
    } catch (error) {
        console.error('Error getting membercard report:', error);
        return [];
    }
},

async getAttendanceReport(outletName, startDate, endDate) {
    try {
        console.log('üîç Parameters:', { outletName, startDate, endDate });

        // First get karyawan data with jadwal
        const { data: karyawan, error: karyawanError } = await supabase
            .from('karyawan')
            .select('*')
            .eq('outlet', outletName)
            .eq('status', 'active');

        if (karyawanError) {
            console.error('‚ùå Error fetching karyawan:', karyawanError);
            throw karyawanError;
        }

        // Get ALL attendance data first, then filter manually
        const { data: allAbsensi, error: absensiError } = await supabase
            .from('absen')
            .select('*')
            .eq('outlet', outletName)
            .order('tanggal', { ascending: true });

        if (absensiError) {
            console.error('‚ùå Error fetching absensi:', absensiError);
            return [];
        }

        console.log('üìÖ All absensi data:', allAbsensi?.length || 0);

        // Filter manually based on date range using DateUtils
        const absensi = allAbsensi?.filter(absen => 
            DateUtils.isDateBetween(absen.tanggal, startDate, endDate)
        ) || [];

        console.log('üìÖ Filtered absensi data:', absensi.length);
        console.log('üìÖ Date range:', startDate, 'to', endDate);

        if (absensi.length === 0) {
            console.warn('‚ö†Ô∏è No attendance data found for the specified period');
            return [];
        }

        const report = [];
        
        console.log('üîÑ Processing attendance data...');
        
        absensi.forEach((absen, index) => {
            console.log(`\n--- Processing absen ${index + 1} ---`);
            console.log('Tanggal:', absen.tanggal, '->', DateUtils.formatDisplayDate(absen.tanggal));
            console.log('Karyawan:', absen.nama);
            
            const karyawanData = karyawan.find(k => 
                k.nama_karyawan.trim().toLowerCase() === absen.nama.trim().toLowerCase()
            );
            
            let status = 'Unknown';

            if (karyawanData) {
                if (karyawanData.jadwal_masuk && karyawanData.jadwal_pulang) {
                    try {
                        const dateObj = DateUtils.parseDBDate(absen.tanggal);
                        if (!dateObj) {
                            status = 'Invalid Date';
                        } else {
                            const formattedDate = dateObj.toISOString().split('T')[0];
                            const clockIn = new Date(`${formattedDate}T${absen.clockin}`);
                            const clockOut = absen.clockout ? new Date(`${formattedDate}T${absen.clockout}`) : null;
                            
                            const jadwalMasuk = new Date(`${formattedDate}T${karyawanData.jadwal_masuk}`);
                            const jadwalPulang = new Date(`${formattedDate}T${karyawanData.jadwal_pulang}`);

                            // Check if clock in is on time (within tolerance)
                            const lateThreshold = 15 * 60 * 1000; // 15 minutes
                            const isOnTime = (clockIn - jadwalMasuk) <= lateThreshold;
                            
                            // Check if clock out is complete (with tolerance)
                            const earlyLeaveThreshold = 30 * 60 * 1000; // 30 minutes
                            const isComplete = clockOut && 
                                ((jadwalPulang - clockOut) <= earlyLeaveThreshold);

                            if (isOnTime && isComplete) {
                                status = 'Sesuai Jadwal';
                            } else if (!clockOut) {
                                status = 'Belum Clock Out';
                            } else if (!isOnTime) {
                                status = 'Terlambat';
                            } else if (!isComplete) {
                                status = 'Pulang Lebih Awal';
                            } else {
                                status = 'Tidak Sesuai Jadwal';
                            }
                        }
                    } catch (dateError) {
                        console.error('‚ùå Date parsing error:', dateError);
                        status = 'Error Parsing Waktu';
                    }
                } else {
                    status = 'Jadwal Tidak Lengkap';
                }
            } else {
                status = 'Karyawan Tidak Ditemukan';
            }

            report.push({
                outlet: outletName,
                tanggal: DateUtils.formatDisplayDate(absen.tanggal),
                hari: DateUtils.getHariIndonesia(absen.tanggal),
                karyawan: absen.nama,
                clock_in: absen.clockin,
                clock_out: absen.clockout || '-',
                status: status
            });
        });

        console.log('‚úÖ Final report:', report.length, 'records');
        return report;
    } catch (error) {
        console.error('‚ùå Error getting attendance report:', error);
        return [];
    }
}
        };
            
        // =============================================
        // DATE TIME UTILITIES (WIB)
        // =============================================
        const DateTimeUtils = {
            getCurrentWIBDate() {
                const now = new Date();
                // Convert to WIB (UTC+7)
                const wibOffset = 7 * 60; // in minutes
                const localOffset = now.getTimezoneOffset();
                const wibTime = new Date(now.getTime() + (wibOffset + localOffset) * 60000);
                
                return wibTime.toISOString().split('T')[0];
            },

            getCurrentWIBTime() {
                const now = new Date();
                // Convert to WIB (UTC+7)
                const wibOffset = 7 * 60; // in minutes
                const localOffset = now.getTimezoneOffset();
                const wibTime = new Date(now.getTime() + (wibOffset + localOffset) * 60000);
                
                return wibTime.toTimeString().split(' ')[0];
            },

            formatWIBDateTime(dateTimeStr) {
                const date = new Date(dateTimeStr);
                const options = {
                    timeZone: 'Asia/Jakarta',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                return date.toLocaleString('id-ID', options);
            },

            // Fungsi baru untuk format transaksi_terakhir
            getFormattedTransactionInfo(outletName) {
                const now = new Date();
                const formattedDate = now.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = now.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                return `${outletName}/${now.toLocaleDateString('id-ID', { weekday: 'long' })}/${formattedDate}/${formattedTime}`;
            }
        };

        // =============================================
        // AUTHENTICATION
        // =============================================
        const Auth = {
            checkAuth() {
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return null;
                }
                return JSON.parse(currentUser);
            },

            logout() {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            },

            getCurrentUser() {
                return this.checkAuth();
            },

            hasPermission(requiredRole) {
                const user = this.getCurrentUser();
                return user && user.role === requiredRole;
            }
        };
        // =============================================
        // OTP SYSTEM FOR CANCELLATION - DIPERBAIKI DENGAN INFORMASI LENGKAP
        // =============================================
        const OTPSystem = {
            currentOrderNo: null,
            otpExpiry: null,
            otpInterval: null,

            generateOTP() {
                return Math.floor(1000 + Math.random() * 9000).toString();
            },

            async sendOTP(orderNo, transactionDetails) {
                try {
                    const otp = this.generateOTP();
                    this.currentOrderNo = orderNo;
                    
                    // Set expiry time (5 minutes from now)
                    this.otpExpiry = new Date(Date.now() + 5 * 60 * 1000);
                    
                    // Start timer
                    this.startOTPTimer();
                    
                  // PERBAIKAN 1: Format message dengan informasi lengkap seperti receipt
const message = this.formatOTPMessage(orderNo, otp, transactionDetails);

// Pastikan appConfig sudah ter-load
if (!appConfig.wahaUrl || !appConfig.wahaXApiKey) {
    throw new Error('WhatsApp configuration not available');
}

const response = await fetch(`${appConfig.wahaUrl}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-Api-Key': appConfig.wahaXApiKey
    },
    body: JSON.stringify({
        session: appConfig.wahaSession,
        chatId: '62811159429@c.us',
        text: message
    })
});
                  
                    if (!response.ok) {
                        throw new Error('Gagal mengirim OTP');
                    }
                    
                    // Store OTP in localStorage (for demo purposes)
                    localStorage.setItem(`otp_${orderNo}`, otp);
                    localStorage.setItem(`otp_expiry_${orderNo}`, this.otpExpiry.getTime());
                    
                    console.log('OTP sent:', otp);
                    return true;
                    
                } catch (error) {
                    console.error('Error sending OTP:', error);
                    throw error;
                }
            },

            // PERBAIKAN 1: Format OTP message dengan informasi lengkap
            formatOTPMessage(orderNo, otp, transactionDetails) {
                const { outlet, customer_name, items, total_amount, payment_type, 
                        discount_amount, redeem_amount, points_earned, serve_by, 
                        point_sebelum, point_didapat, redeem_points, point_saat_ini,
                        kasir, order_date, order_time, subtotal_amount, cash_received, cash_change } = transactionDetails;
                
                let message = `üîê *KODE OTP BATAL TRANSAKSI*\n\n`;
                message += `*Outlet:* ${outlet || 'Babeh Barbershop'}\n`;
                message += `*Order No:* ${orderNo}\n`;
                message += `*Tanggal:* ${order_date} ${order_time}\n`;
                message += `*Kasir:* ${kasir || '-'}\n`;
                message += `*Customer:* ${customer_name || 'Umum'}\n`;
                message += `*Dilayani:* ${serve_by || '-'}\n\n`;
                
                message += `*ITEM PEMBELIAN:*\n`;
                items.forEach((item, index) => {
                    message += `${index + 1}. ${item.item_name} - ${item.qty}x Rp ${POSModule.formatCurrency(item.harga_jual)}\n`;
                });
                
                message += `\n*RINGKASAN:*\n`;
                message += `Subtotal: Rp ${POSModule.formatCurrency(subtotal_amount || total_amount)}\n`;
                
                if (discount_amount > 0) {
                    message += `Discount: -Rp ${POSModule.formatCurrency(discount_amount)}\n`;
                }
                if (redeem_amount > 0) {
                    message += `Redeem: -Rp ${POSModule.formatCurrency(redeem_amount)}\n`;
                }
                
                message += `Total: Rp ${POSModule.formatCurrency(total_amount)}\n`;
                message += `Payment: ${payment_type || 'cash'}\n`;
                
                // PERBAIKAN 1: Tambah informasi pembayaran tunai jika payment type cash
                if (payment_type === 'cash' && cash_received && cash_change !== undefined) {
                    message += `Tunai: Rp ${POSModule.formatCurrency(cash_received)}\n`;
                    message += `Kembali: Rp ${POSModule.formatCurrency(cash_change)}\n`;
                }
                
                // Tampilkan info points lengkap
                if (point_sebelum !== undefined) {
                    message += `\n*INFO POINTS:*\n`;
                    message += `Point Sebelum: ${point_sebelum}\n`;
                    message += `Point Didapat: +${point_didapat}\n`;
                    message += `Redeem: -${redeem_points}\n`;
                    message += `Point Saat Ini: ${point_saat_ini}\n`;
                }
                
                message += `\n*KODE OTP:* ${otp}\n`;
                message += `*Berlaku hingga:* ${this.otpExpiry.toLocaleTimeString('id-ID')}\n\n`;
                message += `‚ö†Ô∏è *PERINGATAN:*\n`;
                message += `Kode ini digunakan untuk membatalkan transaksi.\n`;
                message += `Jangan berikan kode ini kepada siapapun!`;
                
                return message;
            },

            startOTPTimer() {
                if (this.otpInterval) {
                    clearInterval(this.otpInterval);
                }
                
                this.otpInterval = setInterval(() => {
                    const now = new Date();
                    const diff = this.otpExpiry - now;
                    
                    if (diff <= 0) {
                        clearInterval(this.otpInterval);
                        document.getElementById('otpTimer').textContent = 'OTP telah kadaluarsa';
                        document.getElementById('otpInput').disabled = true;
                        return;
                    }
                    
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    document.getElementById('otpTimer').textContent = `OTP berlaku: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            },

            verifyOTP(orderNo, inputOTP) {
                const storedOTP = localStorage.getItem(`otp_${orderNo}`);
                const expiry = localStorage.getItem(`otp_expiry_${orderNo}`);
                
                if (!storedOTP || !expiry) {
                    return false;
                }
                
                const now = new Date().getTime();
                if (now > parseInt(expiry)) {
                    return false;
                }
                
                return inputOTP === storedOTP;
            },

            clearOTP(orderNo) {
                localStorage.removeItem(`otp_${orderNo}`);
                localStorage.removeItem(`otp_expiry_${orderNo}`);
                if (this.otpInterval) {
                    clearInterval(this.otpInterval);
                }
            }
        };

        // =============================================
        // POS MODULE - DENGAN SISTEM POINT & REDEEM BARU
        // =============================================
        const POSModule = {
            products: [],
            categories: [],
            customers: [],
            servers: [],
            currentOrder: {
                items: [],
                servedBy: null,
                customer: null,
                discount: { type: null, value: 0, amount: 0 },
                redeem: { points: 0, amount: 0 },
                subtotal: 0,
                total: 0
            },
            filteredProducts: [],
            selectedServedBy: '',
            selectedCustomer: '',

            async init() {
                await this.loadCategories();
                await this.loadProducts();
                await this.loadCustomers();
                await this.loadServers();
                this.setupEventListeners();
                
                // Initialize order number generator
                const user = Auth.getCurrentUser();
                await OrderNumberGenerator.initialize(user.outlet);
            },

            async loadCategories() {
                try {
                    showLoading(true);
                    const user = Auth.getCurrentUser();
                    this.categories = await Database.getProductCategories(user.outlet);
                    
                    const categoryFilter = document.getElementById('categoryFilter');
                    categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
                    
                    this.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.group;
                        option.textContent = category.group;
                        categoryFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading categories:', error);
                    showNotification('Error loading categories', 'error');
                } finally {
                    showLoading(false);
                }
            },

            async loadProducts(category = null) {
                try {
                    showLoading(true);
                    const user = Auth.getCurrentUser();
                    this.products = await Database.getProducts(user.outlet, category);
                    this.filteredProducts = [...this.products];
                    this.renderProducts();
                } catch (error) {
                    console.error('Error loading products:', error);
                    showNotification('Error loading products', 'error');
                } finally {
                    showLoading(false);
                }
            },

            async loadCustomers() {
                try {
                    const user = Auth.getCurrentUser();
                    this.customers = await Database.getCustomers(user.outlet);
                    
                    // Render customer list untuk modal
                    this.renderCustomerList(this.customers);
                    
                 console.log('‚úÖ Customers loaded:', this.customers.length);
    } catch (error) {
        console.error('Error loading customers:', error);
    }
},

            async loadServers() {
                try {
                    const user = Auth.getCurrentUser();
                    console.log('üîÑ Loading servers for outlet:', user.outlet);
                    
                    this.servers = await Database.getServers(user.outlet);
                    console.log('üìã Servers data:', this.servers);
                    
                    const servedBySelect = document.getElementById('servedBySelect');
                    servedBySelect.innerHTML = '<option value="">Pilih pelayan...</option>';
                    
                    if (this.servers.length === 0) {
                        console.warn('‚ö†Ô∏è No servers found');
                        // Fallback ke user current
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name + ' (Current User)';
                        servedBySelect.appendChild(option);
                        // Jangan auto-select, biarkan user memilih
                        return;
                    }
                    
                    // Tambahkan semua server ke dropdown
                    this.servers.forEach(server => {
                        const option = document.createElement('option');
                        option.value = server.nama_karyawan;
                        option.textContent = server.nama_karyawan;
                        servedBySelect.appendChild(option);
                    });

                    // JANGAN auto-select, biarkan default "Pilih pelayan..."
                    
                } catch (error) {
                    console.error('‚ùå Error in loadServers:', error);
                    
                    // Fallback ke current user
                    const servedBySelect = document.getElementById('servedBySelect');
                    const user = Auth.getCurrentUser();
                    servedBySelect.innerHTML = `<option value="">Pilih pelayan...</option>
                                              <option value="${user.name}">${user.name}</option>`;
                }
            },

            searchProducts(searchTerm) {
                if (!searchTerm) {
                    this.filteredProducts = [...this.products];
                } else {
                    const term = searchTerm.toLowerCase();
                    this.filteredProducts = this.products.filter(product => 
                        product.nama_produk.toLowerCase().includes(term) ||
                        product.group_produk.toLowerCase().includes(term)
                    );
                }
                this.renderProducts();
            },

            renderProducts() {
                const productsGrid = document.getElementById('productsGrid');
                
                if (this.filteredProducts.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            Tidak ada produk ditemukan
                        </div>
                    `;
                    return;
                }

                productsGrid.innerHTML = '';

                this.filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card bg-white border border-gray-200 rounded-lg p-3 md:p-4 cursor-pointer hover:shadow-md transition duration-200';
                    productCard.innerHTML = `
                        <div class="text-center">
                            <div class="w-12 h-12 md:w-16 md:h-16 bg-blue-100 rounded-lg mx-auto mb-2 flex items-center justify-center overflow-hidden">
                                ${product.foto_url ? 
                                    `<img src="${product.foto_url}" alt="${product.nama_produk}" class="w-full h-full object-cover" 
                                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                                     <span class="text-blue-600 font-bold hidden">${product.nama_produk.charAt(0)}</span>` :
                                    `<span class="text-blue-600 font-bold">${product.nama_produk.charAt(0)}</span>`
                                }
                            </div>
                            <h3 class="font-semibold text-sm mb-1 truncate">${product.nama_produk}</h3>
                            <p class="text-green-600 font-bold text-sm md:text-base">Rp ${this.formatCurrency(product.harga_jual)}</p>
                            ${product.stok !== null ? `<p class="text-xs text-gray-500">Stok: ${product.stok}</p>` : ''}
                            ${product.point ? `<p class="text-xs text-yellow-600">${product.point} points</p>` : ''}
                        </div>
                    `;
                    
                    productCard.addEventListener('click', () => this.addToOrder(product));
                    productsGrid.appendChild(productCard);
                });
            },

            renderCustomerList(customers) {
                const customerList = document.getElementById('customerList');
                
                if (customers.length === 0) {
                    customerList.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada customer ditemukan</p>';
                    return;
                }
                
                customerList.innerHTML = customers.map(customer => `
                    <div class="customer-item p-3 md:p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition duration-200 touch-target"
                         onclick="selectCustomer('${customer.id_member}')">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-semibold text-sm md:text-base">${customer.nama}</div>
                                <div class="text-xs text-gray-600">${customer.nomorWA || '-'}</div>
                                <div class="text-xs text-gray-500">ID: ${customer.id_member}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-yellow-600 font-bold text-sm">${customer.point_saat_ini || 0} pts</div>
                                <div class="text-xs text-gray-500">Redeem: ${customer.redeem || 0}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            addToOrder(product) {
                // PERBAIKAN 1: Boleh tambah produk tanpa harus pilih served by dan customer dulu
                
                // Check stock if inventory is enabled
                if (product.inventory && product.stok !== null && product.stok <= 0) {
                    showNotification('Stok produk habis', 'error');
                    return;
                }

                const existingItem = this.currentOrder.items.find(item => item.id === product.id);
                
                if (existingItem) {
                    // Check stock for existing item
                    if (product.inventory && product.stok !== null && existingItem.quantity >= product.stok) {
                        showNotification('Stok tidak mencukupi', 'error');
                        return;
                    }
                    existingItem.quantity += 1;
                    existingItem.total = existingItem.quantity * existingItem.harga_jual;
                } else {
                    this.currentOrder.items.push({
                        id: product.id,
                        nama_produk: product.nama_produk,
                        harga_jual: product.harga_jual,
                        harga_beli: product.harga_beli || 0,
                        quantity: 1,
                        total: product.harga_jual,
                        group_produk: product.group_produk,
                        komisi: product.komisi || 0,
                        point: product.point || 0,
                        inventory: product.inventory,
                        stok: product.stok
                    });
                }
                
                this.updateOrderSummary();
                showNotification(`${product.nama_produk} ditambahkan ke order`, 'success');
            },

            removeFromOrder(index) {
                this.currentOrder.items.splice(index, 1);
                this.updateOrderSummary();
            },

            updateQuantity(index, change) {
                const item = this.currentOrder.items[index];
                const product = this.products.find(p => p.id === item.id);
                
                // Check stock
                if (product && product.inventory && product.stok !== null) {
                    const newQuantity = item.quantity + change;
                    if (newQuantity > product.stok) {
                        showNotification('Stok tidak mencukupi', 'error');
                        return;
                    }
                }
                
                item.quantity += change;
                
                if (item.quantity < 1) {
                    this.removeFromOrder(index);
                } else {
                    item.total = item.quantity * item.harga_jual;
                    this.updateOrderSummary();
                }
            },

            updateOrderSummary() {
                const orderItems = document.getElementById('orderItems');
                const subtotalEl = document.getElementById('subtotal');
                const totalEl = document.getElementById('total');
                
                // Calculate subtotal
                this.currentOrder.subtotal = this.currentOrder.items.reduce((sum, item) => sum + item.total, 0);
                
                // Calculate discount
                let discountAmount = 0;
                if (this.currentOrder.discount.type === 'percent') {
                    discountAmount = (this.currentOrder.subtotal * this.currentOrder.discount.value) / 100;
                } else if (this.currentOrder.discount.type === 'amount') {
                    discountAmount = this.currentOrder.discount.value;
                }
                
                // Calculate total after discount and redeem
                this.currentOrder.total = this.currentOrder.subtotal - discountAmount - this.currentOrder.redeem.amount;
                if (this.currentOrder.total < 0) this.currentOrder.total = 0;
                
                if (this.currentOrder.items.length === 0) {
                    orderItems.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-gray-500">
                                Belum ada item
                            </td>
                        </tr>
                    `;
                    subtotalEl.textContent = 'Rp 0';
                    totalEl.textContent = 'Rp 0';
                    
                    // Hide discount and redeem displays
                    document.getElementById('appliedDiscounts').classList.add('hidden');
                    document.getElementById('appliedRedeem').classList.add('hidden');
                    return;
                }
                
                orderItems.innerHTML = '';
                
                this.currentOrder.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
                        <td class="py-1 md:py-2">
                            <div class="font-medium text-xs md:text-sm">${item.nama_produk}</div>
                            <div class="text-xs text-gray-500 mobile-hidden">Rp ${this.formatCurrency(item.harga_jual)}</div>
                        </td>
                        <td class="py-1 md:py-2 text-right">
                            <div class="flex items-center justify-end space-x-2 md:space-x-3">
    <button onclick="POSModule.updateQuantity(${index}, -1)" class="w-8 h-8 md:w-10 md:h-10 bg-gray-200 rounded-full flex items-center justify-center text-sm font-bold touch-target">-</button>
    <span class="min-w-8 md:min-w-10 text-center text-sm md:text-base font-semibold">${item.quantity}</span>
    <button onclick="POSModule.updateQuantity(${index}, 1)" class="w-8 h-8 md:w-10 md:h-10 bg-gray-200 rounded-full flex items-center justify-center text-sm font-bold touch-target">+</button>
</div>
                        </td>
                        <td class="py-1 md:py-2 text-right mobile-hidden">Rp ${this.formatCurrency(item.harga_jual)}</td>
                        <td class="py-1 md:py-2 text-right">
                            <div class="flex items-center justify-end space-x-1 md:space-x-2">
                                <span class="font-semibold text-xs md:text-sm">Rp ${this.formatCurrency(item.total)}</span>
                                <button onclick="POSModule.removeFromOrder(${index})" class="text-red-500 hover:text-red-700 text-sm md:text-lg">√ó</button>
                            </div>
                        </td>
                    `;
                    orderItems.appendChild(row);
                });
                
                subtotalEl.textContent = `Rp ${this.formatCurrency(this.currentOrder.subtotal)}`;
                totalEl.textContent = `Rp ${this.formatCurrency(this.currentOrder.total)}`;
                
                // Update discount display
                const appliedDiscounts = document.getElementById('appliedDiscounts');
                const discountAmountEl = document.getElementById('discountAmount');
                
                if (discountAmount > 0) {
                    appliedDiscounts.classList.remove('hidden');
                    discountAmountEl.textContent = `-Rp ${this.formatCurrency(discountAmount)}`;
                } else {
                    appliedDiscounts.classList.add('hidden');
                }
                
                // Update redeem display
                const appliedRedeem = document.getElementById('appliedRedeem');
                const redeemAmountEl = document.getElementById('redeemAmount');
                
                if (this.currentOrder.redeem.amount > 0) {
                    appliedRedeem.classList.remove('hidden');
                    redeemAmountEl.textContent = `-Rp ${this.formatCurrency(this.currentOrder.redeem.amount)}`;
                } else {
                    appliedRedeem.classList.add('hidden');
                }
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID').format(amount);
            },

            setupEventListeners() {
                // Category filter
                document.getElementById('categoryFilter').addEventListener('change', (e) => {
                    this.loadProducts(e.target.value || null);
                });

                // Product search
                document.getElementById('productSearch').addEventListener('input', (e) => {
                    this.searchProducts(e.target.value);
                });

                // Customer search
                document.getElementById('customerSearch')?.addEventListener('input', (e) => {
                    this.searchCustomers(e.target.value);
                });

                // Cash input event listener
                document.getElementById('cashReceived')?.addEventListener('input', (e) => {
                    console.log('‚å®Ô∏è Manual cash input:', e.target.value);
                    calculateCashChange();
                });

                // Cash input enter key
                document.getElementById('cashReceived')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const received = parseFloat(e.target.value) || 0;
                        const total = PaymentModule.currentOrderSummary?.total || 0;
                        
                        if (received >= total) {
                            confirmCashPayment();
                        }
                    }
                });
            },

            searchCustomers(searchTerm) {
                if (!searchTerm) {
                    this.renderCustomerList(this.customers);
                    return;
                }
                
                const term = searchTerm.toLowerCase();
                const filteredCustomers = this.customers.filter(customer => 
                    customer.nama.toLowerCase().includes(term) ||
                    (customer.nomorWA && customer.nomorWA.includes(term)) ||
                    (customer.id_member && customer.id_member.toLowerCase().includes(term))
                );
                
                this.renderCustomerList(filteredCustomers);
            },

            clearOrder() {
                this.currentOrder = {
                    items: [],
                    servedBy: null,
                    customer: null,
                    discount: { type: null, value: 0, amount: 0 },
                    redeem: { points: 0, amount: 0 },
                    subtotal: 0,
                    total: 0
                };
                this.updateOrderSummary();
                // Reset tombol ke default
                this.selectedServedBy = '';
                this.selectedCustomer = '';
                document.getElementById('servedByButtonText').textContent = 'Served By';
                document.getElementById('customerButtonText').textContent = 'Customer';
                showNotification('Order telah direset', 'success');
            },

            getOrderSummary() {
                return {
                    subtotal: this.currentOrder.subtotal,
                    total: this.currentOrder.total,
                    discountAmount: this.currentOrder.discount.amount,
                    redeemAmount: this.currentOrder.redeem.amount,
                    pointsEarned: this.currentOrder.items.reduce((sum, item) => sum + (item.point || 0) * item.quantity, 0),
                    itemCount: this.currentOrder.items.reduce((sum, item) => sum + item.quantity, 0)
                };
            },

            validateOrder() {
                // PERBAIKAN 2: Fix validasi untuk customer "Umum"
                if (!this.selectedServedBy) {
                    showNotification('Pilih pelayan terlebih dahulu', 'error');
                    return false;
                }
                
                // PERBAIKAN: Customer "Umum" (empty string) harus dianggap valid
                if (!this.selectedCustomer) {
                    // Ini adalah kondisi "Umum" yang valid
                    this.selectedCustomer = ''; // Set sebagai empty string untuk umum
                }
                
                if (this.currentOrder.items.length === 0) {
                    showNotification('Tidak ada item dalam order', 'error');
                    return false;
                }
                return true;
            },

            async updateStockForOrder() {
                try {
                    for (const item of this.currentOrder.items) {
                        if (item.inventory && item.stok !== null) {
                            await Database.updateProductStock(item.id, item.quantity);
                        }
                    }
                    // Reload products to update stock display
                    await this.loadProducts();
                } catch (error) {
                    console.error('Error updating stock:', error);
                    throw error;
                }
            },

            async restoreStockForOrder(orderNo) {
                try {
                    const transactionItems = await Database.getTransactionItems(orderNo);
                    
                    // Karena tidak ada product_id di transaksi_detail, kita perlu mapping berdasarkan nama produk
                    for (const item of transactionItems) {
                        // Cari produk berdasarkan nama (ini kurang ideal, tapi workaround)
                        const product = this.products.find(p => 
                            p.nama_produk === item.item_name && 
                            p.group_produk === item.item_group
                        );
                        
                        if (product && product.inventory && product.stok !== null) {
                            await Database.restoreProductStock(product.id, item.qty);
                        }
                    }
                    // Reload products to update stock display
                    await this.loadProducts();
                } catch (error) {
                    console.error('Error restoring stock:', error);
                    throw error;
                }
            },

            // Fungsi untuk apply discount
            applyDiscount(discountType, discountValue) {
                let discountAmount = 0;
                if (discountType === 'percent') {
                    discountAmount = (this.currentOrder.subtotal * discountValue) / 100;
                } else if (discountType === 'amount') {
                    discountAmount = discountValue;
                }
                
                this.currentOrder.discount = {
                    type: discountType,
                    value: discountValue,
                    amount: discountAmount
                };
                
                this.updateOrderSummary();
            },

            // Fungsi untuk apply redeem
            applyRedeem(points, amount) {
                this.currentOrder.redeem = {
                    points: points,
                    amount: amount
                };
                
                this.updateOrderSummary();
            },

            // =============================================
            // FUNGSI HITUNG POINT BARU - DENGAN KONDISI REDEEM
            // =============================================
            calculatePointsEarned() {
                // PERBAIKAN: Jika ada redeem, maka point = 0
                if (this.currentOrder.redeem.points > 0) {
                    console.log('üí∞ Redeem detected, setting points to 0');
                    return 0;
                }
                
                // Hitung total points dari items
                const totalPointsFromItems = this.currentOrder.items.reduce((sum, item) => sum + (item.point || 0) * item.quantity, 0);
                
                console.log('üìä Points calculation:', {
                    totalPointsFromItems,
                    redeemPoints: this.currentOrder.redeem.points,
                    finalPoints: totalPointsFromItems
                });
                
                return totalPointsFromItems;
            },

            // Fungsi untuk mendapatkan total profit dan komisi
            calculateTotals() {
                const totalHargaBeli = this.currentOrder.items.reduce((sum, item) => sum + ((item.harga_beli || 0) * item.quantity), 0);
                const totalHargaJual = this.currentOrder.items.reduce((sum, item) => sum + (item.harga_jual * item.quantity), 0);
                const totalProfit = this.currentOrder.items.reduce((sum, item) => sum + (item.total - ((item.harga_beli || 0) * item.quantity)), 0);
                const totalKomisi = this.currentOrder.items.reduce((sum, item) => sum + ((item.komisi || 0) * item.quantity), 0);
                const totalPoints = this.calculatePointsEarned(); // Gunakan fungsi baru
                
                return {
                    totalHargaBeli,
                    totalHargaJual,
                    totalProfit,
                    totalKomisi,
                    totalPoints
                };
            }
        };
// =============================================
// PAYMENT MODULE - DIPERBAIKI DENGAN SISTEM POINT BARU & IPAYMU QRIS
// =============================================

// ‚≠ê PASTIKAN PaymentModule ADA DI WINDOW OBJECT
    window.PaymentModule = {
        currentPaymentType: null,
        currentOrderSummary: null,
        currentIpaymuReferenceId: null,
        isProcessing: false,
        cashReceived: 0,
        cashChange: 0,

        async processPayment(paymentType) {
            console.log('üéØ PaymentModule.processPayment called:', paymentType);
        // ‚≠ê DOUBLE-SUBMIT PREVENTION - PINDAH KE ATAS
        if (this.isProcessing) {
            showNotification('Sedang memproses pembayaran...', 'warning');
            return;
        }

        // Validasi order sebelum proses pembayaran
        if (!POSModule.validateOrder()) {
            return;
        }

        this.currentPaymentType = paymentType;
        this.currentOrderSummary = POSModule.getOrderSummary();

        console.log('üí∞ Payment process started:', {
            type: paymentType,
            total: this.currentOrderSummary.total,
            items: POSModule.currentOrder.items.length
        });

        // Handle different payment types
        switch(paymentType) {
            case 'cash':
                this.showCashPaymentModal();
                break;
            case 'qris_dinamis':
                this.showQRISDinamisModal();
                break;
            case 'transfer_bank':
                this.showTransferBankModal();
                break;
            default:
                this.showPaymentModal();
        }
    },

    showCashPaymentModal() {
        // Pastikan currentOrderSummary ada
        if (!this.currentOrderSummary) {
            this.currentOrderSummary = POSModule.getOrderSummary();
        }

        const totalAmount = this.currentOrderSummary.total;
        
        console.log('üíµ Opening cash modal, total:', totalAmount);
        
        // Update UI
        document.getElementById('cashTotalAmount').textContent = `Rp ${POSModule.formatCurrency(totalAmount)}`;
        document.getElementById('cashReceived').value = '';
        document.getElementById('cashChangeAmount').textContent = 'Rp 0';
        document.getElementById('cashChangeSection').classList.add('hidden');
        document.getElementById('confirmCashButton').disabled = true;
        
        // Reset state
        this.cashReceived = 0;
        this.cashChange = 0;
        
        document.getElementById('cashPaymentModal').classList.remove('hidden');
        
        // Focus ke input
        setTimeout(() => {
            document.getElementById('cashReceived').focus();
        }, 100);
    },

    async confirmCashPayment() {
        const receivedInput = document.getElementById('cashReceived');
        const received = parseFloat(receivedInput.value) || 0;
        const total = this.currentOrderSummary.total;
        
        console.log('üîç Validating cash payment:', { 
            received, 
            total, 
            difference: received - total 
        });

        // Validasi
        if (received === 0) {
            showNotification('Masukkan jumlah uang yang diterima', 'error');
            return;
        }

        if (received < total) {
            showNotification(
                `Uang diterima (Rp ${POSModule.formatCurrency(received)}) kurang dari total (Rp ${POSModule.formatCurrency(total)})`, 
                'error'
            );
            return;
        }

        // Simpan nilai cash untuk referensi
        this.cashReceived = received;
        this.cashChange = received - total;

        console.log('‚úÖ Cash validation passed, proceeding with payment...');
        await this.confirmPayment();
    },

    // ‚≠ê UPDATE: SHOW QRIS DINAMIS MODAL
    showQRISDinamisModal() {
        // ‚≠ê SET STATE DENGAN BENAR SEBELUM GENERATE QRIS
        this.currentPaymentType = 'qris_dinamis';
        this.currentOrderSummary = POSModule.getOrderSummary();
        this.currentIpaymuReferenceId = null;
        
        console.log('üîß QRIS Modal State Set:', {
            paymentType: this.currentPaymentType,
            total: this.currentOrderSummary.total
        });
         const simulateBtn = document.getElementById('simulateQRISBtn');
            if (simulateBtn) simulateBtn.style.display = 'none';
        
        document.getElementById('qrisModalTitle').textContent = 'QRIS Dinamis';
        document.getElementById('qrisAmountDisplay').textContent = `Rp ${POSModule.formatCurrency(this.currentOrderSummary.total)}`;
        
        // ‚≠ê SETUP LOADING STATE
        document.getElementById('qrisImageContainer').innerHTML = '';
        document.getElementById('qrisDinamisContent').classList.remove('hidden');
        document.getElementById('qrisDinamisContent').innerHTML = `
            <div class="bg-gray-100 p-4 rounded-lg mb-4">
                <div class="animate-pulse bg-gray-300 h-48 w-48 mx-auto rounded-lg flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                        <span class="text-gray-600 text-sm">Generating QRIS...</span>
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-500 mb-4">QR Code akan muncul dalam beberapa detik</p>
        `;
        
        document.getElementById('qrisDisplayModal').classList.remove('hidden');
        
        // ‚≠ê JALANKAN GENERATE QRIS
        this.generateQRISDinamis();
    },

    // ‚≠ê UPDATE: GENERATE QRIS DINAMIS
    async generateQRISDinamis() {
        try {
            const amount = this.currentOrderSummary.total;
            
            console.log('üöÄ Generating QRIS Dinamis...');
            
           const result = await QRISDinamis.generate(amount);
            
            if (result.success) {
                // ‚≠ê SIMPAN REFERENCE ID DARI IPAYMU
                this.currentIpaymuReferenceId = result.referenceId;
                
                console.log('üíæ iPaymu Reference ID saved:', this.currentIpaymuReferenceId);
                
                document.getElementById('qrisDinamisContent').classList.add('hidden');
                document.getElementById('qrisImageContainer').innerHTML = result.html;
                
                QRISDinamis.startPolling(result.referenceId);
                
            } else {
                    // ‚≠ê LANGSUNG TAMPILKAN ERROR KE USER
            console.log('‚ùå QRIS failed, showing user message:', result.error);
            showNotification(result.error, 'error');

        }
        
    } catch (error) {
        // ‚≠ê FALLBACK UNTUK UNEXPECTED ERRORS
        console.error('Unexpected QRIS error:', error);
        showNotification('Terjadi kesalahan tak terduga. Silakan coba lagi.', 'error');
    }
},
    showTransferBankModal() {
        if (!this.currentOrderSummary) {
            this.currentOrderSummary = POSModule.getOrderSummary();
        }

        const totalAmount = this.currentOrderSummary.total;
        document.getElementById('transferBankTotal').textContent = `Rp ${POSModule.formatCurrency(totalAmount)}`;
        document.getElementById('transferBankModal').classList.remove('hidden');
    },

    showPaymentModal() {
        if (!this.currentPaymentType) {
            showNotification('Jenis pembayaran tidak valid', 'error');
            return;
        }

        const customerId = POSModule.selectedCustomer;
        const customer = POSModule.customers.find(c => c.id_member === customerId);
        
        const modalTitle = document.getElementById('paymentModalTitle');
        const modalContent = document.getElementById('paymentModalContent');
        
        modalTitle.textContent = `Konfirmasi Pembayaran - ${this.currentPaymentType.toUpperCase()}`;
        
        modalContent.innerHTML = `
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span>Total Amount:</span>
                    <span class="font-bold">Rp ${POSModule.formatCurrency(this.currentOrderSummary.total)}</span>
                </div>
                <div class="flex justify-between">
                    <span>Customer:</span>
                    <span>${customer ? customer.nama : 'Umum'}</span>
                </div>
                ${this.currentOrderSummary.pointsEarned > 0 ? `
                <div class="flex justify-between">
                    <span>Points Earned:</span>
                    <span class="text-green-600">+${this.currentOrderSummary.pointsEarned}</span>
                </div>
                ` : ''}
                <div class="border-t pt-2">
                    <div class="flex justify-between font-semibold">
                        <span>Payment Method:</span>
                        <span>${this.currentPaymentType.toUpperCase()}</span>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('paymentModal').classList.remove('hidden');
    },

    // ‚≠ê UPDATE: CONFIRM PAYMENT DENGAN VALIDASI IPAYMU
    async confirmPayment() {
        console.log('üéØ confirmPayment() CALLED - Payment Type:', this.currentPaymentType);
        console.log('üîç iPaymu Reference:', this.currentIpaymuReferenceId);
        // ‚≠ê DOUBLE-SUBMIT PREVENTION - TAMBAH NOTIFICATION
        if (this.isProcessing) {
            showNotification('Sedang memproses pembayaran...', 'warning');
            return;
        }

        if (!this.currentPaymentType) {
            showNotification('Jenis pembayaran tidak valid', 'error');
            this.closeAllModals();
            return;
        }

        // ‚≠ê‚≠ê VALIDASI KHUSUS UNTUK IPAYMU - TAPI FLEKSIBEL UNTUK MANUAL PRINT
if (this.currentPaymentType === 'qris_dinamis') {
    const currentStatus = await this.checkIpaymuPaymentStatus();
    console.log('üîç iPaymu status check:', currentStatus);
    
    if (currentStatus === 'expired') {
        showNotification('Pembayaran QRIS sudah expired. Silakan buat order baru.', 'error');
        return;
    }
    
    // ‚≠ê‚≠ê PERBAIKI: JANGAN BLOCK JIKA STATUS BUKAN "berhasil"
    // Karena mungkin dari manual print, biarkan proses lanjut
    if (currentStatus !== 'berhasil') {
        console.warn('‚ö†Ô∏è QRIS status not "berhasil", but continuing for manual print...', currentStatus);
        // JANGAN return - biarkan proses lanjut untuk manual print
    }
}

        try {
            this.isProcessing = true;
            showLoading(true);
            
            // PERBAIKAN: Gunakan POSModule.selectedCustomer langsung, bukan dari DOM
            const customerId = POSModule.selectedCustomer;
            const customer = POSModule.customers.find(c => c.id_member === customerId);
            const servedBy = POSModule.selectedServedBy;

            if (!servedBy) {
                throw new Error('Pilih pelayan terlebih dahulu');
            }

            // Validate order
            if (POSModule.currentOrder.items.length === 0) {
                throw new Error('Tidak ada item dalam order');
            }

            // Generate order number
            console.log('üî¢ Generating hybrid order number...');
            const orderNo = await OrderNumberGenerator.generate();
            const orderDate = DateTimeUtils.getCurrentWIBDate();
            const orderTime = DateTimeUtils.getCurrentWIBTime();

            console.log('‚úÖ Using order number:', orderNo);

            // Get current user
            const user = Auth.getCurrentUser();
            if (!user) {
                throw new Error('User tidak valid');
            }

            // Calculate points earned - menggunakan fungsi baru dengan kondisi redeem
            const pointsEarned = POSModule.calculatePointsEarned();

            // Calculate totals
            const totals = POSModule.calculateTotals();

            // =============================================
            // 1. SAVE TRANSAKSI DETAIL (ITEM BASED) + IPAYMU REFERENCE
            // =============================================
            const transactionItems = POSModule.currentOrder.items.map(item => ({
                outlet: user.outlet,
                order_no: orderNo,
                order_date: orderDate,
                order_time: orderTime,
                serve_by: servedBy,
                kasir: user.name,
                customer_id: customerId || null,
                customer_name: customer ? customer.nama : 'Umum',
                item_group: item.group_produk,
                item_name: item.nama_produk,
                qty: item.quantity,
                uom: 'pcs',
                harga_beli: item.harga_beli || 0,
                harga_jual: item.harga_jual,
                amount: item.total,
                profit: item.total - ((item.harga_beli || 0) * item.quantity),
                comission: (item.komisi || 0) * item.quantity,
                point: item.point || 0,
                payment_type: this.currentPaymentType,
                status: 'completed',
                // ‚≠ê TAMBAHAN: SIMPAN REFERENCE ID IPAYMU
                ipaymu_reference_id: this.currentIpaymuReferenceId || null
            }));

            console.log('üíæ Saving transaction items:', transactionItems);

            // Save transaction items
            const result = await Database.saveTransaction(transactionItems);
            
            if (!result) {
                throw new Error('Gagal menyimpan transaksi detail');
            }

            // =============================================
            // 2. SAVE TRANSAKSI ORDER (TRANSACTION BASED) + IPAYMU REFERENCE
            // =============================================
            const transactionOrder = {
                outlet: user.outlet,
                order_no: orderNo,
                order_date: orderDate,
                order_time: orderTime,
                serve_by: servedBy,
                kasir: user.name,
                customer_id: customerId || null,
                customer_name: customer ? customer.nama : 'Umum',
                harga_beli: totals.totalHargaBeli,
                harga_jual: totals.totalHargaJual,
                discount_percent: POSModule.currentOrder.discount.type === 'percent' ? POSModule.currentOrder.discount.value : 0,
                discount_amount: POSModule.currentOrder.discount.amount,
                redeem_qty: POSModule.currentOrder.redeem.points,
                redeem_amount: POSModule.currentOrder.redeem.amount,
                point: pointsEarned,
                subtotal_amount: POSModule.currentOrder.subtotal,
                total_amount: POSModule.currentOrder.total,
                profit: totals.totalProfit,
                comission: totals.totalKomisi,
                payment_type: this.currentPaymentType,
                status: 'completed',
                created_at: new Date().toISOString(),
                // PERBAIKAN 2: Simpan data cash untuk copy receipt
                cash_received: this.currentPaymentType === 'cash' ? this.cashReceived : null,
                cash_change: this.currentPaymentType === 'cash' ? this.cashChange : null,
                // ‚≠ê TAMBAHAN: SIMPAN REFERENCE ID IPAYMU
                ipaymu_reference_id: this.currentIpaymuReferenceId || null
            };

            console.log('üíæ Saving transaction order with iPaymu reference:', {
                orderNo: orderNo,
                ipaymuReference: this.currentIpaymuReferenceId
            });

            // Save transaction order
            const orderResult = await Database.saveTransactionOrder(transactionOrder);
            
            if (!orderResult) {
                throw new Error('Gagal menyimpan transaksi order');
            }

            // =============================================
            // 3. UPDATE CUSTOMER POINTS - SISTEM BARU
            // =============================================
            let customerPointInfo = null;
            if (customerId && customerId !== '' && customer) {
                customerPointInfo = await Database.updateCustomerPoints(
                    customerId, 
                    totals.totalPoints, 
                    POSModule.currentOrder.redeem.points,
                    user.outlet
                );
                console.log(`Points diberikan ke customer: ${customer.nama}`, customerPointInfo);
            }

            // =============================================
            // 4. UPDATE STOCK
            // =============================================
            await POSModule.updateStockForOrder();

            // =============================================
            // 5. SEND WHATSAPP RECEIPT - DENGAN SISTEM POINT BARU & INFORMASI LENGKAP
            // =============================================
            if (customer && customer.nomorWA) {
                await sendReceiptViaWhatsApp(
                    orderNo, 
                    customer.nomorWA, 
                    POSModule.currentOrder.total,
                    customerPointInfo ? customerPointInfo.pointSebelum : 0,
                    customerPointInfo ? customerPointInfo.point : 0,
                    POSModule.currentOrder.redeem.points,
                    customerPointInfo ? customerPointInfo.pointSaatIni : 0,
                    POSModule.currentOrder.items,
                    servedBy,
                    this.currentPaymentType,
                    // PERBAIKAN 1: Tambah parameter tambahan untuk informasi lengkap
                    user.name,
                    orderDate,
                    orderTime,
                    POSModule.currentOrder.subtotal,
                    POSModule.currentOrder.discount.amount,
                    POSModule.currentOrder.redeem.amount,
                    this.cashReceived,
                    this.cashChange
                );
            }
// =============================================
// 6. PRINT RECEIPT - DENGAN SISTEM POINT BARU
// =============================================
const printPromise = PrinterModule.printReceipt({
    orderNo: orderNo,
    date: orderDate,
    time: orderTime,
    customerName: customer ? customer.nama : 'Umum',
    items: POSModule.currentOrder.items,
    total: POSModule.currentOrder.total,
    paymentType: this.currentPaymentType,
    cashReceived: this.cashReceived,
    cashChange: this.cashChange,
    servedBy: servedBy,
    pointsEarned: pointsEarned,
    discountAmount: POSModule.currentOrder.discount.amount,
    redeemAmount: POSModule.currentOrder.redeem.amount,
    pointSebelum: customerPointInfo ? customerPointInfo.pointSebelum : 0,
    pointDidapat: customerPointInfo ? customerPointInfo.point : 0,
    redeemPoints: POSModule.currentOrder.redeem.points,
    pointSaatIni: customerPointInfo ? customerPointInfo.pointSaatIni : 0
});

// Timeout untuk print - maksimal 5 detik
const printTimeout = new Promise((resolve) => {
    setTimeout(() => {
        console.log('‚è∞ Print timeout - lanjutkan tanpa print');
        resolve(false);
    }, 5000);
});

// Tunggu print atau timeout, mana yang lebih dulu
await Promise.race([printPromise, printTimeout]);


            // Show success modal dengan info cash
            this.showSuccessModal(orderNo, POSModule.currentOrder.total);

            // Clear order
            POSModule.clearOrder();

            // Close ALL modals
            this.closeAllModals();

            // REFRESH DATA SETELAH TRANSAKSI BERHASIL
            console.log('‚úÖ Transaction successful, refreshing data...');
            try {
                // 1. Refresh products (untuk update stok)
                await POSModule.loadProducts();
                console.log('üì¶ Products refreshed');
                
                // 2. Refresh customers (untuk update points)  
                await POSModule.loadCustomers();
                console.log('üë• Customers refreshed');
                
                // 3. Refresh transactions list (jika sedang di tab transactions)
                if (document.getElementById('transactions-content') && 
                    !document.getElementById('transactions-content').classList.contains('hidden')) {
                    await TransactionsModule.loadTransactions();
                    console.log('üí≥ Transactions list refreshed');
                }
                
                console.log('üîÑ All data refreshed after transaction');
            } catch (refreshError) {
                console.error('‚ùå Error refreshing data after transaction:', refreshError);
                // Jangan ganggu flow transaksi yang sudah sukses
            }

        } catch (error) {
            console.error('‚ùå Error processing payment:', error);
            showNotification('Error processing payment: ' + error.message, 'error');
        } finally {
            this.isProcessing = false;
            showLoading(false);
        }
    },

    // ‚≠ê BARU: CHECK IPAYMU PAYMENT STATUS
    async checkIpaymuPaymentStatus() {
        if (!this.currentIpaymuReferenceId) return 'pending';
        
        try {
            const response = await fetch('/.netlify/functions/callback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    referenceId: this.currentIpaymuReferenceId,
                    action: 'checkStatus'
                })
            });
            
            const data = await response.json();
            return data.status || 'pending';
        } catch (error) {
            console.error('‚ùå Error checking iPaymu status:', error);
            return 'pending';
        }
    },

    showSuccessModal(orderNo, amount) {
    document.getElementById('successOrderNo').textContent = `Order: ${orderNo}`;
    document.getElementById('successAmount').textContent = `Rp ${POSModule.formatCurrency(amount)}`;
    
    // ‚≠ê UPDATE KHUSUS UNTUK QRIS - TAMBAH MANUAL PRINT
    if (this.currentPaymentType === 'qris_dinamis') {
        document.getElementById('successMessage').innerHTML = `
            Pembayaran QRIS berhasil!<br>
            <small>Reference: ${this.currentIpaymuReferenceId}</small>
            <br><br>
           
        `;
    } 
    // ‚≠ê TAMBAH INFO CASH JIKA PAYMENT TYPE CASH
    else if (this.currentPaymentType === 'cash' && this.cashReceived && this.cashChange) {
        document.getElementById('successMessage').innerHTML = `
            Pembayaran cash berhasil!<br>
            <small>Uang diterima: Rp ${POSModule.formatCurrency(this.cashReceived)}<br>
            Kembalian: Rp ${POSModule.formatCurrency(this.cashChange)}</small>
        `;
    } 
    // ‚≠ê DEFAULT MESSAGE UNTUK PAYMENT METHOD LAIN
    else {
        document.getElementById('successMessage').textContent = 'Pembayaran berhasil diproses dan transaksi telah disimpan.';
    }
    
    document.getElementById('successModal').classList.remove('hidden');
},

closeAllModals() {
    // Close all payment-related modals
    const modals = [
        'paymentModal',
        'cashPaymentModal',
        'transferBankModal',
        'qrisStaticModal',
        'qrisDisplayModal',
        'paymentMethodModal'
    ];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }
    });
    
    this.currentPaymentType = null;
    this.currentOrderSummary = null;
    this.currentIpaymuReferenceId = null; // ‚≠ê RESET REFERENCE ID
    this.cashReceived = 0;
    this.cashChange = 0;
}
};

// =============================================
// CASH PAYMENT FUNCTIONS
// =============================================
function calculateCashChange() {
    try {
        const receivedInput = document.getElementById('cashReceived');
        const received = parseFloat(receivedInput.value) || 0;
        const total = PaymentModule.currentOrderSummary?.total || 0;
        const change = received - total;
        
        console.log('üí∞ Cash Calculation:', { 
            received, 
            total, 
            change,
            isSufficient: received >= total
        });
        
        const changeSection = document.getElementById('cashChangeSection');
        const changeAmount = document.getElementById('cashChangeAmount');
        const confirmButton = document.getElementById('confirmCashButton');
        
        if (received > 0) {
            changeSection.classList.remove('hidden');
            changeAmount.textContent = `Rp ${POSModule.formatCurrency(change)}`;
            
            if (received >= total) {
                changeAmount.className = 'text-lg md:text-xl font-bold text-green-600';
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700');
                console.log('‚úÖ Cash sufficient - Confirm button ENABLED');
            } else {
                changeAmount.className = 'text-lg md:text-xl font-bold text-red-600';
                confirmButton.disabled = true;
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                console.log('‚ùå Cash insufficient - Confirm button DISABLED');
            }
        } else {
            changeSection.classList.add('hidden');
            confirmButton.disabled = true;
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        }
    } catch (error) {
        console.error('‚ùå Error in calculateCashChange:', error);
    }
}

function addCashAmount(amount) {
    const receivedInput = document.getElementById('cashReceived');
    const currentValue = parseFloat(receivedInput.value) || 0;
    const newValue = currentValue + amount;
    
    receivedInput.value = newValue;
    
    console.log('üíµ Added cash amount:', {
        currentValue,
        amount,
        newValue
    });
    
    // Trigger change event manually
    const event = new Event('input', { bubbles: true });
    receivedInput.dispatchEvent(event);
    
    calculateCashChange();
}

function closeCashPaymentModal() {
    document.getElementById('cashPaymentModal').classList.add('hidden');
    PaymentModule.currentPaymentType = null;
    PaymentModule.currentOrderSummary = null;
}

function confirmCashPayment() {
    console.log('üîÑ Confirm cash payment clicked');
    PaymentModule.confirmCashPayment();
}

// =============================================
// TRANSFER BANK FUNCTIONS
// =============================================
function closeTransferBankModal() {
    document.getElementById('transferBankModal').classList.add('hidden');
}

function confirmTransferBankPayment() {
    PaymentModule.confirmPayment();
}

// =============================================
// QRIS STATIC FUNCTIONS
// =============================================
function showQRISStaticModal() {
    if (POSModule.currentOrder.items.length === 0) {
        showNotification('Tidak ada item dalam order', 'warning');
        return;
    }
    
    const total = POSModule.getOrderSummary().total;
    document.getElementById('qrisStaticTotal').textContent = `Rp ${POSModule.formatCurrency(total)}`;
    document.getElementById('qrisStaticModal').classList.remove('hidden');
}

function closeQRISStaticModal() {
    document.getElementById('qrisStaticModal').classList.add('hidden');
}

function processQRISStatic(type) {
    PaymentModule.currentPaymentType = `qris_static_${type}`;
    PaymentModule.currentOrderSummary = POSModule.getOrderSummary();
    
    document.getElementById('qrisModalTitle').textContent = `QRIS Statis ${type.toUpperCase()}`;
    document.getElementById('qrisAmountDisplay').textContent = `Rp ${POSModule.formatCurrency(PaymentModule.currentOrderSummary.total)}`;
    document.getElementById('qrisDinamisContent').classList.add('hidden');
    
    // Show appropriate QRIS image
    const qrisContainer = document.getElementById('qrisImageContainer');
    qrisContainer.innerHTML = `
        <img src="assets/${type}.png" alt="QRIS ${type}" class="qris-image border rounded-lg" 
             onerror="this.src='https://via.placeholder.com/200x200/3B82F6/FFFFFF?text=QRIS+${type.toUpperCase()}'">
        <p class="text-sm text-gray-600 mt-2">Scan QR code di atas untuk pembayaran</p>
    `;
    
    document.getElementById('qrisStaticModal').classList.add('hidden');
    document.getElementById('qrisDisplayModal').classList.remove('hidden');
}

function closeQRISDisplayModal() {
    document.getElementById('qrisDisplayModal').classList.add('hidden');
}

function simulateQRISPayment() {
    // Simulate successful QRIS payment
    PaymentModule.confirmPayment();
}

// =============================================
// REDEEM & DISCOUNT FUNCTIONS - DENGAN SISTEM POINT BARU
// =============================================
function showRedeemModal() {
    const customerId = POSModule.selectedCustomer;
    
    if (!customerId) {
        showNotification('Pilih customer terlebih dahulu untuk redeem points', 'error');
        return;
    }
    
    const customer = POSModule.customers.find(c => c.id_member === customerId);
    if (!customer) {
        showNotification('Customer tidak ditemukan', 'error');
        return;
    }
    
    document.getElementById('availablePoints').textContent = `${customer.point_saat_ini || 0} points`;
    document.getElementById('redeemPoints').value = '';
    document.getElementById('redeemCalculation').classList.add('hidden');
    document.getElementById('applyRedeemButton').disabled = true;
    
    document.getElementById('redeemModal').classList.remove('hidden');
}

function closeRedeemModal() {
    document.getElementById('redeemModal').classList.add('hidden');
}

function calculateRedeemValue() {
    const pointsInput = document.getElementById('redeemPoints');
    const points = parseInt(pointsInput.value) || 0;
    const customerId = POSModule.selectedCustomer;
    const customer = POSModule.customers.find(c => c.id_member === customerId);
    const availablePoints = customer ? customer.point_saat_ini : 0;
    
    if (points > availablePoints) {
        showNotification('Points tidak mencukupi', 'error');
        pointsInput.value = availablePoints;
        calculateRedeemValue();
        return;
    }
    
    // Hardcoded conversion: 1 points = Rp 2,000
    const redeemAmount = Math.floor(points / 1) * 2000;
    
    const redeemCalculation = document.getElementById('redeemCalculation');
    const redeemValue = document.getElementById('redeemValue');
    const applyButton = document.getElementById('applyRedeemButton');
    
    if (points > 0) {
        redeemCalculation.classList.remove('hidden');
        redeemValue.textContent = `Rp ${POSModule.formatCurrency(redeemAmount)}`;
        applyButton.disabled = false;
    } else {
        redeemCalculation.classList.add('hidden');
        applyButton.disabled = true;
    }
}

function applyRedeem() {
    const points = parseInt(document.getElementById('redeemPoints').value) || 0;
    const redeemAmount = Math.floor(points / 1) * 2000;
    
    POSModule.applyRedeem(points, redeemAmount);
    closeRedeemModal();
    showNotification(`Redeem ${points} points berhasil diterapkan`);
    
    // PERBAIKAN: Set points earned ke 0 jika ada redeem
    console.log('üí∞ Redeem applied, points earned will be 0');
}

function showDiscountModal() {
    document.getElementById('discountValue').value = '';
    document.getElementById('discountCalculation').classList.add('hidden');
    document.getElementById('applyDiscountButton').disabled = true;
    
    document.getElementById('discountModal').classList.remove('hidden');
}

function closeDiscountModal() {
    document.getElementById('discountModal').classList.add('hidden');
}

function toggleDiscountInput() {
    const discountType = document.getElementById('discountType').value;
    const discountValue = document.getElementById('discountValue');
    
    if (discountType === 'percent') {
        discountValue.placeholder = 'Masukkan persentase discount';
        discountValue.max = 100;
    } else {
        discountValue.placeholder = 'Masukkan jumlah discount';
        discountValue.max = null;
    }
    
    calculateDiscountAmount();
}

function calculateDiscountAmount() {
    const discountType = document.getElementById('discountType').value;
    const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
    const subtotal = POSModule.currentOrder.subtotal;
    
    let discountAmount = 0;
    if (discountType === 'percent') {
        discountAmount = (subtotal * discountValue) / 100;
    } else {
        discountAmount = discountValue;
    }
    
    // Ensure discount doesn't exceed subtotal
    if (discountAmount > subtotal) {
        discountAmount = subtotal;
    }
    
    const discountCalculation = document.getElementById('discountCalculation');
    const discountAmountValue = document.getElementById('discountAmountValue');
    const applyButton = document.getElementById('applyDiscountButton');
    
    if (discountValue > 0) {
        discountCalculation.classList.remove('hidden');
        discountAmountValue.textContent = `-Rp ${POSModule.formatCurrency(discountAmount)}`;
        applyButton.disabled = false;
    } else {
        discountCalculation.classList.add('hidden');
        applyButton.disabled = true;
    }
}

function applyDiscount() {
    const discountType = document.getElementById('discountType').value;
    const discountValue = parseFloat(document.getElementById('discountValue').value) || 0;
    
    POSModule.applyDiscount(discountType, discountValue);
    closeDiscountModal();
    showNotification('Discount berhasil diterapkan');
}
// =============================================
// MANUAL PRINT FUNCTIONS - UNTUK QRIS DINAMIS
// =============================================

// ‚≠ê‚≠ê BARU: Fungsi global untuk tombol manual print QRIS
async function manualPrintFromSuccess(orderNo, amount, referenceId) {
    console.log('üñ®Ô∏è Manual print triggered, calling confirmPayment...');
    
    try {
        showLoading(true);
        
        // ‚≠ê‚≠ê PASTIKAN STATE PaymentModule SESUAI
        PaymentModule.currentPaymentType = 'qris_dinamis';
        PaymentModule.currentIpaymuReferenceId = referenceId;
        
        // ‚≠ê‚≠ê UPDATE ORDER SUMMARY JIKA PERLU
        if (!PaymentModule.currentOrderSummary) {
            PaymentModule.currentOrderSummary = POSModule.getOrderSummary();
        }
        
        console.log('üîß State set for confirmPayment:', {
            paymentType: PaymentModule.currentPaymentType,
            referenceId: PaymentModule.currentIpaymuReferenceId,
            orderNo: orderNo
        });
        
        // ‚≠ê‚≠ê LANGSUNG PANGGIL confirmPayment() - SAMA PERSIS DENGAN CASH
        await PaymentModule.confirmPayment();
        
        // ‚≠ê‚≠ê TUTUP MODAL SUCCESS SETELAH BERHASIL
        document.getElementById('successModal').classList.add('hidden');
        
    } catch (error) {
        console.error('‚ùå Error in manual print process:', error);
        showNotification('Gagal memproses receipt: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ‚≠ê CLEANUP PADA PAGE UNLOAD - UPDATE KE QRISDinamis
window.addEventListener('beforeunload', () => {
    if (window.QRISDinamis) {
        QRISDinamis.cleanup();
    }
});

window.addEventListener('pagehide', () => {
    if (window.QRISDinamis) {
        QRISDinamis.cleanup();
    }
});
// =============================================
// WHATSAPP INTEGRATION - DIPERBAIKI
// =============================================
async function sendReceiptViaWhatsApp(orderNo, phoneNumber, totalAmount, pointSebelum, pointDidapat, redeemPoints, pointSaatIni, items, servedBy, paymentType, 
    kasir, orderDate, orderTime, subtotal, discountAmount, redeemAmount, cashReceived, cashChange) {
    try {
        console.log('üì± Attempting to send WhatsApp receipt...');
        
        // Validasi nomor telepon
        if (!phoneNumber) {
            console.warn('‚ùå No phone number provided');
            return;
        }

        // Format phone number to 62xxxxxxxxxx
        let formattedPhone = phoneNumber.replace(/^0/, '62');
        if (!formattedPhone.includes('@c.us')) {
            formattedPhone += '@c.us';
        }
        
        console.log('üìû Formatted phone:', formattedPhone);

        // Format items untuk WhatsApp
        const itemsText = items.map((item, index) => {
            const itemTotal = item.harga_jual * item.quantity;
            return `${index + 1}. ${item.nama_produk} ${item.quantity}x Rp ${POSModule.formatCurrency(item.harga_jual)} = Rp ${POSModule.formatCurrency(itemTotal)}`;
        }).join('\n');
        
        // PERBAIKAN: Gunakan let bukan const untuk message yang akan di-modify
        let message = `üíà *BABEH BARBERSHOP* üíà\n` +
                     `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n` +
                     `üìã *NOTA TRANSAKSI*\n` +
                     `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n` +
                     `üÜî No Order: ${orderNo}\n` +
                     `üìÖ Tanggal: ${orderDate} ${orderTime}\n` +
                     `üë®‚Äçüíº Kasir: ${kasir}\n` +
                     `üíÅ Dilayani: ${servedBy}\n` +
                     `üí≥ Payment: ${paymentType.toUpperCase()}\n\n` +
                     `üì¶ *ITEM PEMBELIAN:*\n` +
                     `${itemsText}\n\n` +
                     `üí∞ *RINGKASAN PEMBAYARAN:*\n` +
                     `Subtotal: Rp ${POSModule.formatCurrency(subtotal)}\n`;
        
        // Tambah discount jika ada
        if (discountAmount > 0) {
            message += `Discount: -Rp ${POSModule.formatCurrency(discountAmount)}\n`;
        }
        
        // Tambah redeem jika ada
        if (redeemAmount > 0) {
            message += `Redeem: -Rp ${POSModule.formatCurrency(redeemAmount)}\n`;
        }
        
        message += `Total: Rp ${POSModule.formatCurrency(totalAmount)}\n`;
        
        // Tambah informasi pembayaran tunai jika payment type cash
        if (paymentType === 'cash' && cashReceived && cashChange !== undefined) {
            message += `Tunai: Rp ${POSModule.formatCurrency(cashReceived)}\n`;
            message += `Kembali: Rp ${POSModule.formatCurrency(cashChange)}\n`;
        }
        
        message += `\nüéØ *INFO POINTS:*\n` +
                   `üìä Sebelum: ${pointSebelum} points\n` +
                   `üéÅ Dapat: +${pointDidapat} points\n` +
                   `üîÑ Redeem: -${redeemPoints} points\n` +
                   `üìà Sekarang: ${pointSaatIni} points\n\n` +
                   `‚ú® *Terima kasih atas kunjungan Anda!* ‚ú®\n` +
                   `üîÑ Tukarkan points Anda di transaksi berikutnya!`;
        
        console.log('üí¨ WhatsApp message prepared:', message);
        
       // Coba kirim via WhatsApp API
if (!appConfig.wahaUrl || !appConfig.wahaXApiKey) {
    throw new Error('WhatsApp configuration not available');
}

const response = await fetch(`${appConfig.wahaUrl}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-Api-Key': appConfig.wahaXApiKey
    },
    body: JSON.stringify({
        session: appConfig.wahaSession,
        chatId: formattedPhone,
        text: message
    })
});
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå WhatsApp API error:', errorText);
            throw new Error(`WhatsApp API error: ${response.status} ${errorText}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ WhatsApp receipt sent successfully:', result);
        
    } catch (error) {
        console.error('‚ùå WhatsApp error:', error);
        // Jangan tampilkan error ke user karena ini non-critical
        // Coba fallback ke WhatsApp link
        await sendWhatsAppFallback(phoneNumber, orderNo, totalAmount, items);
    }
}
// =============================================
// FALLBACK WHATSAPP FUNCTION
// =============================================
async function sendWhatsAppFallback(phoneNumber, orderNo, totalAmount, items) {
    try {
        // Format pesan sederhana untuk fallback
        const itemsText = items.map(item => 
            `${item.nama_produk} ${item.quantity}x${POSModule.formatCurrency(item.harga_jual)}`
        ).join(', ');
        
        const simpleMessage = `Babeh Barbershop - Order: ${orderNo} - Total: Rp ${POSModule.formatCurrency(totalAmount)} - Items: ${itemsText}`;
        const encodedMessage = encodeURIComponent(simpleMessage);
        
        // Format nomor untuk WhatsApp link
        const cleanPhone = phoneNumber.replace(/^0/, '62');
        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
        
        console.log('üì± Fallback WhatsApp URL:', whatsappUrl);
        
        // Buka WhatsApp di tab baru
        window.open(whatsappUrl, '_blank');
        
    } catch (fallbackError) {
        console.error('‚ùå WhatsApp fallback also failed:', fallbackError);
    }
}

// =============================================
// SIMPLIFIED WHATSAPP FOR OTP (FIXED)
// =============================================
async function sendWhatsAppMessage() {
    try {
        if (!currentTransaction || !currentTransaction.customer || !currentTransaction.customer.phone) {
            console.warn('‚ùå No customer phone available');
            return;
        }
        
        const phone = currentTransaction.customer.phone;
        const receiptText = generateReceiptText();
        
        console.log('üì± Sending WhatsApp to:', phone);
        
        // Format nomor untuk WhatsApp link
        const cleanPhone = phone.replace(/^0/, '62');
        const message = encodeURIComponent(receiptText);
        const whatsappUrl = `https://wa.me/${cleanPhone}?text=${message}`;
        
        console.log('üîó WhatsApp URL:', whatsappUrl);
        
        // Buka WhatsApp di tab baru
        window.open(whatsappUrl, '_blank');
        
        alert('Nota telah dibuka di WhatsApp! Silakan kirim manual ke customer.');
        
    } catch (error) {
        console.error('‚ùå Error in sendWhatsAppMessage:', error);
        alert('Gagal membuka WhatsApp. Silakan salin nota dan kirim manual.');
    }
}

// =============================================
// GENERATE RECEIPT TEXT (FIXED)
// =============================================
function generateReceiptText() {
    if (!currentTransaction) {
        console.error('‚ùå No current transaction');
        return 'No transaction data';
    }
    
    const now = new Date();
    const dateTime = now.toLocaleDateString('id-ID', {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    let receipt = `BABEH BARBERSHOP\n`;
    receipt += `Outlet: ${currentOutlet?.name || 'Rempoa'}\n`;
    receipt += `================================\n`;
    receipt += `Tanggal: ${dateTime}\n`;
    receipt += `Order ID: ${currentTransaction.id}\n`;
    receipt += `Kasir: ${currentUser?.name || 'Admin'}\n`;
    
    if (currentTransaction.servedBy) {
        receipt += `Dilayani: ${currentTransaction.servedBy.name}\n`;
    }
    
    if (currentTransaction.customer && currentTransaction.customer.id !== 0) {
        receipt += `Customer: ${currentTransaction.customer.name}\n`;
        receipt += `Member ID: ${currentTransaction.customer.memberId}\n`;
    }
    
    receipt += `================================\n`;
    
    // Items
    currentTransaction.items.forEach((item, index) => {
        receipt += `${index + 1}. ${item.name}\n`;
        receipt += `   ${item.quantity} x Rp ${POSModule.formatCurrency(item.price)} = Rp ${POSModule.formatCurrency(item.quantity * item.price)}\n`;
    });
    
    receipt += `================================\n`;
    
    // Totals
    receipt += `Subtotal: Rp ${POSModule.formatCurrency(currentTransaction.subtotal)}\n`;
    
    if (currentTransaction.discount && currentTransaction.discount.amount > 0) {
        receipt += `Discount: -Rp ${POSModule.formatCurrency(currentTransaction.discount.amount)}\n`;
    }
    
    if (currentTransaction.redeem && currentTransaction.redeem.amount > 0) {
        receipt += `Redeem: -Rp ${POSModule.formatCurrency(currentTransaction.redeem.amount)}\n`;
    }
    
    receipt += `Total: Rp ${POSModule.formatCurrency(currentTransaction.total)}\n`;
    
    // Payment info
    receipt += `================================\n`;
    receipt += `Pembayaran: ${getPaymentMethodText(currentTransaction.paymentMethod)}\n`;
    
    if (currentTransaction.paymentMethod === 'cash' && currentTransaction.cashReceived) {
        receipt += `Tunai: Rp ${POSModule.formatCurrency(currentTransaction.cashReceived)}\n`;
        receipt += `Kembali: Rp ${POSModule.formatCurrency(currentTransaction.cashChange || 0)}\n`;
    }
    
    receipt += `================================\n`;
    receipt += `Terima kasih atas kunjungan Anda\n`;
    receipt += `www.babehbarbershop.com\n`;
    
    return receipt;
}

// =============================================
// GET PAYMENT METHOD TEXT
// =============================================
function getPaymentMethodText(method) {
    switch(method) {
        case 'cash': return 'Tunai';
        case 'qris_dinamis': return 'QRIS Dinamis';
        case 'qris_static': return 'QRIS Statis';
        case 'transfer_bank': return 'Transfer Bank';
        default: return method || 'Unknown';
    }
}
        // =============================================
        // TRANSACTIONS MODULE - DIPERBAIKI DENGAN SISTEM POINT BARU
        // =============================================
        const TransactionsModule = {
            transactions: [],

            async loadTransactions() {
                try {
                    showLoading(true);
                    const user = Auth.getCurrentUser();
                    
                    const filters = {
                        date: document.getElementById('filterDate').value || null,
                        status: document.getElementById('filterStatus').value || null,
                        search: document.getElementById('searchOrder').value || null
                    };
                    
                    this.transactions = await Database.getTransactions(user.outlet, filters);
                    this.renderTransactions();
                } catch (error) {
                    console.error('Error loading transactions:', error);
                    showNotification('Error loading transactions', 'error');
                } finally {
                    showLoading(false);
                }
            },

            renderTransactions() {
                const transactionsTable = document.getElementById('transactionsTable');
                
                if (this.transactions.length === 0) {
                    transactionsTable.innerHTML = `
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">
                                Tidak ada transaksi ditemukan
                            </td>
                        </tr>
                    `;
                    return;
                }

                transactionsTable.innerHTML = this.transactions.map(transaction => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2 md:p-3 font-mono text-xs md:text-sm">${transaction.order_no || '-'}</td>
                        <td class="p-2 md:p-3">
                            <div class="text-xs md:text-sm">${transaction.order_date || '-'}</div>
                            <div class="text-xs text-gray-500">${transaction.order_time || ''}</div>
                        </td>
                        <td class="p-2 md:p-3 text-xs md:text-sm">${transaction.customer_name || 'Umum'}</td>
                        <td class="p-2 md:p-3 text-right font-semibold text-xs md:text-sm">
    Rp ${this.formatCurrency(transaction.correct_total || 0)}
</td>
                        <td class="p-2 md:p-3">
                            <span class="px-2 py-1 rounded-full text-xs ${
                                transaction.payment_type === 'cash' ? 'bg-green-100 text-green-800' :
                                transaction.payment_type === 'qris_dinamis' ? 'bg-blue-100 text-blue-800' :
                                 transaction.payment_type === 'qris_static_bsi' ? 'bg-yellow-100 text-blue-800' :
                                transaction.payment_type === 'qris_static_dana' ? 'bg-red-100 text-blue-800' : 
                                transaction.payment_type === 'transfer_bank' ? 'bg-purple-100 text-purple-800' :
                                'bg-orange-100 text-orange-800'
                            }">
                                ${transaction.payment_type || 'cash'}
                            </span>
                        </td>
                        <td class="p-2 md:p-3">
                            <span class="px-2 py-1 rounded-full text-xs ${
                                transaction.status === 'completed' ? 'bg-green-100 text-green-800' :
                                transaction.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                transaction.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                'bg-gray-100 text-gray-800'
                            }">
                                ${transaction.status || 'completed'}
                            </span>
                        </td>
                        <td class="p-2 md:p-3">
                            <div class="flex space-x-1 md:space-x-2">
                                <button onclick="TransactionsModule.viewTransactionDetails('${transaction.order_no}')" 
                                        class="text-blue-600 hover:text-blue-800 text-xs md:text-sm">
                                    Detail
                                </button>
                                <button onclick="TransactionsModule.printTransaction('${transaction.order_no}')" 
                                        class="text-green-600 hover:text-green-800 text-xs md:text-sm">
                                    Print
                                </button>
                                ${transaction.status === 'completed' ? `
                                <button onclick="TransactionsModule.cancelTransaction('${transaction.order_no}')" 
                                        class="text-red-600 hover:text-red-800 text-xs md:text-sm">
                                    Cancel
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            },

            async viewTransactionDetails(orderNo) {
                try {
                    const transactionItems = await Database.getTransactionItems(orderNo);
                    const transactionOrder = await Database.getTransactionOrder(orderNo);
                    
                    if (transactionItems.length === 0) return;

                    const firstItem = transactionItems[0];
                    let details = `Order No: ${firstItem.order_no}\n`;
                    details += `Tanggal: ${firstItem.order_date} ${firstItem.order_time}\n`;
                    details += `Customer: ${firstItem.customer_name || 'Umum'}\n`;
                    details += `Kasir: ${firstItem.kasir || '-'}\n`;
                    details += `Pelayan: ${firstItem.serve_by || '-'}\n`;
                    details += `Payment: ${firstItem.payment_type || 'cash'}\n`;
                    details += `Status: ${firstItem.status || 'completed'}\n`;
                    
                    if (transactionOrder) {
                        details += `Discount: Rp ${this.formatCurrency(transactionOrder.discount_amount || 0)}\n`;
                        details += `Redeem: ${transactionOrder.redeem_qty || 0} points\n`;
                        details += `Points: ${transactionOrder.point || 0} points\n`;
                        details += `Subtotal: Rp ${this.formatCurrency(transactionOrder.subtotal_amount || 0)}\n`;
                        details += `Total: Rp ${this.formatCurrency(transactionOrder.total_amount || 0)}\n`;
                        
                        // PERBAIKAN 2: Tampilkan informasi tunai dan kembali untuk copy receipt
                        if (transactionOrder.payment_type === 'cash' && transactionOrder.cash_received) {
                            details += `Tunai: Rp ${this.formatCurrency(transactionOrder.cash_received)}\n`;
                            details += `Kembali: Rp ${this.formatCurrency(transactionOrder.cash_change || 0)}\n`;
                        }
                    }
                    
                    details += `\nItems:\n`;
                    
                    transactionItems.forEach((item, index) => {
                        details += `${index + 1}. ${item.item_name} - ${item.qty} x Rp ${this.formatCurrency(item.harga_jual)} = Rp ${this.formatCurrency(item.amount)}\n`;
                    });
                    
                    alert('Detail Transaksi:\n' + details);

                } catch (error) {
                    console.error('Error viewing transaction details:', error);
                    showNotification('Error loading transaction details', 'error');
                }
            },

            async printTransaction(orderNo) {
                try {
                    showLoading(true);
                    
                    // Get transaction details
                   const transactionItems = await Database.getTransactionItems(orderNo);
const transactionOrder = await Database.getTransactionOrder(orderNo);

// ‚≠ê‚≠ê PERBAIKAN: transactionOrder ADALAH ARRAY ‚≠ê‚≠ê
const orderData = transactionOrder[0]; // Ambil element pertama

if (transactionItems.length === 0 || !orderData) {
    showNotification('Transaksi tidak ditemukan', 'error');
    return;
}

const firstItem = transactionItems[0];

// PERBAIKAN 2: Ambil data cash yang benar dari transaksi_order, bukan dari transaksi_detail
let cashReceived = 0;
let cashChange = 0;

// Gunakan data cash dari transaksi_order jika tersedia
if (orderData && orderData.payment_type === 'cash') {
    cashReceived = orderData.cash_received || orderData.total_amount;
    cashChange = orderData.cash_change || 0;
} else if (firstItem.payment_type === 'cash') {
    // Fallback ke logika lama jika data tidak tersedia di transaksi_order
    cashReceived = orderData ? orderData.total_amount : 0;
    cashChange = 0;
}

// Get customer points info untuk copy receipt
let pointInfo = { point_sebelum: 0, point: 0, redeem: 0, point_saat_ini: 0 };

// ‚≠ê‚≠ê PERBAIKAN: PAKAI orderData BUKAN transactionOrder ‚≠ê‚≠ê
if (orderData && orderData.customer_id) {
    console.log('üîç Looking for customer by ID:', orderData.customer_id);
    
    const { data: customer } = await supabase
        .from('membercard')
        .select('point_sebelum, point, redeem, point_saat_ini')
        .eq('id_member', orderData.customer_id)
        .single();
        
    if (customer) {
        pointInfo = customer;
        console.log('üí∞ CUSTOMER POINTS FOUND:', pointInfo);
    } else {
        console.log('‚ùå Customer not found by ID:', orderData.customer_id);
    }
} else {
    console.log('‚ÑπÔ∏è No customer_id found:', {
        hasOrderData: !!orderData,
        customer_id: orderData?.customer_id,
        customer_name: orderData?.customer_name
    });
}

const transactionData = {
    orderNo: orderNo,
    date: orderData.order_date || firstItem.order_date,
    time: orderData.order_time || firstItem.order_time,
    customerName: orderData.customer_name || firstItem.customer_name || 'Umum',
    items: transactionItems.map(item => ({
        nama_produk: item.item_name,
        harga_jual: item.harga_jual,
        quantity: item.qty,
        total: item.amount
    })),
    total: orderData ? orderData.total_amount : transactionItems.reduce((sum, item) => sum + (item.amount || 0), 0),
    paymentType: orderData.payment_type || firstItem.payment_type || 'cash',
    // PERBAIKAN 2: Gunakan data cash yang sudah diperbaiki
    cashReceived: cashReceived,
    cashChange: cashChange,
    servedBy: orderData.serve_by || firstItem.serve_by || '-',
    pointsEarned: orderData ? orderData.point : 0,
    discountAmount: orderData ? orderData.discount_amount : 0,
    redeemAmount: orderData ? orderData.redeem_amount : 0,
    pointSebelum: pointInfo.point_sebelum || 0,
    pointDidapat: pointInfo.point || 0,
    redeemPoints: orderData ? orderData.redeem_qty : 0,
    pointSaatIni: pointInfo.point_saat_ini || 0,
    isReprint: true // INI COPY RECEIPT
};

// Debug sebelum print
console.log('üéØ FINAL TRANSACTION DATA WITH POINTS:');
console.log('  - customerName:', transactionData.customerName);
console.log('  - customer_id:', orderData.customer_id);
console.log('  - pointSebelum:', transactionData.pointSebelum);
console.log('  - pointDidapat:', transactionData.pointDidapat);
console.log('  - pointSaatIni:', transactionData.pointSaatIni);

// Print receipt
await PrinterModule.printReceipt(transactionData);
                    
                    showNotification('Copy receipt berhasil dicetak', 'success');
                    
                } catch (error) {
                    console.error('Error printing transaction:', error);
                    showNotification('Error printing receipt: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            },

            async cancelTransaction(orderNo) {
                try {
                    showLoading(true);
                    
                    // Get transaction details untuk OTP message
                    const transactionItems = await Database.getTransactionItems(orderNo);
                    const transactionOrder = await Database.getTransactionOrder(orderNo);
                    
                    if (transactionItems.length === 0) {
                        showNotification('Transaksi tidak ditemukan', 'error');
                        return;
                    }

                    const firstItem = transactionItems[0];
                    
                    // Get customer point info untuk OTP message
                    let pointInfo = { point_sebelum: 0, point: 0, redeem: 0, point_saat_ini: 0 };
                    if (transactionOrder && transactionOrder.customer_id) {
                        const { data: customer } = await supabase
                            .from('membercard')
                            .select('point_sebelum, point, redeem, point_saat_ini')
                            .eq('id_member', transactionOrder.customer_id)
                            .single();
                        if (customer) {
                            pointInfo = customer;
                        }
                    }

                    const transactionDetails = {
                        outlet: firstItem.outlet,
                        customer_name: firstItem.customer_name,
                        items: transactionItems,
                        total_amount: transactionOrder ? transactionOrder.total_amount : 0,
                        payment_type: firstItem.payment_type,
                        discount_amount: transactionOrder ? transactionOrder.discount_amount : 0,
                        redeem_amount: transactionOrder ? transactionOrder.redeem_amount : 0,
                        points_earned: transactionOrder ? transactionOrder.point : 0,
                        serve_by: firstItem.serve_by,
                        point_sebelum: pointInfo.point_sebelum,
                        point_didapat: pointInfo.point,
                        redeem_points: transactionOrder ? transactionOrder.redeem_qty : 0,
                        point_saat_ini: pointInfo.point_saat_ini,
                        // PERBAIKAN 1: Tambah informasi lengkap untuk OTP message
                        kasir: firstItem.kasir,
                        order_date: firstItem.order_date,
                        order_time: firstItem.order_time,
                        subtotal_amount: transactionOrder ? transactionOrder.subtotal_amount : 0,
                        cash_received: transactionOrder ? transactionOrder.cash_received : null,
                        cash_change: transactionOrder ? transactionOrder.cash_change : null
                    };
                    
                    // Kirim OTP terlebih dahulu dengan informasi lengkap
                    await OTPSystem.sendOTP(orderNo, transactionDetails);
                    
                    // Show OTP modal
                    showOTPModal(orderNo);
                    
                } catch (error) {
                    console.error('Error sending OTP:', error);
                    showNotification('Gagal mengirim OTP: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            },

            async processCancellation(orderNo) {
                try {
                    showLoading(true);
                    
                    // Get transaction details untuk restore points
                    const transactionItems = await Database.getTransactionItems(orderNo);
                    const transactionOrder = await Database.getTransactionOrder(orderNo);
                    
                    if (transactionItems.length === 0) {
                        showNotification('Transaksi tidak ditemukan', 'error');
                        return;
                    }

                    const firstItem = transactionItems[0];
                    const customerId = firstItem.customer_id;
                    
                    // Restore customer points jika ada customer - SISTEM BARU
                    if (customerId && transactionOrder) {
                        const totalPoints = transactionOrder.point || 0;
                        const redeemPoints = transactionOrder.redeem_qty || 0;
                        await Database.restoreCustomerPoints(customerId, totalPoints, redeemPoints);
                    }
                    
                    // Cancel transaction in database
                    await Database.cancelTransaction(orderNo);
                    
                    // Restore stock for cancelled items
                    await POSModule.restoreStockForOrder(orderNo);
                    
                    showNotification(`Transaksi ${orderNo} berhasil dibatalkan`, 'success');
                    
                    // Reload transactions
                    await this.loadTransactions();
                    
                } catch (error) {
                    console.error('Error cancelling transaction:', error);
                    showNotification('Error cancelling transaction: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('id-ID').format(amount);
            }
        };

// =============================================
// PRINTER MODULE - FIXED VERSION (NO DUPLICATE)
// =============================================
const PrinterModule = {
    serverUrl: 'http://192.168.1.2:8080',
    template: {
        shopName: 'Babeh Barbershop',
        shopOutlet: 'Rempoa',
        shopAddress: 'Jl. Contoh No. 123',
        footerMessage: 'Terima kasih atas kunjungan Anda',
        includeServedBy: true,
        includeCustomer: true,
        includePoints: true
    },
    webSerialConnected: false,
    btServiceEnabled: false,

    async init() {
        await this.loadTemplate();
        const savedPrinterType = localStorage.getItem('printerType') || 'bridge';
        this.selectPrinterType(savedPrinterType);
    },

    async loadTemplate() {
        try {
            const savedTemplate = localStorage.getItem('printerTemplate');
            if (savedTemplate) {
                this.template = { ...this.template, ...JSON.parse(savedTemplate) };
                
                document.getElementById('shopName').value = this.template.shopName;
                document.getElementById('shopOutlet').value = this.template.shopOutlet;
                document.getElementById('shopAddress').value = this.template.shopAddress;
                document.getElementById('footerMessage').value = this.template.footerMessage;
                document.getElementById('includeServedBy').checked = this.template.includeServedBy;
                document.getElementById('includeCustomer').checked = this.template.includeCustomer;
                document.getElementById('includePoints').checked = this.template.includePoints;
            }

            const savedUrl = localStorage.getItem('printerServerUrl');
            if (savedUrl) {
                this.serverUrl = savedUrl;
                document.getElementById('printerServerUrl').value = savedUrl;
            }

            this.webSerialConnected = false;
            this.btServiceEnabled = localStorage.getItem('btService_enabled') === 'true';

        } catch (error) {
            console.error('Error loading template:', error);
        }
    },

    selectPrinterType(type) {
        currentPrinterType = type;
        
        const btnBridge = document.getElementById('btnBridge');
        const btnWebSerial = document.getElementById('btnWebSerial');
        const btnBtService = document.getElementById('btnBtService');
        const bridgeSettings = document.getElementById('bridgeSettings');
        const webSerialSettings = document.getElementById('webSerialSettings');
        const btServiceSettings = document.getElementById('btServiceSettings');
        
        [btnBridge, btnWebSerial, btnBtService].forEach(btn => {
            btn.classList.add('border-gray-300', 'bg-gray-100', 'text-gray-600');
            btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
        });
        
        [bridgeSettings, webSerialSettings, btServiceSettings].forEach(setting => {
            setting?.classList.add('hidden');
        });
        
        if (type === 'bridge') {
            btnBridge.classList.remove('border-gray-300', 'bg-gray-100', 'text-gray-600');
            btnBridge.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
            bridgeSettings.classList.remove('hidden');
        } else if (type === 'webserial') {
            btnWebSerial.classList.remove('border-gray-300', 'bg-gray-100', 'text-gray-600');
            btnWebSerial.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
            webSerialSettings.classList.remove('hidden');
        } else if (type === 'btservice') {
            btnBtService.classList.remove('border-gray-300', 'bg-gray-100', 'text-gray-600');
            btnBtService.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
            btServiceSettings?.classList.remove('hidden');
        }
        
        localStorage.setItem('printerType', type);
        this.checkStatus();
    },

    async checkStatus() {
        if (currentPrinterType === 'bridge') {
            await this.checkBridgeStatus();
        } else if (currentPrinterType === 'webserial') {
            await this.checkWebSerialStatus();
        } else if (currentPrinterType === 'btservice') {
            await this.checkBtServiceStatus();
        }
    },

    async checkBridgeStatus() {
        try {
            showLoading(true);
            const response = await fetch(`${this.serverUrl}/health`);
            const data = await response.json();
            
            const statusDiv = document.getElementById('printerStatus');
            if (data.status === 'ok') {
                statusDiv.innerHTML = `
                    <p class="text-green-600 font-semibold">Status: Connected</p>
                    <p class="text-sm">Printer: ${data.printer_name || 'Unknown'}</p>
                    <p class="text-sm">Bluetooth: ${data.bluetooth_enabled ? 'Enabled' : 'Disabled'}</p>
                `;
            } else {
                statusDiv.innerHTML = `<p class="text-red-600">Status: Error - ${data.message || 'Unknown error'}</p>`;
            }
        } catch (error) {
            const statusDiv = document.getElementById('printerStatus');
            statusDiv.innerHTML = `<p class="text-red-600">Status: Connection failed - ${error.message}</p>`;
        } finally {
            showLoading(false);
        }
    },

    async checkWebSerialStatus() {
        const statusDiv = document.getElementById('webSerialStatus');
        // ‚≠ê‚≠ê SIMPLE FIX: Selalu show "Not Connected" kecuali benar-benar connected
    if (this.webSerialConnected && webSerialPort) {
        statusDiv.innerHTML = `
            <p class="text-green-600 font-semibold">Status: Connected</p>
            <p class="text-sm">Web Serial: Ready</p>
        `;
    } else {
        // ‚≠ê‚≠ê PASTIKAN SELALU DISCONNECTED PADA AWAL
        this.webSerialConnected = false;
        statusDiv.innerHTML = `
            <p class="text-yellow-600">Status: Not connected</p>
            <p class="text-sm">Click "Connect Printer" to connect</p>
        `;
    }
},

    async checkBtServiceStatus() {
        const statusDiv = document.getElementById('btServiceStatus');
        if (this.btServiceEnabled) {
            statusDiv.innerHTML = `
                <p class="text-green-600 font-semibold">Status: Ready</p>
                <p class="text-sm">BT Print Service: Active</p>
                <p class="text-xs text-gray-600">Pastikan aplikasi terinstall</p>
            `;
        } else {
            statusDiv.innerHTML = `
                <p class="text-yellow-600">Status: Not configured</p>
                <p class="text-sm">Click "Test BT Service" to verify</p>
            `;
        }
    },

    async connectWebSerial() {
        try {
            console.log("üîå Meminta akses ke printer Web Serial...");
            
            if (!('serial' in navigator)) {
                throw new Error('Web Serial API tidak didukung di browser ini. Gunakan Chrome/Edge versi terbaru.');
            }
            
            const port = await navigator.serial.requestPort();
            const baudRate = parseInt(document.getElementById('baudRate').value) || 9600;
            
            await port.open({ baudRate: baudRate });
            console.log("‚úÖ Port Web Serial terbuka!");
            
            webSerialPort = port;
            this.webSerialConnected = true;
            
            localStorage.setItem('webSerial_connected', 'true');
            localStorage.setItem('webSerial_baudRate', baudRate.toString());
            localStorage.setItem('printerType', 'webserial');
            
            console.log('üíæ Printer state saved to localStorage');
            
            await this.checkWebSerialStatus();
            showNotification('Printer Web Serial berhasil terhubung!', 'success');
            
        } catch (error) {
            console.error('‚ùå Error connecting Web Serial:', error);
            localStorage.setItem('webSerial_connected', 'false');
            showNotification('Error connecting printer: ' + error.message, 'error');
            await this.checkWebSerialStatus();
        }
    },

    async testBtService() {
        try {
            showLoading(true);
            
            const testData = {
                orderNo: 'TEST-001',
                date: DateTimeUtils.getCurrentWIBDate(),
                time: DateTimeUtils.getCurrentWIBTime(),
                customerName: 'Test Customer',
                servedBy: 'Test Barber',
                items: [
                    { 
                        nama_produk: 'Haircut Premium', 
                        harga_jual: 50000, 
                        quantity: 1, 
                        total: 50000 
                    },
                    { 
                        nama_produk: 'Hair Wash', 
                        harga_jual: 15000, 
                        quantity: 1, 
                        total: 15000 
                    }
                ],
                total: 65000,
                paymentType: 'cash',
                cashReceived: 100000,
                cashChange: 35000,
                pointsEarned: 6,
                discountAmount: 5000,
                redeemAmount: 10000,
                pointSebelum: 100,
                pointDidapat: 6,
                redeemPoints: 5,
                pointSaatIni: 101,
                isReprint: false
            };

            console.log('üß™ TEST BT SERVICE');
            console.log('Transaction Data:', testData);

            const success = await this.printViaBtService(testData);
            
            if (success) {
                this.btServiceEnabled = true;
                localStorage.setItem('btService_enabled', 'true');
                showNotification('‚úÖ Test print berhasil dikirim ke BT Service!', 'success');
                await this.checkBtServiceStatus();
            } else {
                throw new Error('Print gagal');
            }
            
        } catch (error) {
            console.error('‚ùå Error testing BT Service:', error);
            showNotification('‚ùå Gagal: ' + error.message, 'error');
            await this.checkBtServiceStatus();
        } finally {
            showLoading(false);
        }
    },

    async testPrint() {
        if (currentPrinterType === 'bridge') {
            await this.testPrintBridge();
        } else if (currentPrinterType === 'webserial') {
            await this.testPrintWebSerial();
        } else if (currentPrinterType === 'btservice') {
            await this.testPrintBtService();
        }
    },

    async testPrintBridge() {
        try {
            showLoading(true);
            const response = await fetch(`${this.serverUrl}/print/test`);
            const data = await response.json();
            
            if (data.success) {
                showNotification('Test print successful!', 'success');
            } else {
                showNotification('Test print failed: ' + data.message, 'error');
            }
        } catch (error) {
            showNotification('Test print error: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    },

    async testPrintWebSerial() {
        if (!this.webSerialConnected) {
            showNotification('Printer belum terhubung. Klik "Connect Printer" terlebih dahulu.', 'error');
            return;
        }

        try {
            showLoading(true);
            
            const testData = {
                orderNo: 'TEST-001',
                date: DateTimeUtils.getCurrentWIBDate(),
                time: DateTimeUtils.getCurrentWIBTime(),
                customerName: 'Test Customer',
                servedBy: 'Test Barber',
                items: [
                    { 
                        nama_produk: 'Haircut Premium', 
                        harga_jual: 50000, 
                        quantity: 1, 
                        total: 50000 
                    },
                    { 
                        nama_produk: 'Hair Wash', 
                        harga_jual: 15000, 
                        quantity: 1, 
                        total: 15000 
                    }
                ],
                total: 65000,
                paymentType: 'cash',
                cashReceived: 100000,
                cashChange: 35000,
                pointsEarned: 6,
                discountAmount: 5000,
                redeemAmount: 10000,
                pointSebelum: 100,
                pointDidapat: 6,
                redeemPoints: 5,
                pointSaatIni: 101,
                isReprint: false
            };

            const testContent = this.generateReceiptText(testData);
            await this.printText(testContent);
            
            showNotification('Test print berhasil dikirim ke printer!', 'success');
        } catch (error) {
            console.error('‚ùå Error test printing:', error);
            showNotification('Error test printing: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    },

    async testPrintBtService() {
        try {
            showLoading(true);
            
            const testData = {
                orderNo: 'TEST-001',
                date: DateTimeUtils.getCurrentWIBDate(),
                time: DateTimeUtils.getCurrentWIBTime(),
                customerName: 'Test Customer',
                servedBy: 'Test Barber',
                items: [
                    { 
                        nama_produk: 'Haircut Premium', 
                        harga_jual: 50000, 
                        quantity: 1, 
                        total: 50000 
                    },
                    { 
                        nama_produk: 'Hair Wash', 
                        harga_jual: 15000, 
                        quantity: 1, 
                        total: 15000 
                    }
                ],
                total: 65000,
                paymentType: 'cash',
                cashReceived: 100000,
                cashChange: 35000,
                pointsEarned: 6,
                isReprint: true
            };

            const success = await this.printViaBtService(testData);
            
            if (success) {
                showNotification('‚úÖ Test print berhasil dikirim!', 'success');
            } else {
                showNotification('‚ùå Test print gagal', 'error');
            }
            
        } catch (error) {
            console.error('‚ùå Error test printing:', error);
            showNotification('‚ùå Error test printing: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    },

    async printReceipt(transactionData) {
        if (currentPrinterType === 'bridge') {
            return await this.printReceiptBridge(transactionData);
        } else if (currentPrinterType === 'webserial') {
            return await this.printReceiptWebSerial(transactionData);
        } else if (currentPrinterType === 'btservice') {
            return await this.printReceiptBtService(transactionData);
        }
    },

    async printReceiptBridge(transactionData) {
        try {
            const printRequest = {
                shopName: this.template.shopName,
                shopOutlet: this.template.shopOutlet,
                shopAddress: this.template.shopAddress,
                transactionId: transactionData.orderNo,
                transactionDate: transactionData.date + ' ' + transactionData.time,
                customerName: transactionData.customerName,
                servedBy: transactionData.servedBy,
                items: transactionData.items.map(item => ({
                    name: item.nama_produk,
                    quantity: item.quantity,
                    price: 'Rp ' + this.formatCurrency(item.harga_jual),
                    total: 'Rp ' + this.formatCurrency(item.total)
                })),
                totalAmount: 'Rp ' + this.formatCurrency(transactionData.total),
                paymentType: transactionData.paymentType,
                cashReceived: transactionData.cashReceived ? 'Rp ' + this.formatCurrency(transactionData.cashReceived) : null,
                cashChange: transactionData.cashChange ? 'Rp ' + this.formatCurrency(transactionData.cashChange) : null,
                pointsEarned: transactionData.pointsEarned,
                discountAmount: transactionData.discountAmount ? 'Rp ' + this.formatCurrency(transactionData.discountAmount) : null,
                redeemAmount: transactionData.redeemAmount ? 'Rp ' + this.formatCurrency(transactionData.redeemAmount) : null,
                pointSebelum: transactionData.pointSebelum,
                pointDidapat: transactionData.pointDidapat,
                redeemPoints: transactionData.redeemPoints,
                pointSaatIni: transactionData.pointSaatIni,
                isReprint: transactionData.isReprint || false,
                footerMessage: this.template.footerMessage
            };

            const response = await fetch(`${this.serverUrl}/print/receipt`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(printRequest)
            });

            const data = await response.json();
            return data.success;
        } catch (error) {
            console.error('Print error:', error);
            return false;
        }
    },

    async printReceiptWebSerial(transactionData) {
        if (!this.webSerialConnected) {
            console.warn('Web Serial printer not connected');
            return false;
        }

        try {
            const receiptText = this.generateReceiptText(transactionData);
            await this.printText(receiptText);
            return true;
        } catch (error) {
            console.error('‚ùå Error printing receipt:', error);
            return false;
        }
    },

    async printReceiptBtService(transactionData) {
        try {
            return await this.printViaBtService(transactionData);
        } catch (error) {
            console.error('BT Service print error:', error);
            return false;
        }
    },

    async printText(text) {
        if (currentPrinterType === 'bridge') {
            await this.printViaBridge(text);
        } else if (currentPrinterType === 'webserial') {
            await this.printViaWebSerial(text);
        } else if (currentPrinterType === 'btservice') {
            const transactionData = this.parseTextToTransactionData(text);
            await this.printViaBtService(transactionData);
        }
    },

    async printViaBridge(text) {
        const serverUrl = document.getElementById('printerServerUrl').value;
        
        try {
            const response = await fetch(serverUrl + '/print', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            });

            if (!response.ok) {
                throw new Error('Failed to print via bridge');
            }
        } catch (error) {
            throw new Error('Bridge printing error: ' + error.message);
        }
    },

    async printViaWebSerial(text) {
        if (!webSerialPort) {
            throw new Error('Web Serial not connected');
        }

        try {
            const encoder = new TextEncoder();
            const writer = webSerialPort.writable.getWriter();
            
            await writer.write(encoder.encode(text));
            writer.releaseLock();
        } catch (error) {
            throw new Error('Web Serial printing error: ' + error.message);
        }
    },

    async printViaBtService(transactionData) {
        return new Promise((resolve) => {
            try {
                const receiptText = this.generateReceiptText(transactionData);
                
                console.log('üì§ BT Service - RAW ESC/POS:');
                console.log('Content:', receiptText);
                console.log('Length:', receiptText.length);
                
                const btServiceData = {
                    type: 'raw_text',
                    content: receiptText,
                    raw_escpos: true,
                    timestamp: new Date().toLocaleString('id-ID')
                };

                const encodedData = encodeURIComponent(JSON.stringify(btServiceData));
                const deepLink = `babehbtprint://print?data=${encodedData}`;
                
                console.log('üîó Deep Link Length:', deepLink.length);
                
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = deepLink;
                document.body.appendChild(iframe);
                
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    console.log('‚úÖ RAW ESC/POS berhasil dikirim ke BT Service');
                    resolve(true);
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error in BT Service print:', error);
                resolve(false);
            }
        });
    },

    saveTemplate() {
        this.template.shopName = document.getElementById('shopName').value;
        this.template.shopOutlet = document.getElementById('shopOutlet').value;
        this.template.shopAddress = document.getElementById('shopAddress').value;
        this.template.footerMessage = document.getElementById('footerMessage').value;
        this.template.includeServedBy = document.getElementById('includeServedBy').checked;
        this.template.includeCustomer = document.getElementById('includeCustomer').checked;
        this.template.includePoints = document.getElementById('includePoints').checked;
        
        localStorage.setItem('printerTemplate', JSON.stringify(this.template));
        
        this.serverUrl = document.getElementById('printerServerUrl').value;
        localStorage.setItem('printerServerUrl', this.serverUrl);
        
        showNotification('Template saved successfully!', 'success');
    },

    previewReceipt() {
        const previewData = {
            orderNo: 'PREVIEW-001',
            date: DateTimeUtils.getCurrentWIBDate(),
            time: DateTimeUtils.getCurrentWIBTime(),
            customerName: 'Customer Preview',
            servedBy: 'Barberman Preview',
            items: [
                { 
                    nama_produk: 'Haircut Premium', 
                    harga_jual: 50000, 
                    quantity: 1, 
                    total: 50000 
                },
                { 
                    nama_produk: 'Hair Wash', 
                    harga_jual: 15000, 
                    quantity: 1, 
                    total: 15000 
                }
            ],
            total: 65000,
            paymentType: 'cash',
            cashReceived: 100000,
            cashChange: 35000,
            pointsEarned: 6,
            discountAmount: 5000,
            redeemAmount: 10000,
            pointSebelum: 100,
            pointDidapat: 6,
            redeemPoints: 5,
            pointSaatIni: 101,
            isReprint: false
        };

        const receiptText = this.generateReceiptText(previewData);
        alert('Preview Receipt:\n\n' + receiptText);
    },

    // ‚≠ê‚≠ê INI SATU-SATUNYA generateReceiptText ‚≠ê‚≠ê
    generateReceiptText(transactionData) {
        const lines = [];
        const ESC = '\x1B';
        const LF = '\x0A';
        const BOLD_ON = ESC + 'E' + '\x01';
        const BOLD_OFF = ESC + 'E' + '\x00';
        const ALIGN_CENTER = ESC + 'a' + '\x01';
        const ALIGN_LEFT = ESC + 'a' + '\x00';
        const ALIGN_RIGHT = ESC + 'a' + '\x02';
        const CUT = ESC + 'i';

        // ========================
        // DEBUG: Log data untuk troubleshooting
        // ========================
        console.log('üîç DEBUG Receipt Data:', transactionData);
        console.log('üîç DEBUG Items:', transactionData.items);

        // ========================
        // HEADER
        // ========================
        lines.push(ALIGN_CENTER + BOLD_ON);
        lines.push('================================' + LF);
        lines.push(this.template.shopName + LF);
        lines.push(`Outlet: ${this.template.shopOutlet}` + LF);
        lines.push(this.template.shopAddress + LF);
        lines.push('================================' + LF);
        lines.push(BOLD_OFF);
        
        // Copy Receipt notice for reprints
        if (transactionData.isReprint) {
            lines.push(ALIGN_CENTER + '*** COPY RECEIPT ***' + LF);
            lines.push('================================' + LF);
        }
        
        // ========================
        // TRANSACTION INFO
        // ========================
        lines.push(ALIGN_LEFT);
        lines.push(`No Order : ${transactionData.orderNo || 'N/A'}` + LF);
        lines.push(`Tanggal  : ${transactionData.date || DateTimeUtils.getCurrentWIBDate()} ${transactionData.time || DateTimeUtils.getCurrentWIBTime()}` + LF);
        lines.push(`Kasir    : ${Auth.getCurrentUser()?.name || 'Kasir'}` + LF);
        lines.push('--------------------------------' + LF);
        
        // ========================
        // ITEMS - PERBAIKAN HANDLING
        // ========================
        lines.push('Item:' + LF);
        
        // Pastikan items ada dan array
        const items = transactionData.items || [];
        let calculatedSubtotal = 0;
        
        items.forEach(item => {
            const name = item.nama_produk?.length > 20 ? item.nama_produk.substring(0, 17) + '...' : item.nama_produk || 'Unknown Item';
            const quantity = Number(item.quantity) || 1;
            const price = Number(item.harga_jual) || 0;
            const total = Number(item.total) || (quantity * price);
            
            lines.push(name + LF);
            lines.push(`  ${quantity} x Rp ${this.formatCurrency(price)}` + LF);
            lines.push(`  Rp ${this.formatCurrency(total)}` + LF);
            
            calculatedSubtotal += total;
        });
        
        lines.push('--------------------------------' + LF);
        
        // ========================
        // TOTALS - PERBAIKAN PERHITUNGAN
        // ========================
        lines.push(ALIGN_RIGHT);
        
        // Gunakan calculatedSubtotal jika data asli tidak valid
        const subtotal = calculatedSubtotal > 0 ? calculatedSubtotal : 
                        (Number(transactionData.total) || 0) + 
                        (Number(transactionData.discountAmount) || 0) + 
                        (Number(transactionData.redeemAmount) || 0);
        
        const discountAmount = Number(transactionData.discountAmount) || 0;
        const redeemAmount = Number(transactionData.redeemAmount) || 0;
        const total = Number(transactionData.total) || (subtotal - discountAmount - redeemAmount);
        
        lines.push(`SUBTOTAL: Rp ${this.formatCurrency(subtotal)}` + LF);
        
        if (discountAmount > 0) {
            lines.push(`DISCOUNT: -Rp ${this.formatCurrency(discountAmount)}` + LF);
        }
        
        if (redeemAmount > 0) {
            lines.push(`REDEEM  : -Rp ${this.formatCurrency(redeemAmount)}` + LF);
        }
        
        lines.push(`TOTAL   : Rp ${this.formatCurrency(total)}` + LF);
        
        // ========================
        // PAYMENT INFO - PERBAIKAN HANDLING
        // ========================
        lines.push(ALIGN_LEFT + '--------------------------------' + LF);
        lines.push('Pembayaran:' + LF);

        const paymentType = transactionData.paymentType || 'cash';
        const cashReceived = Number(transactionData.cashReceived) || 0;
        const cashChange = Number(transactionData.cashChange) || 0;

        lines.push(`Metode: ${this.getPaymentTypeName(paymentType)}` + LF);
        
        if (paymentType === 'cash' && cashReceived > 0) {
            lines.push(`Tunai  : Rp ${this.formatCurrency(cashReceived)}` + LF);
            lines.push(`Kembali: Rp ${this.formatCurrency(cashChange)}` + LF);
        } else {
            lines.push(`Bayar  : Rp ${this.formatCurrency(total)}` + LF);
        }
        
        // ========================
        // SERVED BY & CUSTOMER
        // ========================
        if (this.template.includeServedBy && transactionData.servedBy) {
            lines.push('--------------------------------' + LF);
            lines.push(`Dilayani oleh: ${transactionData.servedBy}` + LF);
        }
        
        if (this.template.includeCustomer && transactionData.customerName) {
            lines.push(`Customer: ${transactionData.customerName}` + LF);
        }
        
        // ========================
        // POINTS INFO - PERBAIKAN KONDISI
        // ========================
        if (this.template.includePoints) {
            const pointSebelum = Number(transactionData.pointSebelum) || 0;
            const pointDidapat = Number(transactionData.pointDidapat) || 0;
            const redeemPoints = Number(transactionData.redeemPoints) || 0;
            const pointSaatIni = Number(transactionData.pointSaatIni) || 0;
            
            // Hanya tampilkan jika ada data points yang meaningful
            const hasPointsData = pointDidapat > 0 || redeemPoints > 0 || pointSaatIni > 0;
            const isValidCustomer = transactionData.customerName && 
                                  transactionData.customerName !== 'Umum' &&
                                  transactionData.customerName !== 'umum';
            
            if (hasPointsData && isValidCustomer) {
                lines.push('--------------------------------' + LF);
                lines.push('INFO POINTS:' + LF);
                lines.push(`Sebelum : ${pointSebelum}` + LF);
                
                if (pointDidapat > 0) {
                    lines.push(`Dapat   : +${pointDidapat}` + LF);
                }
                
                if (redeemPoints > 0) {
                    lines.push(`Redeem  : -${redeemPoints}` + LF);
                }
                
                lines.push(`Saat Ini: ${pointSaatIni}` + LF);
            }
        }
        
        // ========================
        // FOOTER
        // ========================
        lines.push(ALIGN_CENTER + '================================' + LF);
        lines.push(this.template.footerMessage + LF);
        lines.push('================================' + LF);
        
        // Paper cut
        lines.push('' + LF);
        lines.push(LF + CUT);
        
        return lines.join('');
    },

    // ========================
    // HELPER FUNCTIONS
    // ========================
    formatCurrency: function(amount) {
        // Fallback ke POSModule atau handle sendiri
        if (typeof POSModule !== 'undefined' && POSModule.formatCurrency) {
            return POSModule.formatCurrency(amount);
        }
        // Fallback implementation
        return Number(amount).toLocaleString('id-ID');
    },

    getPaymentTypeName: function(paymentType) {
        const paymentNames = {
            'cash': 'Cash',
            'qris_dinamis': 'QRIS Dinamis',
            'qris_static_dana': 'QRIS DANA',
            'qris_static_bsi': 'QRIS BSI',
            'transfer_bca': 'Transfer BCA',
            'transfer_bni': 'Transfer BNI',
            'transfer_bri': 'Transfer BRI',
            'transfer_mandiri': 'Transfer Mandiri'
        };
        return paymentNames[paymentType] || paymentType;
    },

    parseTextToTransactionData(text) {
        return {
            orderNo: 'TEMP-001',
            date: DateTimeUtils.getCurrentWIBDate(),
            time: DateTimeUtils.getCurrentWIBTime(),
            items: [{ nama_produk: 'Temp Item', harga_jual: 0, quantity: 1, total: 0 }],
            total: 0,
            paymentType: 'cash'
        };
    },

// ========================
// COPY RECEIPT FUNCTIONS
// ========================
printCopyReceipt: async function(transactionData) {
    try {
        console.log('üñ®Ô∏è Printing COPY receipt for:', transactionData.orderNo);
        
        // ‚≠ê‚≠ê PERBAIKAN: PASTIKAN DATA POINTS IKUT ‚≠ê‚≠ê
        const copyData = {
            ...transactionData,
            isReprint: true,
            reprintDate: DateTimeUtils.getCurrentWIBDate(),
            reprintTime: DateTimeUtils.getCurrentWIBTime(),
            // ‚≠ê‚≠ê TAMBAHKAN INI: FORCE INCLUDE POINTS DATA ‚≠ê‚≠ê
            pointSebelum: Number(transactionData.pointSebelum) || 0,
            pointDidapat: Number(transactionData.pointDidapat) || 0,
            redeemPoints: Number(transactionData.redeemPoints) || 0,
            pointSaatIni: Number(transactionData.pointSaatIni) || 0,
            pointsEarned: Number(transactionData.pointsEarned) || 0
        };

        console.log('‚≠ê COPY RECEIPT DATA WITH POINTS:');
        console.log('  - pointSebelum:', copyData.pointSebelum);
        console.log('  - pointDidapat:', copyData.pointDidapat);
        console.log('  - pointSaatIni:', copyData.pointSaatIni);
        console.log('  - customerName:', copyData.customerName);

        return await this.printReceipt(copyData);
        
    } catch (error) {
        console.error('‚ùå Error in printCopyReceipt:', error);
        return false;
    }
},

debugCopyReceipt: async function(transactionId) {
    try {
        console.log('üêõ DEBUG COPY RECEIPT START');
        
        const originalData = await this.getTransactionById(transactionId);
        console.log('Original Data:', originalData);
        
        const copyData = {
            ...originalData,
            isReprint: true,
            total: Number(originalData.total) || 0,
            discountAmount: Number(originalData.discountAmount) || 0,
            redeemAmount: Number(originalData.redeemAmount) || 0,
            cashReceived: Number(originalData.cashReceived) || 0,
            cashChange: Number(originalData.cashChange) || 0,
            pointSebelum: Number(originalData.pointSebelum) || 0,
            pointDidapat: Number(originalData.pointDidapat) || 0,
            redeemPoints: Number(originalData.redeemPoints) || 0,
            pointSaatIni: Number(originalData.pointSaatIni) || 0,
            items: (originalData.items || []).map(item => ({
                ...item,
                harga_jual: Number(item.harga_jual) || 0,
                quantity: Number(item.quantity) || 1,
                total: Number(item.total) || 0
            }))
        };
        
        console.log('Fixed Copy Data:', copyData);
        console.log('üêõ DEBUG COPY RECEIPT END');
        
        return await this.printReceipt(copyData);
        
    } catch (error) {
        console.error('‚ùå Debug copy receipt error:', error);
        return false;
    }
},

getTransactionById: async function(transactionId) {
    try {
        console.log('üîé Getting transaction from Supabase:', transactionId);
        
        // 1. Ambil data order dari transaksi_order
        const { data: orderData, error: orderError } = await supabase
            .from('transaksi_order')
            .select('*')
            .eq('order_no', transactionId)
            .single();

        if (orderError) {
            console.error('‚ùå Error fetching order:', orderError);
            return null;
        }

        console.log('üì¶ Order data from Supabase:', orderData);

        // 2. Ambil items dari transaksi_detail
        const { data: detailData, error: detailError } = await supabase
            .from('transaksi_detail')
            .select('*')
            .eq('order_no', transactionId);

        if (detailError) {
            console.error('‚ùå Error fetching details:', detailError);
        }

        // 3. ‚≠ê‚≠ê AMBIL DATA POINTS DARI MEMBERCARD ‚≠ê‚≠ê
        let pointsData = {
            pointSebelum: 0,
            pointDidapat: 0,
            pointSaatIni: 0,
            redeemPoints: 0,
            pointsEarned: 0
        };

        // ‚≠ê‚≠ê HANYA UNTUK BUKAN "UMUM" ‚≠ê‚≠ê
        if (orderData.customer_name && orderData.customer_name !== 'Umum') {
            const { data: memberData, error: memberError } = await supabase
                .from('membercard')
                .select('point, point_sebelum, point_saat_ini, redeem')
                .eq('nama', orderData.customer_name)
                .single();

            if (!memberError && memberData) {
                console.log('üí∞ REAL MEMBER POINTS:', memberData);
                
                // ‚≠ê‚≠ê GUNAKAN DATA REAL DARI MEMBERCARD ‚≠ê‚≠ê
                pointsData = {
                    pointSebelum: Number(memberData.point_sebelum) || 0,
                    pointDidapat: Number(memberData.point) || 0,
                    pointSaatIni: Number(memberData.point_saat_ini) || 0,
                    redeemPoints: Number(memberData.redeem) || 0,
                    pointsEarned: Number(memberData.point) || 0
                };
                
                console.log('üéØ POINTS CALCULATION:');
                console.log('  - Sebelum:', pointsData.pointSebelum, '‚Üí Dapat:', pointsData.pointDidapat, '‚Üí Sekarang:', pointsData.pointSaatIni);
            } else {
                console.log('‚ÑπÔ∏è Customer bukan member atau data tidak ditemukan');
            }
        } else {
            console.log('‚ÑπÔ∏è Customer "Umum" - tidak ada points');
        }

        // 4. Format data untuk receipt
        const transactionData = {
            orderNo: orderData.order_no,
            date: orderData.order_date,
            time: orderData.order_time,
            customerName: orderData.customer_name,
            servedBy: orderData.serve_by,
            paymentType: orderData.payment_type,
            total: Number(orderData.total_amount) || Number(orderData.total) || 0,
            cashReceived: Number(orderData.cash_received) || 0,
            cashChange: Number(orderData.cash_change) || 0,
            discountAmount: Number(orderData.discount_amount) || 0,
            redeemAmount: Number(orderData.redeem_amount) || 0,
            // ‚≠ê‚≠ê GUNAKAN DATA POINTS REAL DARI MEMBERCARD ‚≠ê‚≠ê
            ...pointsData,
            // Items
            items: (detailData || []).map(item => ({
                nama_produk: item.product_name,
                harga_jual: Number(item.price) || 0,
                quantity: Number(item.quantity) || 1,
                total: Number(item.subtotal) || 0
            }))
        };

        console.log('üéØ FINAL TRANSACTION DATA:');
        console.log('  - customerName:', transactionData.customerName);
        console.log('  - pointSebelum:', transactionData.pointSebelum);
        console.log('  - pointDidapat:', transactionData.pointDidapat);
        console.log('  - pointSaatIni:', transactionData.pointSaatIni);
        console.log('  - total:', transactionData.total);

        return transactionData;
        
    } catch (error) {
        console.error('‚ùå Error in getTransactionById:', error);
        return null;
    }
},
// ‚≠ê‚≠ê FUNCTION BARU UNTUK TEST DENGAN DATA REAL ‚≠ê‚≠ê
testCopyReceiptWithRealData: async function(transactionId) {
    try {
        console.log('üß™ TEST COPY RECEIPT WITH REAL DATA');
        
        const transactionData = await this.getTransactionById(transactionId);
        if (!transactionData) {
            console.log('‚ùå Transaction not found:', transactionId);
            showNotification('Transaction tidak ditemukan', 'error');
            return;
        }

        console.log('üìä REAL TRANSACTION DATA:', {
            orderNo: transactionData.orderNo,
            customerName: transactionData.customerName,
            pointSebelum: transactionData.pointSebelum,
            pointDidapat: transactionData.pointDidapat,
            pointSaatIni: transactionData.pointSaatIni,
            hasPoints: transactionData.pointDidapat > 0
        });

        // Test print copy receipt
        const success = await this.printCopyReceipt(transactionData);
        
        if (success) {
            showNotification('‚úÖ Test copy receipt dengan data real berhasil!', 'success');
        } else {
            showNotification('‚ùå Test copy receipt dengan data real gagal', 'error');
        }
        
    } catch (error) {
        console.error('‚ùå Test error:', error);
        showNotification('Error test: ' + error.message, 'error');
    }
}
};
        // =============================================
        // NOTIFICATION SYSTEM
        // =============================================
        const NotificationSystem = {
            show(message, type = 'info', duration = 5000) {
                // Remove existing notifications
                this.removeExisting();

                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-transform duration-300 ${
                    type === 'success' ? 'bg-green-500 text-white' :
                    type === 'error' ? 'bg-red-500 text-white' :
                    type === 'warning' ? 'bg-yellow-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
                
                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm md:text-base">${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            √ó
                        </button>
                    </div>
                `;

                // Add to document
                document.body.appendChild(notification);

                // Auto remove after duration
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
            },

            removeExisting() {
                const existing = document.querySelectorAll('[class*="fixed top-4 right-4"]');
                existing.forEach(notif => notif.remove());
            }
        };

        // =============================================
        // REPORTS MODULE - LAPORAN BARU
        // =============================================
        const ReportsModule = {
            async generateReport() {
                try {
                    showLoading(true);
                    
                    const reportType = document.getElementById('reportType').value;
                    const startDate = document.getElementById('reportStartDate').value;
                    const endDate = document.getElementById('reportEndDate').value;
                    
                    if (!startDate || !endDate) {
                        showNotification('Pilih tanggal mulai dan tanggal akhir', 'error');
                        return;
                    }
                    
                    const user = Auth.getCurrentUser();
                    let reportData = [];
                    let reportTitle = '';
                    
                    switch (reportType) {
                        case 'payment':
                            reportData = await Database.getPaymentReport(user.outlet, startDate, endDate);
                            reportTitle = 'Laporan Pembayaran';
                            break;
                        case 'commission':
                            reportData = await Database.getCommissionReport(user.outlet, startDate, endDate);
                            reportTitle = 'Laporan Komisi';
                            break;
                        case 'membercard':
                            reportData = await Database.getMembercardReport(user.outlet, startDate, endDate);
                            reportTitle = 'Laporan Membercard';
                            break;
                        case 'attendance':
                            reportData = await Database.getAttendanceReport(user.outlet, startDate, endDate);
                            reportTitle = 'Laporan Absen';
                            break;
                    }
                    
                    this.renderReport(reportType, reportData, reportTitle, startDate, endDate);
                    
                } catch (error) {
                    console.error('Error generating report:', error);
                    showNotification('Error generating report: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            },
            
            renderReport(reportType, data, title, startDate, endDate) {
                const reportSummary = document.getElementById('reportSummary');
                const reportDetails = document.getElementById('reportDetails');
                
                if (data.length === 0) {
                    reportSummary.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Tidak ada data untuk periode ${startDate} hingga ${endDate}</p>
                        </div>
                    `;
                    reportDetails.classList.add('hidden');
                    return;
                }
                
                reportSummary.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h3 class="font-semibold text-blue-800">${title}</h3>
                        <p class="text-sm text-blue-600">Periode: ${startDate} hingga ${endDate}</p>
                        <p class="text-sm text-blue-600">Total Records: ${data.length}</p>
                    </div>
                `;
                
                reportDetails.classList.remove('hidden');
                
                let tableHeaders = '';
                let tableRows = '';
                
                switch (reportType) {
                  case 'payment':
    tableHeaders = `
        <tr>
            <th class="p-2 border text-left">Outlet</th>
            <th class="p-2 border text-left">Tanggal</th>
            <th class="p-2 border text-left">Hari</th>
            <th class="p-2 border text-left">Type Pembayaran</th>
            <th class="p-2 border text-right">Total Amount Cancel</th>
            <th class="p-2 border text-right">Total Amount</th>
        </tr>
    `;
    
    tableRows = data.map(item => `
        <tr>
            <td class="p-2 border">${item.outlet}</td>
            <td class="p-2 border">${item.tanggal}</td>
            <td class="p-2 border">${item.hari}</td>
            <td class="p-2 border">${item.payment_type}</td>
            <td class="p-2 border text-right">Rp ${POSModule.formatCurrency(item.total_amount_cancel)}</td>
            <td class="p-2 border text-right">Rp ${POSModule.formatCurrency(item.total_amount)}</td>
        </tr>
    `).join('');
    break;

case 'commission':
    tableHeaders = `
        <tr>
            <th class="p-2 border text-left">Outlet</th>
            <th class="p-2 border text-left">Tanggal</th>
            <th class="p-2 border text-left">Hari</th>
            <th class="p-2 border text-left">Served By</th>
            <th class="p-2 border text-right">Total Amount</th>
            <th class="p-2 border text-right">Total Komisi</th>
        </tr>
    `;
    
    tableRows = data.map(item => `
        <tr>
            <td class="p-2 border">${item.outlet}</td>
            <td class="p-2 border">${item.tanggal}</td>
            <td class="p-2 border">${item.hari}</td>
            <td class="p-2 border">${item.served_by}</td>
            <td class="p-2 border text-right">Rp ${POSModule.formatCurrency(item.total_amount)}</td>
            <td class="p-2 border text-right">Rp ${POSModule.formatCurrency(item.total_komisi)}</td>
        </tr>
    `).join('');
    break;

case 'membercard':
    tableHeaders = `
        <tr>
            <th class="p-2 border text-left">Outlet</th>
            <th class="p-2 border text-left">Tanggal</th>
            <th class="p-2 border text-left">Hari</th>
            <th class="p-2 border text-left">Kasir</th>
            <th class="p-2 border text-right">Jumlah Membercard</th>
        </tr>
    `;
    
    tableRows = data.map(item => `
        <tr>
            <td class="p-2 border">${item.outlet}</td>
            <td class="p-2 border">${item.tanggal}</td>
            <td class="p-2 border">${item.hari}</td>
            <td class="p-2 border">${item.kasir}</td>
            <td class="p-2 border text-right">${item.jumlah_membercard}</td>
        </tr>
    `).join('');
    break;
                        
                   case 'attendance':
    tableHeaders = `
        <tr>
            <th class="p-2 border text-left">Outlet</th>
            <th class="p-2 border text-left">Tanggal</th>
            <th class="p-2 border text-left">Hari</th>
            <th class="p-2 border text-left">Karyawan</th>
            <th class="p-2 border text-left">Clock In</th>
            <th class="p-2 border text-left">Clock Out</th>
            <th class="p-2 border text-left">Status</th>
        </tr>
    `;
    
    tableRows = data.map(item => `
        <tr>
            <td class="p-2 border">${item.outlet}</td>
            <td class="p-2 border">${item.tanggal}</td>
            <td class="p-2 border">${item.hari}</td>
            <td class="p-2 border">${item.karyawan}</td>
            <td class="p-2 border">${item.clock_in}</td>
            <td class="p-2 border">${item.clock_out}</td>
            <td class="p-2 border">
                <span class="px-2 py-1 rounded-full text-xs ${
                    item.status === 'Sesuai Jadwal' ? 'bg-green-100 text-green-800' :
                    item.status === 'Terlambat' ? 'bg-yellow-100 text-yellow-800' :
                    item.status === 'Pulang Lebih Awal' ? 'bg-orange-100 text-orange-800' :
                    item.status === 'Belum Clock Out' ? 'bg-blue-100 text-blue-800' :
                    item.status === 'Karyawan Tidak Ditemukan' ? 'bg-red-100 text-red-800' :
                    item.status === 'Jadwal Tidak Lengkap' ? 'bg-purple-100 text-purple-800' :
                    'bg-gray-100 text-gray-800'
                }">
                    ${item.status}
                </span>
            </td>
        </tr>
    `).join('');
    break;
                }
                
                reportDetails.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead class="bg-gray-100">
                                ${tableHeaders}
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        };
// =============================================
// EXIT CONFIRMATION HANDLER - FORCE INTERACTION VERSION
// =============================================
const ExitConfirmationHandler = {
    isInitialized: false,
    backButtonPressed: false,
    userInteracted: false,
    
    init() {
        if (this.isInitialized) return;
        
        console.log('üîô Initializing exit handler with force interaction');
        
        // ‚≠ê CRITICAL FIX: Force early interaction simulation
        this.forceEarlyInteraction();
        
        // Setup history state
        this.setupHistoryState();
        
        // Handle back button
        window.addEventListener('popstate', (event) => {
            console.log('üéØ Popstate triggered');
            this.handleBackButton();
        });
        
        // Track real user interactions
        this.setupUserInteractionTracking();
        
        this.isInitialized = true;
    },
    
    forceEarlyInteraction() {
    // ‚≠ê EXTREME: Multiple methods dengan delay berbeda
    const methods = [
        () => { const i = document.createElement('input'); i.style.cssText = 'position:absolute;opacity:0;pointer-events:none;'; document.body.appendChild(i); i.focus(); setTimeout(() => { i.blur(); document.body.removeChild(i); }, 50); },
        () => document.body.dispatchEvent(new MouseEvent('mousedown', { bubbles: true })),
        () => document.body.dispatchEvent(new MouseEvent('mouseup', { bubbles: true })),
        () => document.body.dispatchEvent(new TouchEvent('touchstart', { bubbles: true, touches: [new Touch({ identifier: 1, target: document.body })] })),
        () => document.body.click(),
        () => window.dispatchEvent(new Event('scroll')),
        () => { if(document.activeElement) document.activeElement.blur(); }
    ];
    
    methods.forEach((method, index) => {
        setTimeout(() => {
            try { method(); } catch(e) { console.log('Method failed:', e); }
        }, index * 100);
    });
    
    setTimeout(() => {
        this.userInteracted = true;
        console.log('üéØ All force interaction methods executed');
    }, 800);
},
    setupUserInteractionTracking() {
        const events = ['click', 'touchstart', 'keydown', 'mousedown', 'scroll'];
        
        events.forEach(eventType => {
            document.addEventListener(eventType, () => {
                if (!this.userInteracted) {
                    this.userInteracted = true;
                    console.log('üñêÔ∏è Real user interaction detected');
                }
            }, { passive: true });
        });
    },
    
    setupHistoryState() {
        // Replace current state
        window.history.replaceState({ 
            preventExit: true, 
            page: 'pos-app-initial',
            timestamp: Date.now(),
            forcedInteraction: true
        }, '');
        
        // Push new state
        window.history.pushState({ 
            preventExit: true, 
            page: 'pos-app-main', 
            timestamp: Date.now(),
            forcedInteraction: true
        }, '');
        
        console.log('üìö History state setup with forced interaction');
    },
    
    handleBackButton() {
        if (this.backButtonPressed) return;
        
        this.backButtonPressed = true;
        console.log('üîô Back button intercepted - User interacted:', this.userInteracted);
        
        this.showExitConfirmation();
        
        // Push new state to prevent exit
        window.history.pushState({ 
            preventExit: true, 
            page: 'pos-app-prevent',
            timestamp: Date.now()
        }, '');
        
        setTimeout(() => {
            this.backButtonPressed = false;
        }, 1000);
    },
    
    showExitConfirmation() {
        const hasActiveOrder = POSModule && POSModule.currentOrder && 
                              POSModule.currentOrder.items.length > 0;
        
        if (hasActiveOrder) {
            this.showExitConfirmationModal();
        } else {
            this.showSimpleExitToast();
        }
    },
    
    showExitConfirmationModal() {
        const itemCount = POSModule.currentOrder.items.length;
        const totalAmount = POSModule.formatCurrency(POSModule.currentOrder.total);
        
        const modalHTML = `
            <div id="exitConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 exit-confirm-modal" style="z-index: 10000;">
                <div class="bg-white p-6 rounded-lg max-w-sm w-full mx-4 exit-modal-content">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                    
                    <h3 class="text-xl font-bold text-center mb-3 text-gray-800">
                        Order Belum Selesai!
                    </h3>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                        <div class="text-center">
                            <p class="text-red-700 font-semibold">${itemCount} Item dalam Order</p>
                            <p class="text-red-600 text-sm">Total: Rp ${totalAmount}</p>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 text-center mb-2 text-sm">
                        Semua item akan hilang jika Anda keluar sekarang.
                    </p>
                    
                    <div class="flex space-x-3 mt-6">
                        <button onclick="ExitConfirmationHandler.stayInApp()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold transition duration-200 touch-target">
                            Lanjutkan
                        </button>
                        <button onclick="ExitConfirmationHandler.exitApp()" 
                                class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold transition duration-200 touch-target">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        this.removeExitUI();
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    showSimpleExitToast() {
        const toastHTML = `
            <div id="exitToast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg exit-toast flex items-center space-x-3" style="z-index: 10000;">
                <span class="text-sm">Keluar dari aplikasi?</span>
                <button onclick="ExitConfirmationHandler.exitApp()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm touch-target">
                    Keluar
                </button>
                <button onclick="ExitConfirmationHandler.stayInApp()" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-sm touch-target">
                    Batal
                </button>
            </div>
        `;
        
        this.removeExitUI();
        document.body.insertAdjacentHTML('beforeend', toastHTML);
        
        setTimeout(() => {
            document.getElementById('exitToast')?.remove();
        }, 5000);
    },
    
    stayInApp() {
        console.log('‚úÖ User chose to stay in app');
        this.removeExitUI();
        
        window.history.pushState({ 
            preventExit: true, 
            page: 'pos-app-stay',
            timestamp: Date.now()
        }, '');
    },
    
    exitApp() {
        console.log('üö™ User chose to exit app');
        this.removeExitUI();
        
        if (POSModule.currentOrder.items.length > 0) {
            POSModule.clearOrder();
        }
        
        setTimeout(() => {
            window.location.href = 'about:blank';
        }, 300);
    },
    
    removeExitUI() {
        document.getElementById('exitConfirmModal')?.remove();
        document.getElementById('exitToast')?.remove();
    },
    
    showManualExitConfirm() {
        this.showExitConfirmation();
    }
};

// =============================================
// MAIN APPLICATION - DENGAN HYBRID ORDER NUMBER
// =============================================
class BabehBarbershopPOS {
    constructor() {
        this.currentUser = null;
        this.currentOutlet = null;
        this.isInitialized = false;
    }

    async init() {
        try {
            // ‚≠ê CEK JIKA SUDAH DIINITIALIZE
            if (this.isInitialized) {
                console.log('üîÑ App already initialized');
                return;
            }
            
            console.log('üîÑ initializeApp called');
            
            // Check authentication - GUNAKAN localStorage
            this.currentUser = Auth.getCurrentUser();
            console.log('üìù localStorage currentUser:', this.currentUser);
            
            if (!this.currentUser) {
                console.log('‚ùå No user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            console.log('‚úÖ User authenticated:', this.currentUser.name);

            // ‚≠ê TUNGGU SUPABASE DAN ENVIRONMENT SIAP
            if (!supabase) {
                console.log('‚è≥ Waiting for Supabase initialization...');
                setTimeout(() => this.init(), 100);
                return;
            }

            // Load outlet information
            await SettingsModule.loadOutletInfo();
            
            // ‚≠ê INITIALIZE HYBRID ORDER NUMBER GENERATOR
            await OrderNumberGenerator.initialize(this.currentUser.outlet);                    

            // Initialize modules
            await POSModule.init();
            await PrinterModule.init();

            // ‚≠ê INITIALIZE TOUCH OPTIMIZATION
            TouchOptimizer.init();

            // ‚≠ê INITIALIZE EXIT CONFIRMATION HANDLER
            ExitConfirmationHandler.init();
            
            // PERBAIKAN 3: Update user info in navbar dengan layout yang benar
            document.getElementById('currentUser').textContent = this.currentUser.name;
            document.getElementById('userRole').textContent = this.currentUser.role;
            
            // Start background tasks
            this.startBackgroundTasks();
            
            // Auto connect printer
            this.autoConnectPrinter();
            
            // ‚≠ê TANDAI SUDAH DIINITIALIZE
            this.isInitialized = true;
            console.log('üéâ Application fully initialized with environment variables');
            
        } catch (error) {
            console.error('Error initializing app:', error);
            showNotification('Error initializing application: ' + error.message, 'error');
        }
    }

            startBackgroundTasks() {
                // Update datetime every second
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);

                // Sync data every 5 minutes
               // setInterval(() => this.syncData(), 300000);
            }

            updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Jakarta'
                };
                
                const dateTimeStr = now.toLocaleDateString('id-ID', options);
                document.getElementById('currentDateTime').textContent = dateTimeStr;
            }

            async syncData() {
                try {
                    // Sync products and customers
                    await POSModule.loadProducts();
                    await POSModule.loadCustomers();
                } catch (error) {
                    console.error('Error syncing data:', error);
                }
            }

          async autoConnectPrinter() {
    try {
        const savedPrinterType = localStorage.getItem('printerType') || 'bridge';
        const wasWebSerialConnected = localStorage.getItem('webSerial_connected') === 'true';
        
        console.log('üîå Printer auto-connect:', { 
            type: savedPrinterType, 
            wasConnected: wasWebSerialConnected 
        });
        
        if (savedPrinterType === 'webserial' && wasWebSerialConnected) {
            console.log('üîÑ Attempting Web Serial auto-reconnect...');
            
            // Set UI ke Web Serial mode
          PrinterModule.selectPrinterType('webserial');
            
            // Set baud rate dari saved value
            const savedBaudRate = localStorage.getItem('webSerial_baudRate') || '9600';
            if (document.getElementById('baudRate')) {
                document.getElementById('baudRate').value = savedBaudRate;
            }
            
            // Coba reconnect - tapi HANYA jika user sudah pernah pilih port
            // Web Serial tidak bisa auto-connect tanpa user permission
            console.log('‚ÑπÔ∏è Web Serial requires manual reconnection after page reload');
            await PrinterModule.checkWebSerialStatus();
            
        } else if (savedPrinterType === 'bridge') {
            console.log('üîó Checking bridge printer status...');
            PrinterModule.selectPrinterType('bridge');
            await PrinterModule.checkStatus();
        }
        
    } catch (error) {
        console.log('‚ùå Printer auto-connect failed:', error.message);
    }
}
            // Refresh function yang komprehensif - DIPERBAIKI
            async refresh() {
    showLoading(true);
    try {
        console.log('üîÑ Refreshing application (parallel)...');
        
        // ‚úÖ TAMBAH: Clear cache dulu
        CacheSystem.clear();
        
        await Promise.all([
            POSModule.loadProducts(),
            POSModule.loadCategories(), 
            POSModule.loadCustomers(),
            POSModule.loadServers(),
            SettingsModule.loadOutletInfo(),
            TransactionsModule.loadTransactions()
        ]);
        
        console.log('‚úÖ All data refreshed in parallel');
        
        // ‚úÖ PERTAHANKAN: Clear current order confirmation
        if (POSModule.currentOrder.items.length > 0) {
            if (confirm('Refresh aplikasi? Order yang sedang berjalan akan direset.')) {
                POSModule.clearOrder();
            }
        }
        
        showNotification('Aplikasi berhasil di-refresh', 'success');
        
    } catch (error) {
        console.error('Error refreshing app:', error);
        showNotification('Error refreshing app: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}
}
        // =============================================
        // GLOBAL FUNCTIONS
        // =============================================
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('active-tab');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab
            document.getElementById(`tab-${tabName}`).classList.add('active-tab');

            // Initialize tab-specific content
            switch(tabName) {
                case 'transactions':
                    TransactionsModule.loadTransactions();
                    break;
                case 'settings':
                    SettingsModule.loadSettings();
                    break;
                case 'printer':
                    // Already initialized in main app
                    break;
                case 'reports':
                    // Reset report filters
                    document.getElementById('reportStartDate').value = '';
                    document.getElementById('reportEndDate').value = '';
                    document.getElementById('reportSummary').innerHTML = 'Pilih tanggal dan generate laporan';
                    document.getElementById('reportDetails').classList.add('hidden');
                    break;
            }
        }
        
 // Function untuk load user photo - DENGAN LOOKUP KE TABEL KARYAWAN
async function loadUserPhoto() {
    console.log('üîÑ Loading user photo...');
    
    try {
        // Cek localStorage untuk user data
        const userData = localStorage.getItem('currentUser');
        console.log('üì¶ User data from localStorage:', userData);
        
        if (!userData) {
            console.log('‚ùå No user data in localStorage');
            document.getElementById('currentUser').textContent = 'Not logged in';
            document.getElementById('userRole').textContent = 'Please login';
            return;
        }

        const user = JSON.parse(userData);
        console.log('üë§ Parsed user data:', user);

        // Gunakan property yang sesuai dengan data
        const userName = user.name || user.nama_karyawan || user.email || 'User';
        const userRole = user.posisi || user.role || 'User';
        
        // Update user info di navigation
        document.getElementById('currentUser').textContent = userName;
        document.getElementById('userRole').textContent = userRole;

        // Handle photo - LOOKUP DARI TABEL KARYAWAN
        const userPhoto = document.getElementById('userPhoto');
        const userInitial = document.getElementById('userInitial');
        
        // Lookup photo_url dari tabel karyawan berdasarkan nama_karyawan
        const photoUrl = await lookupPhotoFromKaryawan(userName);
        
        if (photoUrl) {
            console.log('üì∏ Loading photo from:', photoUrl);
            userPhoto.src = photoUrl;
            userPhoto.classList.remove('hidden');
            userInitial.classList.add('hidden');
            
            userPhoto.onerror = function() {
                console.log('‚ùå Photo failed to load, showing initial');
                userPhoto.classList.add('hidden');
                userInitial.classList.remove('hidden');
                userInitial.textContent = userName.charAt(0).toUpperCase();
            };
        } else {
            console.log('üìù No photo URL found in karyawan table, showing initial');
            userPhoto.classList.add('hidden');
            userInitial.classList.remove('hidden');
            userInitial.textContent = userName.charAt(0).toUpperCase();
        }
        
        console.log('‚úÖ User info loaded successfully');
        
    } catch (error) {
        console.error('‚ùå Error in loadUserPhoto:', error);
        document.getElementById('currentUser').textContent = 'Error loading user';
        document.getElementById('userRole').textContent = 'Check console';
    }
}
// Update size container
    const container = document.querySelector('#userPhotoContainer > div');
    if (container) {
        container.style.width = '3rem';    // 64px
        container.style.height = '3rem';   // 64px
    }
// Function untuk lookup photo_url dari tabel karyawan
async function lookupPhotoFromKaryawan(namaKaryawan) {
    try {
        if (!namaKaryawan) {
            console.log('‚ùå No namaKaryawan provided for lookup');
            return null;
        }
        
        console.log('üîç Looking up photo for karyawan:', namaKaryawan);
        
        // Query ke tabel karyawan berdasarkan nama_karyawan
        const { data, error } = await supabase
            .from('karyawan')
            .select('photo_url')
            .eq('nama_karyawan', namaKaryawan)
            .single();

        if (error) {
            console.log('‚ùå Error looking up karyawan:', error);
            return null;
        }

        if (data && data.photo_url) {
            console.log('‚úÖ Found photo_url:', data.photo_url);
            return data.photo_url;
        } else {
            console.log('‚ùå No photo_url found for karyawan:', namaKaryawan);
            return null;
        }
        
    } catch (error) {
        console.error('‚ùå Error in lookupPhotoFromKaryawan:', error);
        return null;
    }
}

// Function logout
function logout() {
    localStorage.removeItem('currentUser');
    window.location.href = 'login.html';
}

// Function refresh app
function refreshApp() {
    location.reload();
}


        // Ganti saja function logout() dengan ini:
async function logout() {
    await supabase.auth.signOut();
    localStorage.clear();
    window.location.href = 'login.html';
}

        // PERBAIKAN 4: Fungsi refresh app yang komprehensif - DIPERBAIKI
        function refreshApp() {
            if (window.app) {
                window.app.refresh();
            } else {
                showNotification('Aplikasi belum siap, refresh manual...', 'warning');
                window.location.reload();
            }
        }

        function showLoading(show = true) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        function hideLoading() {
            showLoading(false);
        }

        function showNotification(message, type = 'info') {
            NotificationSystem.show(message, type);
        }

        function processPayment(paymentType) {
            if (!paymentType) {
                showNotification('Jenis pembayaran tidak valid', 'error');
                return;
            }
            
            if (!POSModule.validateOrder()) {
                return;
            }
            
            console.log('üîÑ Processing payment:', paymentType);
            PaymentModule.processPayment(paymentType);
        }

        function clearOrder() {
            POSModule.clearOrder();
        }

        function loadTransactions() {
            TransactionsModule.loadTransactions();
        }

        function confirmPayment() {
            PaymentModule.confirmPayment();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            PaymentModule.currentPaymentType = null;
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
        }

        function generateReport() {
            ReportsModule.generateReport();
        }

        // =============================================
        // NEW MODAL FUNCTIONS
        // =============================================
        function showServedByModal() {
            document.getElementById('servedByModal').classList.remove('hidden');
        }

        function closeServedByModal() {
            document.getElementById('servedByModal').classList.add('hidden');
        }

        function saveServedBy() {
            const servedBySelect = document.getElementById('servedBySelect');
            const selectedValue = servedBySelect.value;
            const selectedText = servedBySelect.options[servedBySelect.selectedIndex].text;
            
            if (selectedValue) {
                POSModule.selectedServedBy = selectedValue;
                POSModule.currentOrder.servedBy = { id: selectedValue, name: selectedText };
                document.getElementById('servedByButtonText').textContent = selectedText;
                showNotification(`Served by: ${selectedText}`, 'success');
            } else {
                showNotification('Pilih pelayan terlebih dahulu', 'error');
                return;
            }
            closeServedByModal();
        }

        function showCustomerModal() {
            document.getElementById('customerModal').classList.remove('hidden');
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.add('hidden');
        }

        function selectCustomer(customerId) {
            const customer = POSModule.customers.find(c => c.id_member === customerId);
            if (customer) {
                POSModule.selectedCustomer = customerId;
                POSModule.currentOrder.customer = {
                    id: customerId,
                    name: customer.nama,
                    points: customer.point_saat_ini || 0,
                    nomorWA: customer.nomorWA || ''
                };
                document.getElementById('customerButtonText').textContent = customer.nama;
                showNotification(`Customer: ${customer.nama} (${customer.point_saat_ini || 0} points)`, 'success');
                closeCustomerModal();
            }
        }

        // PERBAIKAN: Fungsi untuk memilih customer Umum
        function selectCustomerUmum() {
            POSModule.selectedCustomer = '';
            POSModule.currentOrder.customer = null;
            document.getElementById('customerButtonText').textContent = 'Umum';
            showNotification('Customer: Umum (Tidak dapat points)', 'info');
            closeCustomerModal();
        }

        function showPaymentMethodModal() {
            if (!POSModule.validateOrder()) {
                return;
            }
            document.getElementById('paymentMethodModal').classList.remove('hidden');
        }

        function closePaymentMethodModal() {
            document.getElementById('paymentMethodModal').classList.add('hidden');
        }

        function selectPaymentMethod(method) {
            closePaymentMethodModal();
            
            switch(method) {
                case 'cash':
                    PaymentModule.processPayment('cash');
                    break;
                case 'qris_dinamis':
                    PaymentModule.processPayment('qris_dinamis');
                    break;
                case 'transfer_bank':
                    PaymentModule.processPayment('transfer_bank');
                    break;
                case 'qris_static':
                    showQRISStaticModal();
                    break;
            }
        }

        // =============================================
        // OTP FUNCTIONS
        // =============================================
        function showOTPModal(orderNo) {
            document.getElementById('otpOrderNo').textContent = `Order: ${orderNo}`;
            document.getElementById('otpInput').value = '';
            document.getElementById('otpInput').disabled = false;
            document.getElementById('otpModal').classList.remove('hidden');
            
            // Focus ke input OTP
            setTimeout(() => {
                document.getElementById('otpInput').focus();
            }, 100);
        }

        function closeOTPModal() {
            document.getElementById('otpModal').classList.add('hidden');
            OTPSystem.clearOTP(OTPSystem.currentOrderNo);
        }

        async function resendOTP() {
            try {
                showLoading(true);
                await OTPSystem.sendOTP(OTPSystem.currentOrderNo);
                showNotification('OTP berhasil dikirim ulang', 'success');
            } catch (error) {
                showNotification('Gagal mengirim OTP: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function verifyOTP() {
            const inputOTP = document.getElementById('otpInput').value;
            
            if (!inputOTP || inputOTP.length !== 4) {
                showNotification('Masukkan kode OTP 4 digit', 'error');
                return;
            }
            
            if (OTPSystem.verifyOTP(OTPSystem.currentOrderNo, inputOTP)) {
                closeOTPModal();
                // Proses cancel transaksi
                await TransactionsModule.processCancellation(OTPSystem.currentOrderNo);
            } else {
                showNotification('Kode OTP salah atau telah kadaluarsa', 'error');
            }
        }

        // =============================================
        // PRINTER FUNCTIONS FOR UI
        // =============================================
        function selectPrinterType(type) {
            PrinterModule.selectPrinterType(type);
        }

        function checkPrinterStatus() {
            PrinterModule.saveTemplate();
            PrinterModule.checkStatus();
        }

        function connectWebSerial() {
            PrinterModule.connectWebSerial();
        }

        function testPrinter() {
            PrinterModule.testPrint();
        }

        function saveTemplate() {
            PrinterModule.saveTemplate();
        }

        function previewReceipt() {
            PrinterModule.previewReceipt();
        }

        // =============================================
        // SETTINGS MODULE
        // =============================================
        const SettingsModule = {
            async loadSettings() {
                await this.loadOutletInfo();
                await this.loadUserInfo();
            },

       async loadOutletInfo() {
    try {
        console.log('üîç Starting loadOutletInfo...');
        
        const outletInfo = document.getElementById('outletInfo');
        const outletName = document.getElementById('outletName');
        
        if (!outletInfo) {
            console.error('‚ùå Element outletInfo tidak ditemukan');
            return;
        }

        if (!outletName) {
            console.error('‚ùå Element outletName tidak ditemukan');
        }
        
        const user = Auth.getCurrentUser();
        if (!user || !user.outlet) {
            console.error('‚ùå User atau outlet tidak ditemukan');
            outletInfo.innerHTML = '<p class="text-red-500">User information tidak valid</p>';
            if (outletName) outletName.textContent = 'Error';
            return;
        }
        
        console.log('üè™ Loading outlet untuk:', user.outlet);
        
        const outletResult = await Database.getCurrentOutlet(user.outlet);
        console.log('üìä Outlet result:', outletResult);
        
        const outlet = outletResult && outletResult.length > 0 ? outletResult[0] : null;
        console.log('üìã Outlet object:', outlet);
        
        if (!outlet) {
            console.error('‚ùå Outlet tidak ditemukan di database');
            outletInfo.innerHTML = '<p class="text-red-500">Outlet tidak ditemukan</p>'; // ‚≠ê PERBAIKAN DI SINI
            if (outletName) outletName.textContent = 'Outlet Not Found';
            return;
        }
        
        // UPDATE OUTLET NAME DI SIDEBAR
        if (outletName) {
            outletName.textContent = outlet.outlet || 'Babeh Barbershop';
            console.log('‚úÖ Outlet name updated in sidebar');
        }
        
        // UPDATE DETAILED INFO DI SETTINGS
        outletInfo.innerHTML = `
<div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 text-sm">
    <div>
        <label class="block text-sm font-medium text-gray-700">Nama Outlet</label>
        <p class="mt-1 text-sm text-gray-900">${outlet.outlet || '-'}</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700">Kode Outlet</label>
        <p class="mt-1 text-sm text-gray-900">${outlet.kode_outlet || '-'}</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700">Alamat</label>
        <p class="mt-1 text-sm text-gray-900">${outlet.alamat || '-'}</p>
    </div>
    <div>
        <label class="block text-sm font-medium text-gray-700">No. WA</label>
        <p class="mt-1 text-sm text-gray-900">${outlet.no_wa_outlet || '-'}</p>
    </div>
    <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700">Jam Operasional</label>
        <p class="mt-1 text-sm text-gray-900">${outlet.jam_buka || '-'} - ${outlet.jam_tutup || '-'}</p>
    </div>
</div>
        `;
        
        console.log('‚úÖ Outlet information berhasil dimuat di kedua tempat');
        
    } catch (error) {
        console.error('‚ùå Error loading outlet info:', error);
        const outletInfo = document.getElementById('outletInfo');
        const outletName = document.getElementById('outletName');
        
        if (outletInfo) {
            outletInfo.innerHTML = '<p class="text-red-500">Error: ' + error.message + '</p>';
        }
        if (outletName) {
            outletName.textContent = 'Error Loading';
        }
    }
},

            async loadUserInfo() {
                try {
                    const user = Auth.getCurrentUser();
                    const userInfo = document.getElementById('userInfo');
                    
                    userInfo.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-4 text-sm">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Nama Karyawan</label>
                                <p class="mt-1 text-sm text-gray-900">${user.name}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Username</label>
                                <p class="mt-1 text-sm text-gray-900">${user.username}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Outlet</label>
                                <p class="mt-1 text-sm text-gray-900">${user.outlet}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Role</label>
                                <p class="mt-1 text-sm text-gray-900">${user.role || '-'}</p>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading user info:', error);
                    document.getElementById('userInfo').innerHTML = '<p class="text-red-500">Error loading user info</p>';
                }
            }
        };

        // Initialize app when DOM is loaded AND Supabase is ready
async function initializeAppWhenReady() {
    console.log('üöÄ Initializing app...');
    
    // Tunggu sampai Supabase ready
    if (!window.supabase || typeof window.supabase.from !== 'function') {
        console.log('‚è≥ Waiting for Supabase...');
        setTimeout(initializeAppWhenReady, 100);
        return;
    }
    
    // Validasi environment
    if (!validateEnvironment()) {
        return;
    }
// =============================================
// INITIALIZATION - PANGGIL SETELAH DOM READY
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ POS App Initializing...');
    loadUserPhoto();
});

// Fallback initialization
if (document.readyState === 'interactive' || document.readyState === 'complete') {
    setTimeout(loadUserPhoto, 100);
}
    // Initialize aplikasi
    window.app = new BabehBarbershopPOS();
    window.app.init();
    
    // Add event listeners for redeem and discount
    document.getElementById('redeemPoints').addEventListener('input', calculateRedeemValue);
    document.getElementById('discountValue').addEventListener('input', calculateDiscountAmount);
    document.getElementById('discountType').addEventListener('change', toggleDiscountInput);
    
    console.log('‚úÖ App initialized successfully');
}

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', initializeAppWhenReady);

 </script>
<!-- Load QRIS Modules -->
<script src="scripts/modules/qris-dinamis-auto.js"></script>
</body>
</html>
