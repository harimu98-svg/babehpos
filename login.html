<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Babeh Barbershop POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .logo-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="max-w-md w-full space-y-8 p-10 bg-white rounded-2xl shadow-2xl">
        <div class="text-center">
            <!-- Logo -->
            <div class="flex justify-center mb-6">
                <div class="logo-container">
                    <img src="assets/logo.png" alt="Babeh Barbershop Logo" 
                         class="w-24 h-24 rounded-2xl object-cover border-4 border-white shadow-lg"
                         onerror="this.style.display='none'; document.getElementById('fallbackLogo').style.display='flex';">
                    <!-- Fallback Logo jika gambar tidak load -->
                    <div id="fallbackLogo" class="w-24 h-24 bg-blue-100 rounded-2xl flex items-center justify-center border-4 border-white shadow-lg hidden">
                        <span class="text-blue-800 text-xl font-bold">BB</span>
                    </div>
                </div>
            </div>
            
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Babeh Barbershop</h2>
            <p class="text-gray-600 text-lg">Sistem Point of Sale</p>
            <div class="mt-4 bg-blue-50 inline-flex items-center px-4 py-2 rounded-full">
                <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                <span class="text-blue-700 text-sm font-medium">Online</span>
            </div>
        </div>
        
        <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
            <div class="space-y-5">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            Email
                        </div>
                    </label>
                    <input 
                        id="email" 
                        name="email" 
                        type="email" 
                        required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 placeholder-gray-400"
                        placeholder="masukkan.email@babebarbershop.com"
                        autocomplete="username">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        <div class="flex items-center">
                            <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Password
                        </div>
                    </label>
                    <input 
                        id="password" 
                        name="password" 
                        type="password" 
                        required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 placeholder-gray-400"
                        placeholder="Masukkan password"
                        autocomplete="current-password">
                </div>
            </div>

            <div class="pt-4">
                <button 
                    type="submit" 
                    id="loginButton"
                    class="w-full flex justify-center items-center py-4 px-6 border border-transparent rounded-xl shadow-sm text-lg font-semibold text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                    <svg class="w-5 h-5 text-white mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                    </svg>
                    Masuk ke Sistem
                </button>
            </div>

            <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl relative"></div>
        </form>

        <!-- Footer -->
        <div class="text-center pt-6 border-t border-gray-200">
            <p class="text-sm text-gray-500">
                &copy; 2024 Babeh Barbershop. All rights reserved.
            </p>
            <p class="text-xs text-gray-400 mt-1">
                v2.0 - Supabase Auth System
            </p>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-700 font-medium">Memproses login...</p>
            <p class="text-sm text-gray-500 mt-2">Harap tunggu sebentar</p>
        </div>
    </div>

    <script>
        // ‚úÖ INISIALISASI SUPABASE DENGAN NETLIFY FUNCTION
        async function initializeSupabase() {
            console.log('üîß Initializing Supabase client...');
            
            try {
                // Panggil Netlify Function untuk mendapatkan konfigurasi
                const response = await fetch('/.netlify/functions/get-config');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch config: ${response.status}`);
                }
                
                const config = await response.json();
                
                // Validasi konfigurasi
                if (!config.supabaseUrl || !config.supabaseAnonKey) {
                    throw new Error('Supabase configuration is incomplete');
                }
                
                // Inisialisasi Supabase client
                const { createClient } = supabase;
                window.supabaseClient = createClient(
                    config.supabaseUrl,
                    config.supabaseAnonKey
                );
                
                console.log('‚úÖ Supabase client initialized successfully');
                
                // Simpan konfigurasi WhatsApp untuk digunakan nanti
                window.whatsappConfig = {
                    wahaUrl: config.wahaUrl,
                    wahaXApiKey: config.wahaXApiKey,
                    wahaSession: config.wahaSession
                };
                
                // Cek apakah user sudah login
                const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                if (error) {
                    console.log('No existing session:', error.message);
                } else if (session) {
                    // User sudah login, redirect ke dashboard
                    console.log('‚úÖ User already logged in, redirecting...');
                    await validateUserAndRedirect(session.user);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase:', error);
                showError('Terjadi kesalahan sistem. Silakan refresh halaman.');
            }
        }

        // ‚úÖ VALIDASI USER DAN REDIRECT (Untuk session existing)
        async function validateUserAndRedirect(authUser) {
            try {
                const authMetadata = authUser.user_metadata;
                
                // ‚úÖ VALIDASI METADATA ADA (tanpa query ke tabel karyawan)
                if (!authMetadata.nama_karyawan || !authMetadata.outlet) {
                    throw new Error('Metadata user tidak lengkap. Silakan login ulang.');
                }

                console.log('‚úÖ Validating user metadata:', authMetadata);

                // ‚úÖ SIMPAN DATA LANGSUNG DARI AUTH METADATA
                localStorage.setItem('currentUser', JSON.stringify({
                    id: authUser.id,
                    email: authUser.email,
                    name: authMetadata.nama_karyawan,
                    outlet: authMetadata.outlet,
                    role: authMetadata.role,
                    posisi: authMetadata.posisi,
                    status: authMetadata.status,
                    nomor_wa: authMetadata.nomor_wa
                }));

                // Simpan konfigurasi WhatsApp
                if (window.whatsappConfig) {
                    localStorage.setItem('whatsappConfig', JSON.stringify(window.whatsappConfig));
                }

                console.log('üéâ Session validation successful, redirecting...');
                window.location.href = 'index.html';

            } catch (error) {
                console.error('‚ùå Validation error:', error);
                showError('Sesi tidak valid. Silakan login kembali.');
                
                // Logout user jika validasi gagal
                await window.supabaseClient.auth.signOut();
                localStorage.clear();
            }
        }

        // ‚úÖ LOGIN FUNCTION YANG BARU (tanpa query ke tabel karyawan)
        async function handleLogin(event) {
            event.preventDefault();
            
            // Pastikan supabaseClient sudah terinisialisasi
            if (!window.supabaseClient) {
                showError('Sistem belum siap. Silakan tunggu sebentar.');
                return;
            }
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');

            // Validasi input
            if (!email.trim() || !password.trim()) {
                showError('Email dan password harus diisi');
                shakeElement('email');
                shakeElement('password');
                return;
            }

            // Validasi format email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Format email tidak valid');
                shakeElement('email');
                return;
            }

            // Tampilkan loading
            showLoading(true);
            loginButton.disabled = true;
            loginButton.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                Memproses...
            `;

            try {
                // ‚úÖ STEP 1: LOGIN DENGAN SUPABASE AUTH
                const { data: authData, error: authError } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (authError) {
                    throw authError;
                }

                console.log('‚úÖ Auth login successful:', authData.user);

                // ‚úÖ STEP 2: LANGSUNG PAKAI AUTH METADATA (tanpa query karyawan)
                const authMetadata = authData.user.user_metadata;
                
                // Validasi metadata lengkap
                if (!authMetadata.nama_karyawan || !authMetadata.outlet || !authMetadata.role) {
                    throw new Error('Data user tidak lengkap. Hubungi administrator.');
                }

                console.log('‚úÖ User metadata:', authMetadata);

                // ‚úÖ STEP 3: SIMPAN DATA USER LANGSUNG DARI AUTH METADATA
                localStorage.setItem('currentUser', JSON.stringify({
                    id: authData.user.id,
                    email: authData.user.email,
                    name: authMetadata.nama_karyawan,
                    outlet: authMetadata.outlet,
                    role: authMetadata.role,
                    posisi: authMetadata.posisi || 'Staff',
                    status: authMetadata.status || 'active',
                    nomor_wa: authMetadata.nomor_wa || ''
                }));

                // Simpan konfigurasi WhatsApp
                if (window.whatsappConfig) {
                    localStorage.setItem('whatsappConfig', JSON.stringify(window.whatsappConfig));
                }

                // ‚úÖ STEP 4: REDIRECT
                console.log('üéâ Login successful, redirecting...');
                showSuccess('Login berhasil! Mengalihkan...');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);

            } catch (error) {
                console.error('‚ùå Login error:', error);
                
                let errorMessage = 'Terjadi kesalahan saat login';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'Email atau password salah';
                    shakeElement('email');
                    shakeElement('password');
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'Email belum dikonfirmasi. Silakan cek email Anda.';
                } else if (error.message.includes('Data user tidak lengkap')) {
                    errorMessage = error.message;
                } else {
                    errorMessage = error.message;
                }
                
                showError(errorMessage);
            } finally {
                showLoading(false);
                loginButton.disabled = false;
                loginButton.innerHTML = `
                    <svg class="w-5 h-5 text-white mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                    </svg>
                    Masuk ke Sistem
                `;
            }
        }

        // Utility Functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.classList.remove('bg-green-50', 'border-green-200', 'text-green-700');
            errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-700');
        }

        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        function shakeElement(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('shake');
            setTimeout(() => {
                element.classList.remove('shake');
            }, 500);
        }

        // Event Listeners
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const form = document.querySelector('form');
                if (form) {
                    const submitButton = form.querySelector('button[type="submit"]');
                    if (submitButton) {
                        submitButton.click();
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('email').focus();
            initializeSupabase();
        });

        // Auto-hide error when user starts typing
        document.getElementById('email').addEventListener('input', hideError);
        document.getElementById('password').addEventListener('input', hideError);

        function hideError() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.add('hidden');
        }

        // Auth state listener
        if (window.supabaseClient) {
            window.supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event);
                if (event === 'SIGNED_OUT') {
                    localStorage.clear();
                }
            });
        }
    </script>
</body>
</html>
